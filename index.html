<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesson 10 — The Birth of Rock and Roll</title>
<style>
:root{--bg:#0e0f12;--ink:#e8ebf0;--muted:#b6bdc9;--card:#161821;--line:#262a35;--brand:#59d0ff;--accent:#ffd166}
html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 'Segoe UI',system-ui,Roboto,sans-serif}
a {color: var(--accent);}
body.modal-open{overflow:hidden}<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesson 9 — Doo-Wop and Rhythm and Blues</title>
<style>
  :root{--bg:#0e0f12;--ink:#e8ebf0;--muted:#b6bdc9;--card:#161821;--line:#262a35;--brand:#59d0ff;--accent:#ffd166}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 'Segoe UI',system-ui,Roboto,sans-serif}
  a {color: var(--accent);}
  body.modal-open{overflow:hidden}
  /* Hide main content until the app is ready */
  header.top, #main-content, #qna-fab {display: none;}
  .app{max-width:980px;margin:0 auto;padding:1rem}

  .slide{display:none;background:var(--card);border:1px solid var(--line);border-radius:.6rem;padding:1rem;margin:1rem 0}
  .slide:first-of-type{display:block}
  .slide-head{display:flex;align-items:baseline;justify-content:space-between;gap:.75rem;border-bottom:1px solid var(--line);padding-bottom:.4rem;margin-bottom:.6rem}
  .slide h2{margin:.2rem 0;font-size:1.4rem}
  .meter{color:var(--muted);font-size:.9rem}
  .slide-body-with-aside { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start;}
  .slide-body-main { flex: 3 1 400px; }
  .slide-body-aside { flex: 1 1 200px; }
  .slide-body-aside img { width: 100%; border-radius: .4rem; }
  .bullets{margin:.6rem 0 1rem 1.1rem}
  .bullets li{margin:.35rem 0}
  .slide-actions{display:flex; gap:.5rem; flex-wrap:wrap;}
  .read-btn,.nav-btn,.home-btn,.grade-btn{background:linear-gradient(90deg,var(--brand),#86e3ff);color:#08121f;border:0;font-weight:700;padding:.5rem .85rem;border-radius:.45rem;cursor:pointer}
  .read-btn{background:#233046;color:var(--ink);border:1px solid var(--line)}
  .full{margin:.75rem 0 .5rem 0;line-height:1.75;color:#d9e1ee}
  .keywords-list {list-style-type: none; padding-left: 0;}
  .keywords-list li { margin-bottom: .5rem; }

  .deep-list{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin:1rem 0;list-style:none;padding:0}
  .deep-item{width:100%;display:flex;justify-content:center}
  .profile-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:800;padding:.55rem 1rem;border-radius:.55rem;cursor:pointer;min-width:min(520px,90%);text-align:center}
  .profile-btn:hover{filter:brightness(.97)}
  .profile-btn:focus{outline:2px solid #ffd16666;outline-offset:2px}

  .slide-nav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-top:1rem;gap:.5rem}
  .home-btn{justify-self:center;background:#334055;color:var(--ink);border:1px solid var(--line)}

  .quiz-battle-container{display:flex;flex-wrap: wrap;gap:1.5rem;align-items:flex-start}
  .quiz-main{flex:1 1 60%; min-width: 300px;}
  .leaderboard{flex:1 1 35%; min-width: 280px; background:#131622;border-radius:.45rem;padding:1rem;border:1px solid var(--line)}
  .leaderboard-list li{display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--line);align-items:center}
  .leaderboard-list li:last-child{border-bottom:0}
  .leaderboard-list .player-name{font-size:.9em;color:var(--muted)}
  .leaderboard-list .correct-answers{font-size:.9em}
  .leaderboard-list .score{font-weight:700;color:var(--brand);font-size:1.1em}
  .quiz-question-area .q{padding:.6rem;border-bottom:1px dashed var(--line)}
  .quiz-question-area .q:last-child{border-bottom:0}
  .choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.35rem;margin-top:.35rem}
  .choice-btn{display:flex;gap:.5rem;align-items:center;padding:.35rem .5rem;border-radius:.35rem;background:#131622;border:1px solid var(--line);color:var(--ink);font-size:1rem;width:100%;text-align:left;cursor:pointer}
  .choice-btn.correct{border-color:rgba(6,214,160,.6);background:rgba(6,214,160,.08)}
  .choice-btn.incorrect{border-color:rgba(239,71,111,.6);background:rgba(239,71,111,.07)}
  .choice-btn:disabled{cursor:not-allowed;opacity:.7}
  .quiz-controls button{margin-top:1rem}
  #quiz-feedback{margin-top:1rem;font-weight:700}
  #quiz-timer{font-size:1.8rem;font-weight:700;color:var(--accent);text-align:center;margin-bottom:1rem;padding:.5rem;background-color:rgba(255,209,102,.1);border-radius:.45rem}

  #scrim{position:fixed;inset:0;display:none;background:rgba(0,0,0,.78);z-index:9998}
  #scrim.active{display:block}
  #modal{position:fixed;inset:0;display:none;place-items:center;z-index:9999;padding:1rem}
  #modal.active{display:grid}
  .modal-card{max-width:1100px;width:90%;background:#0f1420;border:1px solid var(--line);border-radius:.75rem;box-shadow:0 18px 60px rgba(0,0,0,.5);transform:scale(.97);opacity:0;transition:transform .2s ease,opacity .2s ease;max-height:85vh;display:flex;flex-direction:column}
  #modal.active .modal-card{transform:scale(1);opacity:1}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;border-bottom:1px solid var(--line)}
  .modal-head h3{margin:0;font-size:1.5rem}
  .modal-body{padding:1.2rem;line-height:1.85;font-size:18px;overflow-y:auto}
  .modal-body img{max-width:100%;height:auto;border-radius:.4rem;border:1px solid var(--line);margin:.6rem 0}
  .modal-body.split-layout{display:flex;gap:1.5rem;align-items:flex-start}
  .modal-body.split-layout > .modal-image-container{flex:0 0 300px;min-width:200px}
  .modal-body.split-layout img{margin:0;width:100%}
  .modal-body.split-layout > .modal-text-container{flex:1 1 auto}
  .modal-body h4{margin:1rem 0 .4rem;font-size:1rem;color:#ffe08a}
  .close{background:#2a3649;color:#e3eaf5;border:1px solid var(--line);padding:.4rem .8rem;border-radius:.45rem;cursor:pointer}

  .interactive-section{margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--line)}
  .interactive-section h3{color:var(--accent);margin-bottom:1rem}

  .poll-option{position:relative;margin-bottom:.5rem;background:#131622;border-radius:.35rem;border:1px solid var(--line);overflow:hidden}
  .poll-option button{width:100%;text-align:left;padding:.5rem .8rem .5rem 1rem;background:0 0;border:0;color:var(--ink);cursor:pointer;position:relative;z-index:2;box-sizing:border-box;padding-right:4rem;}
  .poll-option button:disabled{cursor:not-allowed}
  .poll-option.voted-for button{font-weight:700}
  .poll-option.correct-answer { background: rgba(6, 214, 160, .1) !important; border: 1px solid rgba(6, 214, 160, .7); }
  .poll-bar{position:absolute;top:0;left:0;height:100%;background:var(--brand);opacity:.2;transition:width .3s ease;z-index:1}
  .poll-percent{position:absolute;right:.8rem;top:50%;transform:translateY(-50%);font-size:.9em;font-weight:700;color:var(--ink);z-index:2}

  .build-a-band{display:flex;gap:1rem;flex-wrap:wrap}
  .instrument-pool,.band-area{flex:1;min-width:250px;padding:1rem;border:2px dashed var(--line);border-radius:.6rem}
  .band-area{background:rgba(89,208,255,.05)}
  .instrument{padding:.5rem .8rem;background:var(--card);border:1px solid var(--line);border-radius:.4rem;cursor:grab;margin-bottom:.5rem;user-select:none}
  .instrument.dragging { opacity: 0.5; }
  .band-area.drag-over{border-color:var(--brand)}
  .band-area .instrument.correct{border-left:4px solid #06d6a0}
  .band-area .instrument.incorrect{border-left:4px solid #ef476f}

  .word-cloud-container{display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start}
  .word-cloud-input{flex:1;min-width:250px}
  .word-cloud-display{flex:2;min-width:300px;min-height:200px;border:1px solid var(--line);border-radius:.6rem;padding:1rem;display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center;justify-content:center}
  .word-cloud-display span{padding:.1rem .3rem}
  .content-input-container{display:flex;gap:.5rem;margin-bottom:1rem}
  .content-input{flex-grow:1;background:#131622;border:1px solid var(--line);color:var(--ink);padding:.5rem .8rem;border-radius:.45rem;font-size:1rem}
  .add-content-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:700;padding:.5rem 1rem;border-radius:.45rem;cursor:pointer}
  
  #qna-fab{position:fixed;bottom:1rem;right:1rem;z-index:100}
  #qna-panel{position:fixed;top:0;right:0;width:min(450px, 100%);height:100%;background:var(--card);border-left:1px solid var(--line);z-index:10001;transform:translateX(100%);transition:transform .3s ease}
  #qna-panel.active{transform:translateX(0)}
  .qna-head{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
  .qna-body{padding:1rem;height:calc(100% - 120px);overflow-y:auto}
  .qna-footer{padding:1rem;border-top:1px solid var(--line)}
  .qna-list li{display:flex;gap:.8rem;align-items:flex-start;padding:.8rem 0;border-bottom:1px solid var(--line)}
  .qna-list li:last-child{border-bottom:0}
  .upvote-btn{display:flex;flex-direction:column;align-items:center;background:0 0;border:1px solid var(--line);color:var(--ink);border-radius:.4rem;padding:.3rem;cursor:pointer}
  .upvote-btn.voted{background:var(--brand);color:#08121f}
  .upvote-btn:disabled{cursor:not-allowed}

  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.85);z-index:10002;color:var(--ink)}
  .overlay.hidden{display:none}
  .overlay-card{background:var(--card);padding:2rem;border-radius:.75rem;width:min(400px, 90%);text-align:center}
  .overlay-card h3{margin-top:0;font-size:1.5rem;color:var(--accent)}
  .overlay-card input{width:100%;box-sizing:border-box;margin-bottom:1rem;text-align:center}
  .overlay-card button{width:100%;margin-bottom:.5rem}
  .overlay-card hr{border-color:var(--line);margin:1rem 0}

  /* --- Accessibility Additions --- */
  #accessibility-controls {
    position: fixed;
    top: .5rem;
    right: .5rem;
    z-index: 10003;
  }
  #contrast-toggle-btn {
    background: #233046;
    color: #e8ebf0;
    border: 1px solid #262a35;
    font-size: 1.2rem;
    padding: .4rem .7rem;
    border-radius: .45rem;
    cursor: pointer;
    line-height: 1;
  }
  .read-aloud-btn {
    background: #233046;
    color: #e8ebf0;
    border: 1px solid #262a35;
    padding: .3rem .6rem;
    border-radius: .45rem;
    cursor: pointer;
    font-size: .8em;
  }
  
  body.high-contrast-mode {
    --bg: #000000;
    --ink: #ffffff;
    --muted: #dddddd;
    --card: #000000;
    --line: #ffffff;
    --brand: #ffff00;
    --accent: #ffff00;
  }
  body.high-contrast-mode .profile-btn,
  body.high-contrast-mode .add-content-btn {
    background: var(--accent);
    color: #000;
    text-shadow: none;
  }
   body.high-contrast-mode a {
    color: var(--accent);
   }
   body.high-contrast-mode #contrast-toggle-btn {
    background-color: var(--bg);
    border-color: var(--line);
    color: var(--ink);
   }
</style>
</head>
<body>
  <div id="accessibility-controls">
    <button id="contrast-toggle-btn" title="Toggle High Contrast Mode">♿</button>
  </div>

  <header class="top" id="main-header">
    <div class="app brand">
      <h1>Lesson 9: Doo-Wop and Rhythm and Blues</h1>
      <small>Use Next/Previous or ← → keys. Session ID: <b id="session-id-display"></b></small>
    </div>
  </header>
  <main class="app" id="main-content">
    <div id="slides" class="slides" aria-live="polite"></div>
  </main>

  <div id="scrim" aria-hidden="true"></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="m-title" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="m-title"></h3>
        <button class="close" id="modalClose">Close ✕</button>
      </div>
      <div id="m-body" class="modal-body"></div>
    </div>
  </div>
  
  <div id="session-overlay" class="overlay hidden">
    <div class="overlay-card">
      <h3>Join a Session</h3>
      <input type="text" id="session-input" class="content-input" placeholder="ENTER SESSION ID">
      <button id="join-session-btn" class="read-btn" style="background:var(--brand);color:#08121f">Join</button>
      <hr>
      <button id="start-session-btn" class="read-btn" style="background: #06d6a0; color:#08121f">Start a New Session</button>
    </div>
  </div>

  <div id="name-entry-overlay" class="overlay hidden">
    <div class="overlay-card">
        <h3>Welcome!</h3>
        <p>Please enter your name to join the session.</p>
        <input type="text" id="name-input" class="content-input" placeholder="Your Name or Nickname" required>
        <button id="join-btn" class="add-content-btn">Join</button>
        <a href="#" id="join-anonymously" style="color: var(--muted); font-size: 0.9em; display:block; margin-top: .5rem">or join anonymously</a>
    </div>
  </div>

  <button id="qna-fab" class="profile-btn" onclick="toggleQnaPanel()">? Questions?</button>
  <div id="qna-panel">
    <div class="qna-head">
      <h3>Live Q&A</h3>
      <button class="close" onclick="toggleQnaPanel()">✕</button>
    </div>
    <div class="qna-body">
      <ul id="qna-list" class="qna-list" style="list-style: none; padding: 0;"><li>No questions yet.</li></ul>
    </div>
    <div class="qna-footer">
      <div class="content-input-container">
        <input type="text" id="qna-input" class="content-input" placeholder="Ask a question...">
        <button class="add-content-btn" onclick="submitQuestion()">Ask</button>
      </div>
    </div>
  </div>

<script type="module">
  // --- IMPORTS AND CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyDxpDj0axohHIFfRQ53NLWBQbf_yI2lJo0",
    authDomain: "interactive-lecture-app.firebaseapp.com",
    projectId: "interactive-lecture-app",
    storageBucket: "interactive-lecture-app.firebasestorage.app",
    messagingSenderId: "47230608512",
    appId: "1:47230608512:web:ba649a4a9ba16cef1df265",
    measurementId: "G-NDLP7MWFH9"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc, updateDoc, increment, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // --- LOCAL STATE (Do not modify) ---
  let userId = null;
  let localUpvotes = new Set();
  let userName = null;
  let sessionId = null;
  let sessionDataPath = null;
  let isPresenter = false; 
  let ix = 0; 
  let slidesEls;
  let timerInterval = null;
  let timerStartTimeout = null;
  
  // ==================================================================
  // --- LESSON CONTENT ---
  // ==================================================================
  
  const SLIDES = [
    {
        "id": "9.00",
        "title": "Lesson 9: Doo-Wop and Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [],
        "full": `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;"><iframe title="vimeo-player" src="https://player.vimeo.com/video/762001491?h=fe0c5db381" width="100%" height="100%" frameborder="0" style="position: absolute; top: 0; left: 0;" allow="fullscreen; picture-in-picture" allowfullscreen></iframe></div>`,
        "deep": []
    },
    {
        "id": "9.01",
        "title": "9.01 Introduction",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "In the 1940s and 1950s, while mainstream white audiences listened to traditional pop, Black audiences enjoyed gospel, doo-wop, and rhythm and blues.",
            "These genres, rooted in blues and jazz, were categorized by record companies as 'race records' and later as 'rhythm and blues'.",
            "This music began reaching white audiences due to technological advances like radio, which had no 'color lines'."
        ],
        "full": "While white audiences were listening to the sounds of Frank Sinatra, Patti Page, and Perry Como in the 1940s and 1950s, black listeners were consuming gospel music, doo-wop, and rhythm and blues. Although all of these genres are related to earlier styles of African American music, such as the blues, ragtime, and jazz, they all have specific features that make them unique. These sacred and secular genres were lumped together by record companies, first on race records and then on rhythm and blues, which was the new industry label for music that was created by and marketed to blacks. Technological advances in recording and broadcasting made it easier and easier to access music. As we will see, there were no color lines on the radio, which meant that white listeners began listening to rhythm and blues.",
        "deep": []
    },
    {
        "id": "9.02",
        "title": "9.02 Gospel Music",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "asideImage": "https://i.imgur.com/pzOs3KD.jpeg",
         "bullets": [
            "During the <b>Great Migration</b>, churches became essential community centers for African Americans moving to the urban North.",
            "<b>Gospel Music</b>, the soundtrack for these churches, featured instrumental accompaniment, improvisation, and call and response.",
            "It was influenced by the <b>Holiness-Pentecostal Movement</b>, which encouraged enthusiastic congregational participation.",
            "Gospel singing often features <b>melisma</b>, a technique where a singer performs many different pitches on a single syllable of text."
        ],
        "full": "During the Great Migration, many African Americans moved from the rural South to the urban North. As people sought new community, churches became essential centers, and their soundtrack was gospel music. Gospel was almost always performed with instrumental accompaniment like piano or organ, and later guitars and drums. It borrowed from popular music forms and was influenced by religious movements like the Holiness-Pentecostal movement, which encouraged enthusiastic congregational participation and expression. A common vocal feature is the melisma, where a single syllable of text is sung over many different pitches. The father of traditional gospel is Thomas A. Dorsey, who blended blues and jazz idioms with sacred lyrics. His music was initially rejected by some churches for its secular sound but became so popular that new gospel songs were often called 'Dorseys'. He and singer Mahalia Jackson promoted his music on street corners, and his song 'Precious Lord, Take My Hand' became an anthem of the Civil Rights Movement.",
        "keywords": {
            "Great Migration": "A period during the early twentieth century when many African Americans moved from the rural South to the urban North in search of better work and quality of life.",
            "Gospel Music": "Black sacred music that included instrumental accompaniment, borrowed from popular music and hymns, and contained melodies intended for improvisation.",
            "Holiness-Pentecostal movement": "A movement in American Christianity that encouraged congregational participation and expression and eschewed polished performance styles.",
            "Melisma": "Many notes sung to a single syllable of text."
        },
        "deep": [
              {
                "title": "Thomas A. Dorsey (1899-1993)",
                "image": "https://i.imgur.com/smPGy0i.jpeg",
                "altText": "A black and white photo of Thomas A. Dorsey, the father of black gospel music, sitting at a piano.",
                "bullets": [
                    "Began his career as a blues pianist known as “Georgia Tom.”",
                    "Combined the energy of blues/jazz with sacred lyrics and an ecstatic singing style.",
                    "His style was initially rejected by churches for its secular sound, being called 'the devil’s music'.",
                    "Promoted his music with singer Mahalia Jackson by performing on street corners and selling sheet music directly to passersby.",
                    "His compositions, like 'Precious Lord, Take My Hand,' became so popular they were simply called 'Dorseys'."
                ],
                "funFacts": [
                    "Dorsey's song 'Precious Lord, Take My Hand' was sung by Mahalia Jackson at Martin Luther King, Jr.'s funeral, and by Aretha Franklin at Mahalia Jackson's funeral."
                ],
                "media": [
                    {"label": "Listen: 'We Will Understand It Better By and By'", "href": "https://open.spotify.com/track/3kPghuMY3en8upeIw5nspC?si=c6e3cd1cd6ba4eb1"},
                    {"label": "Listen: 'Stand By Me'", "href": "https://open.spotify.com/track/5XzYTufFqh58dqF8GiveRE?si=29daf8b910824f03"},
                    {"label": "Watch: 'Stand By Me' (Video)", "href": "https://youtu.be/9kn7E-OauJI?si=y-L1-Ym-AY6Wyol1"},
                    {"label": "Watch: Example of Melisma", "href": "https://youtu.be/PRS2grauL4I?si=SMd3mR_qPnvN4dOu"},
                    {"label": "Listen: 'Precious Lord, Take My Hand'", "href": "https://open.spotify.com/track/2BPMz5V0g0uw9phgqjY7se?si=c7249f9f9d5a4c83"},
                    {"label": "Listen: 'Must Jesus Bear the Cross Alone'", "href": "https://open.spotify.com/track/3IU2IYHaP4NVPNZ9jbKsPG?si=b8012ef1aff746ff"},
                    {"label": "Watch: Aretha Franklin at Mahalia Jackson's funeral", "href": "https://youtu.be/aiFlfAs4Ifg?si=CPxFNV4WZfkMZCr-"},
                    {"label": "Read More: About Thomas Dorsey", "href": "https://www.pbs.org/thisfarbyfaith/people/thomas_dorsey.html"}
                ]
              }
        ],
        "poll": {
            "q": "How did Thomas Dorsey first promote his gospel music?",
            "choices": ["He and Mahalia Jackson would perform on a street corner.", "He asked Louis Jordan’s band to perform it.", "He recorded it with Atlantic Records.", "He asked a university choir to sing it."],
            "answer": 0
        }
    },
    {
        "id": "9.03",
        "title": "9.03 Vocal Harmony Groups (Doo-Wop)",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "<b>Doo-wop</b> groups, often called 'street corner groups,' were popular after WWII, typically featuring four male singers.",
            "The name comes from their use of <b>vocables</b>—non-semantic syllables like 'doo-doo-wop'—that provided a rhythmic background.",
            "A common technique was <b>blow harmony</b>, where a singer would blow into the mic while singing 'ooh-wee' to create a percussive sound.",
            "Early groups like The Ink Spots had crossover appeal, recording for major labels and performing in major venues."
        ],
        "full": "Vocal harmony groups were popular both before and after World War II, singing a mixture of popular music, folk songs, and religious music. After WWII, these groups were often called 'street corner groups' as their style was common in urban African American neighborhoods. They came to be known as <b>Doo-wop</b> groups because they frequently used <b>vocables</b>, or non-semantic syllables like 'doo-doo-wop', to create rhythmic drive. Another technique was <b>blow harmony</b>, which was the result of a singer simultaneously blowing into the microphone and singing 'ooh-wee, ooh-wee.' These two features are the most recognizable characteristics of doo-wop music. The song 'Sh-Boom' by The Chords is a classic example of the up-tempo doo-wop style.",
        "keywords": {
            "Doo-wop": "A style of vocal harmony music that emerged from 'street corner groups' in urban African American neighborhoods after WWII, incorporating harmonies from jazz and blues.",
            "Vocables": "Non-semantic syllables (e.g., 'doo-doo-wop') added to songs that provided a sense of rhythmic drive and a standard phrase for background singers.",
            "Blow harmony": "A common doo-wop gesture where a singer would simultaneously blow into the microphone and sing 'ooh-wee, ooh-wee'."
        },
        "deep": [
            {
                "title": "The Ink Spots",
                "image": "https://i.imgur.com/FBDjnuG.jpeg",
                "altText": "A photo of the four members of The Ink Spots vocal group in matching suits.",
                 "bullets": [
                    "Pioneered a 'Top and Bottom' style with a high tenor lead and a spoken bass part.",
                    "Their 1939 hit 'If I Didn't Care' sold over 19 million copies and is one of the best-selling singles of all time.",
                    "Their musical formula and smooth harmonies were a major influence on the development of doo-wop, R&B, and early rock and roll.",
                    "Featured a signature guitar introduction in many of their songs, a simple arpeggio that made their music instantly recognizable."
                ],
                "fullText": "The Ink Spots were one of the most influential vocal groups of all time. Formed in the early 1930s, their unique sound, often called the 'Top and Bottom' style, was defined by Bill Kenny's floating high tenor lead vocals contrasted with Hoppy Jones's deep, spoken bass interludes, known as a 'talking chorus.' This formula, along with their signature muted guitar intro, made their music instantly identifiable and was copied by countless groups that followed. Their 1939 recording of 'If I Didn't Care' became a massive hit and solidified their place in music history, influencing the birth of doo-wop and the evolution of soul music."
            },
            {
                "title": "The Chords",
                "image": "https://i.imgur.com/S0Chlya.jpeg",
                "altText": "A photo of the five members of The Chords doo-wop group.",
                "bullets": [
                    "An R&B and doo-wop group from The Bronx, New York.",
                    "Their 1954 hit 'Sh-Boom' is often cited as one of the first rock and roll songs.",
                    "The song featured a standard doo-wop progression, a catchy sax solo, and an infectious, upbeat energy that crossed over to white audiences.",
                    "While their version was a #3 R&B hit, a more polished cover version by the white Canadian group The Crew-Cuts went to #1 on the pop charts."
                ],
                "fullText": "The Chords were a doo-wop group from the Bronx best known for their groundbreaking 1954 hit 'Sh-Boom'. The song was revolutionary for its time, blending an upbeat swing with doo-wop harmonies and an exuberant saxophone solo. It is widely considered one of the very first rock and roll records. 'Sh-Boom' became a major R&B hit, but its crossover to the pop charts was largely achieved through a more 'sanitized' cover version by The Crew-Cuts. This pattern of white artists covering Black R&B songs would become a common, and often controversial, practice in the early days of rock and roll.",
                "media": [{"label": "Listen: 'Sh-Boom (Life Could Be A Dream)'", "href": "https://open.spotify.com/track/0mWb7GqTPkzCkNsZ1XLOgw?si=b5526cb41ffb4cf4"}]
            }
        ],
        "poll": {
            "q": "During a final chorus, it was common for doo-wop groups to:",
            "choices": ["Sing the same melody in unison", "Stop singing and let instruments take over", "Sing intricate and complex harmonies", "Switch to speaking their lines"],
            "answer": 2
        }
    },
    {
        "id": "9.04",
        "title": "9.04 Early Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "In 1949, Billboard renamed its 'race records' chart to 'rhythm and blues,' a catchall term for various Black music genres.",
            "As large swing orchestras declined after WWII, smaller combos playing <b>jump blues</b> became popular.",
            "<b>Jump blues</b> featured a 12-bar blues form, boogie-woogie bass lines, strong backbeats, and <b>shuffle rhythms</b>.",
            "Louis Jordan and his Tympany Five were pioneers of this style, scoring crossover hits that appealed to both black and white audiences."
        ],
        "full": "The term 'race records' was officially replaced by 'rhythm and blues' on the Billboard charts in 1949. This was a catchall term for African American music. After WWII, large swing orchestras declined in popularity, and smaller combos rose. One of the first to capitalize on this was Louis Jordan, whose band The Tympany Five played in a style called <b>jump blues</b>. This style featured a 12-bar blues form, boogie woogie bass, strong backbeats, and <b>shuffle rhythms</b>. Jordan’s upbeat, humorous, and high-energy songs had crossover appeal to both black and white audiences and served as an important precursor to rock and roll.",
        "keywords": {
            "Jump blues": "A style of African American music that featured a 12-bar blues form, boogie woogie bass, strong back beats, shuffle rhythms, and group singing during the choruses.",
            "Shuffle rhythms": "A rhythm common in early rhythm and blues that consisted of a triplet quarter note followed by a triplet eighth note."
        },
        "deep": [
            {
                "title": "Louis Jordan (1908-1975)",
                "image": "https://i.imgur.com/N1ugU9q.jpeg",
                "altText": "A charismatic photo of Louis Jordan playing the saxophone.",
                "bullets": [
                    "Founded the Tympani Five, a popular 'jump blues' band.",
                    "His records consistently occupied the race records charts throughout the 1940s.",
                    "His music had crossover appeal, reaching both pop and R&B charts.",
                    "His style heavily influenced the first generation of rock and roll artists."
                ],
                 "funFacts": [
                    "Jordan learned clarinet and saxophone at an early age from his father, a local bandleader in Arkansas.",
                    "He briefly performed with jazz legend Fats Waller.",
                    "His 1944 million-seller 'Is You Is, Or Is You Ain't Ma Baby?' became a national catchphrase."
                ],
                "media": [
                    {"label": "Listen: 'Is You Is, Or Is You Ain't Ma Baby?'", "href": "https://open.spotify.com/track/09rSNL11dDpPjZEAIQVPka?si=dca8e15a705d4a4e"},
                    {"label": "Listen: 'Saturday Night Fish Fry'", "href": "https://open.spotify.com/track/0LHfPA0hWcu40eP3O3pb8N?si=953c01c179434124"},
                    {"label": "Listen: 'Let the Good Times Roll'", "href": "https://open.spotify.com/track/50y6y3iwBlKKev2U4a6GK5?si=264b998eaf8e432c"},
                    {"label": "Listen: 'Choo Choo Ch'Boogie'", "href": "https://open.spotify.com/track/4vPJK1gKyygRS2mep7iyDq?si=813209c5ebb343ca"},
                    {"label": "Listen: 'Ain't Nobody Here But Us Chickens'", "href": "https://open.spotify.com/track/25F0nPXUD6si9DalVWNp6m?si=4203bfa84f8d4cde"},
                    {"label": "Watch: 'Saturday Night Fish Fry'", "href": "https://youtu.be/FCkFrff__QE?si=7iRTMvpIu1EsHK6U"},
                    {"label": "Watch: Bio Documentary", "href": "https://www.youtube.com/watch?v=iReE7xx1nxc&t=487s"}
                ]
            }
        ],
        "poll": {
            "q": "In 1949, what term did the Billboard charts use to replace 'race records'?",
            "choices": ["Sepia Records", "Rhythm and Blues", "Rock and Roll", "Blues"],
            "answer": 1
        }
    },
    {
        "id": "9.05",
        "title": "9.05 From Gospel to Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "Ray Charles was a pivotal artist who masterfully blended gospel music with secular R&B lyrics.",
            "Losing his sight at age seven, he learned to read and write music in Braille.",
            "He controversially adapted gospel songs into R&B hits: 'I Got a Savior' became 'I Got a Woman.'",
            "Charles was an innovator, being among the first to use the Fender Rhodes electric piano and forming the Raelets, a model for later girl groups."
        ],
        "full": "One of the first artists to move freely between gospel music and rhythm and blues and achieve commercial success was Ray Charles. Wrapping the sounds and rhythms of black gospel music around traditional secular lyrics made him one of the most influential musicians of the twentieth century. In 1952, Charles signed with Atlantic and began recording songs that freely blended gospel with rhythm and blues. Although some listeners were shocked at his combination of sacred and secular genres, he saw no reason to separate them, famously stating, 'I’d been singing spirituals since I was three, and I’d been hearing the blues for just as long. So, what could be more natural than to combine them?'. His combinations often took the form of adapting the melodies and lyrics of gospel songs into electrifying R&B numbers, such as turning 'I Got a Savior' into 'I Got a Woman'.",
        "deep": [
            {
                "title": "Ray Charles (1930-2004)",
                "image": "https://i.imgur.com/Wvbi6AU.jpeg",
                "altText": "A classic photo of Ray Charles at the piano, wearing his signature sunglasses.",
                "bullets": [
                    "Lost his sight due to glaucoma at age 6.",
                    "Signed with Atlantic Records in 1952, where he began blending gospel and R&B.",
                    "His 1954 hit 'I Got A Woman' helped pioneer the genre of soul music.",
                    "His call-and-response with his backup singers, the Raelets, became a signature part of his sound."
                ],
                "funFacts": [
                    "To avoid confusion with boxer Sugar Ray Robinson, he changed his name from Ray Charles Robinson to simply Ray Charles.",
                    "He was among the first musicians to use the Fender Rhodes electric piano.",
                    "He briefly joined a hillbilly band and learned how to yodel."
                ],
                "media": [
                    {"label": "Listen: 'Talkin' Bout You'", "href": "https://open.spotify.com/track/4NQE7UxYtLIw0d8Id38jds?si=636d7f75a3fd40c6"},
                    {"label": "Listen: 'I Got a Woman'", "href": "https://open.spotify.com/track/2xar08Fq5xra2KKZs5Bw9j?si=6284a2faf7c04c66"},
                    {"label": "Listen: 'This Little Girl of Mine'", "href": "https://open.spotify.com/track/3QoFJiEWJ0LnDwch93MdZf?si=ca688cde425d4d85"},
                    {"label": "Listen: 'Must Be Jesus' (Source for 'I Got a Woman')", "href": "https://open.spotify.com/track/7M99tD8uA2EyeArWWGvoP8?si=bd7627a24b5e49cd"},
                    {"label": "Listen: 'What'd I Say'", "href": "https://open.spotify.com/track/5yQ9iMZXGcr5rlO4hoLsP4?si=81aa1f6106a24add"},
                    {"label": "Watch: 'I Got a Woman' (Live)", "href": "https://youtu.be/lp246rpr2ck?si=yq1qb3idn1CUGLKR"},
                    {"label": "Watch: Bio Documentary", "href": "https://youtu.be/0XtF8zI3WMg?si=EKN-ox_9QflGNuir"}
                ]
            }
        ]
    },
    {
        "id": "9.06",
        "title": "9.06 Rhythm and Blues Crosses Over",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "A <b>crossover</b> hit is a song that charts on at least two of the three main charts: pop, R&B, and country.",
            "Chuck Berry, a father of rock and roll, created a crossover style by blending R&B with a country and western vocal delivery.",
            "Berry's lyrics focused on teen culture (cars, school, romance), making them relatable to both black and white audiences.",
            "His guitar style and 'duck walk' stage move became iconic and influenced generations of musicians."
        ],
        "full": "While artists like Ray Charles were stitching gospel and R&B together, others like Chuck Berry were taking gestures from jump blues, adding electrified instruments, and borrowing from country and western. This led to a new style of R&B that would soon be called rock and roll. A <b>crossover</b> refers to a song that holds a prominent place on at least two of the three types of charts: pop, rhythm and blues, and country. Berry's music frequently crossed over, as his lyrics about teen life and vocal style influenced by country singers appealed to a wide audience. Other major crossover artists included Fats Domino and Little Richard.",
        "keywords": {
            "Crossover": "A song that holds a prominent place on at least two of the three types of charts: pop, rhythm and blues, and country."
        },
        "deep": [
            {
                "title": "Chuck Berry (1926-2017)",
                "image": "https://i.imgur.com/cMgydDS.jpeg",
                "altText": "A classic photo of Chuck Berry mid-performance, playing his electric guitar and doing his famous 'duck walk'.",
                "bullets": [
                    "Considered the single most important guitarist in early rock and roll.",
                    "His first hit, 'Maybellene' (1955), was a reworking of the country song 'Ida Red'.",
                    "Wrote lyrics about teen culture: cars, girl-boy problems, school, and music.",
                    "His song 'Johnny B. Goode' was included on the golden record aboard the Voyager spacecraft."
                ],
                "funFacts": [
                    "His famous 'duck walk' became an iconic part of his performances.",
                    "His vocal delivery was so influenced by country singers that many listeners were surprised to learn he was Black.",
                    "He famously said: 'Curiosity provoked me to lay a lot of our country stuff on our predominantly black audience... some of our black audience began whispering, “who is that black hillbilly at the Cosmo?”'"
                ],
                "media": [
                    {"label": "Listen: 'Ida Red' (Source for 'Maybellene')", "href": "https://open.spotify.com/track/6Va6Mpqj9prgmYwUHdxj4z?si=9af3af97b4d54cc8"},
                    {"label": "Listen: 'Maybellene'", "href": "https://open.spotify.com/track/3SQhmctWreNM0X6Zkm2K5R?si=cad1544a67bf4f10"},
                    {"label": "Listen: 'School Day'", "href": "https://open.spotify.com/track/3RYwxAkUbHCzCmX8M0C0Zd?si=4d0afcc8b0064f31"},
                    {"label": "Listen: 'Sweet Little Sixteen'", "href": "https://open.spotify.com/track/4GWHrdyVTC0AWwuRgoWzE7?si=8cf645bdd3694f38"},
                    {"label": "Listen: 'Johnny B. Goode'", "href": "https://open.spotify.com/track/2QfiRTz5Yc8DdShCxG1tB2?si=6d4ad5d0c03d45e6"},
                    {"label": "Listen: 'Roll Over Beethoven'", "href": "https://open.spotify.com/track/6C7aTTCUWRK7dD379yUT3W?si=d2761b0cdcbd490d"},
                    {"label": "Read More: Rock & Roll Hall of Fame Bio", "href": "https://rockhall.com/inductees/chuck-berry/"}
                ]
            },
            {
                "title": "Fats Domino (1928-2017)",
                "image": "https://i.imgur.com/f1gm0A6.jpeg",
                "altText": "A photo of Fats Domino smiling and playing the piano.",
                "bullets": [
                    "A New Orleans-based pianist and singer-songwriter.",
                    "His relaxed, boogie-woogie piano style and warm voice made him one of rock's earliest and most successful stars.",
                    "Achieved major crossover success with hits like 'Ain't That a Shame' and his cover of 'Blueberry Hill'."
                ],
                "media": [
                     {"label": "Listen: 'Blueberry Hill'", "href": "https://open.spotify.com/track/2NkAoxQOr6MGdMB5JDTU81?si=c9daf36cd4014b62"},
                     {"label": "Listen: 'Ain't That a Shame'", "href": "https://open.spotify.com/track/7I7lZjnuj3npLFCWodA5Xk?si=b67f3bb695c542cf"}
                ]
            },
            {
                "title": "Little Richard (1932-2020)",
                "image": "https://i.imgur.com/bQ4y02z.jpeg",
                "altText": "A flamboyant photo of Little Richard at the piano with a dramatic expression.",
                "bullets": [
                    "Known as one of the 'Architects of Rock and Roll' for his explosive energy and charismatic showmanship.",
                    "His music was defined by pounding piano, a powerful, raspy voice, and often suggestive lyrics.",
                    "Scored major crossover hits with songs like 'Long Tall Sally' and 'Good Golly Miss Molly'."
                ],
                 "media": [
                     {"label": "Listen: 'Long Tall Sally'", "href": "https://open.spotify.com/track/507IFqPuG8mBQoKebfGG9t?si=f0467f2132914f18"},
                     {"label": "Listen: 'Good Golly Miss Molly'", "href": "https://open.spotify.com/track/7ojv5P29GWTw89c7w6drV9?si=f29d997f2edd44eb"},
                     {"label": "Watch: 'Good Golly Miss Molly' (Live)", "href": "https://youtu.be/AK_jm3Hz1Wk?si=c94vKBgSnx6QmzNm&t=48"}
                ]
            }
        ]
    },
    {
      "id": "9.06b",
      "title": "Interactive Activity: Build a Blues Verse",
      "headerImage": "https://i.imgur.com/4uodWhO.png",
      "bullets": ["Drag the lines from the pool on the left to construct a classic AAB blues verse."],
      "full": "",
      "deep": [],
      "buildaband": {
          "correct": [ "line-a1", "line-a2", "line-b" ],
          "distractors": [ "distractor-1", "distractor-2", "distractor-3" ],
          "itemMap": {
            "line-a1": "Woke up this mornin', feelin' sad and blue.",
            "line-a2": "I said, I woke up this mornin', feelin' sad and blue.",
            "line-b": "My baby left me, now I don't know what to do.",
            "distractor-1": "The sun is shining bright today.",
            "distractor-2": "I think I'll go out for a walk.",
            "distractor-3": "She said she'd call me yesterday."
          },
          "bandAreaTitle": "Your Blues Verse",
          "poolTitle": "Lyrical Lines",
          "customDropzones": [
              {"title": "Line 1 (A)", "accepts": ["line-a1"]},
              {"title": "Line 2 (A - Repeat)", "accepts": ["line-a2"]},
              {"title": "Line 3 (B - Rhyme/Response)", "accepts": ["line-b"]}
          ]
      }
    },
    {
        "id": "9.07",
        "title": "9.07 Conclusion",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "Gospel, doo-wop, and rhythm and blues were distinct but related genres of African American music popular in the 1940s and 50s.",
            "Initially marketed as 'race records,' this music began to cross over to white audiences via radio.",
            "This cultural crossover set the stage for the transformation of rhythm and blues into the new genre of rock and roll."
        ],
        "full": "Many different types of African American music were popular in the 1940s and 1950s, including gospel, doo-wop, and rhythm and blues. Although record labels kept this music confined first to the 'race' label and then to the 'rhythm and blues' label, white audiences eventually began hearing and consuming rhythm and blues. As we will see in the next lesson, rhythm and blues underwent a number of musical and racial changes as it was transformed into rock and roll.",
        "deep": [],
        "wordcloud": {
            "title": "Final Thoughts?",
            "prompt": "What one word describes the music from this chapter? Add it to our word cloud!"
        }
    }
  ];
  
  const QUIZ = [
    { "q": "This song is an adaptation of what other type of music?", "choices": ["Tin Pan Alley", "big band", "gospel", "doo-wop"], "answer": 2, "media": "https://open.spotify.com/track/5ZyhkgdOZ4fTAc1iwSfrHT?si=223ca7a127c14d20" },
    { "q": "Which of the following songs was NOT by Louis Jordan?", "choices": ["\"We Will Understand It Better By and By\"", "\"Let the Good Times Roll\"", "\"Is You Is, Or Is You Ain't Ma Baby?\"", "\"Saturday Night Fish Fry\""], "answer": 0 },
    { "q": "What vocal technique does the singer frequently use in this song?", "choices": ["syncopation", "blow harmony", "melisma", "vocable"], "answer": 2, "media": "https://open.spotify.com/track/2BPMz5V0g0uw9phgqjY7se?si=0937b9fa031a45bc" },
    { "q": "How did Thomas Dorsey first promote his gospel music?", "choices": ["He and Mahalia Jackson would stand on a street corner and perform the music.", "He asked Louis Jordan’s band to perform it.", "He recorded it with Atlantic, who then distributed the recordings.", "He asked a university choir to sing it."], "answer": 0 },
    { "q": "Which of the following was typical for a doo-wop group?", "choices": ["The use of orchestral instruments", "Religious subject matter", "Racially integrated membership", "Four male singers"], "answer": 3 },
    { "q": "Chuck Berry performed his famous _________ during his guitar solos.", "choices": ["\"boogie woogie\"", "\"duck walk\"", "\"turkey trot\"", "\"jump blues\""], "answer": 1 },
    { "q": "What musical style is heard in this excerpt?", "choices": ["gospel music", "12-bar blues", "jump blues", "arranged spiritual"], "answer": 2, "media": "https://open.spotify.com/track/0eRHaqF1lJDIJ0GTy5SGC6?si=2af3c7ba8b5b47bc" },
    { "q": "All of the following were vocal harmony groups EXCEPT:", "choices": ["The Chords", "The Mills Brothers", "The Orioles", "The Fisk Jubilee Singers"], "answer": 3 },
    { "q": "This song is an example of:", "choices": ["doo-wop", "rhythm and blues", "gospel music", "jump blues"], "answer": 0, "media": "https://open.spotify.com/track/3SQhmctWreNM0X6Zkm2K5R?si=9344abd5f23e403d" },
    { "q": "In 1949, what term did the Billboard charts use to replace 'race records'?", "choices": ["sepia records", "rhythm and blues", "rock and roll", "blues"], "answer": 1 },
    { "q": "Which of the following songs includes vocables?", "choices": ["\"Sh-Boom\"", "\"I Got a Woman\"", "“Is You Is, Or Is You Ain’t My Baby?”", "\"Precious Lord, Take My Hand\""], "answer": 0 },
    { "q": "'Maybellene' is based on a country and western song.", "choices": ["True", "False"], "answer": 0 },
    { "q": "Gospel music was influenced by the Holiness-Pentecostal movement.", "choices": ["True", "False"], "answer": 0 },
    { "q": "New gospel songs during the 1940s and 1950s were often called 'Dorseys.'", "choices": ["True", "False"], "answer": 0 },
    { "q": "The name 'doo-wop' comes from syllables of text that groups sang.", "choices": ["True", "False"], "answer": 0 },
    { "q": "After World War II, small combos like jump blues bands increased in popularity.", "choices": ["True", "False"], "answer": 0 },
    { "q": "Louis Jordan's music had crossover appeal with white audiences.", "choices": ["True", "False"], "answer": 0 },
    { "q": "Race records included gospel music, vocal harmony groups, and rhythm and blues music.", "choices": ["True", "False"], "answer": 0 },
    { "q": "During a final chorus, it was common for doo-wop groups to sing intricate harmonies.", "choices": ["True", "False"], "answer": 0 }
  ];
  
  const EXTRA = {};

  // ==================================================================
  // --- APPLICATION LOGIC (It is best not to modify below this line) ---
  // ==================================================================

  // --- AUTHENTICATION & INITIALIZATION ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        userId = user.uid;
        checkSessionState();
    } else {
        try {
            if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); }
            else { await signInAnonymously(auth); }
        } catch (error) { console.error("Firebase authentication failed:", error); }
    }
  });
  
  function initializeInteractiveFeatures(){
    if(!sessionId) return;
    sessionDataPath = `/artifacts/${appId}/public/data/sessions/${sessionId}`;
    setupNavigationListener();
    setupQuizBattleListener();
    setupPollListeners();
    setupWordCloudListener();
    setupQnaListener();
    if(isPresenter) {
        setupAttendanceListener();
    }
  }
  
  function showApp(){
      document.getElementById('session-overlay').classList.add('hidden');
      document.getElementById('name-entry-overlay').classList.add('hidden');
      document.getElementById('main-header').style.display = 'block';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('qna-fab').style.display = 'block';
  }

  // --- USER SESSION ---
   function initializeUserSession() {
    const startBtn = document.getElementById('start-session-btn');
    const joinBtn = document.getElementById('join-session-btn');
    
    startBtn.addEventListener('click', () => {
        const newSessionId = Math.floor(100000 + Math.random() * 900000).toString();
        const currentUrl = new URL(window.location.origin + window.location.pathname);
        currentUrl.searchParams.set('session', newSessionId);
        currentUrl.searchParams.set('presenter', 'true');
        window.location.href = currentUrl.href;
    });

    joinBtn.addEventListener('click', () => {
        const sessionInput = document.getElementById('session-input');
        const inputId = sessionInput.value.trim();
        if (inputId) {
            const currentUrl = new URL(window.location.origin + window.location.pathname);
            currentUrl.searchParams.set('session', inputId);
            window.location.href = currentUrl.href;
        }
    });

    const nameInput = document.getElementById('name-input');
    const joinNameBtn = document.getElementById('join-btn');
    const anonBtn = document.getElementById('join-anonymously');

    async function joinWithName(name) {
        if (!name || !sessionId || !userId) return;
        userName = name;
        localStorage.setItem(`lesson_userName_${sessionId}`, name);
        try {
            const participantsRef = doc(db, `/artifacts/${appId}/public/data/sessions/${sessionId}/participants/${userId}`);
            await setDoc(participantsRef, { name: userName, joinedAt: new Date() });
        } catch (error) {
            console.error("Error writing attendance:", error);
        }
        startApp();
    };

    joinNameBtn.addEventListener('click', () => { if (nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    anonBtn.addEventListener('click', (e) => { e.preventDefault(); joinWithName(`Student${Math.floor(1000 + Math.random() * 9000)}`); });
  }
  
   function checkSessionState() {
    const sessionOverlay = document.getElementById('session-overlay');
    const nameOverlay = document.getElementById('name-entry-overlay');

    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('session');
    isPresenter = urlParams.get('presenter') === 'true';

    if (sessionId) {
        sessionOverlay.classList.add('hidden');
        document.getElementById('session-id-display').textContent = sessionId;
        
        const storedName = localStorage.getItem(`lesson_userName_${sessionId}`);
        if (storedName) {
            userName = storedName;
            startApp();
        } else {
            nameOverlay.classList.remove('hidden');
        }
    } else {
        sessionOverlay.classList.remove('hidden');
    }
}

function startApp() {
    if (!userId || !sessionId || !userName) {
        console.error("Cannot start app, missing user, session, or name info", {userId, sessionId, userName});
        return;
    }
    
    render();

    document.getElementById('session-overlay').classList.add('hidden');
    document.getElementById('name-entry-overlay').classList.add('hidden');
    
    showApp();
    initializeInteractiveFeatures();
}

  // --- INTERACTIVE FEATURES ---
  function setupNavigationListener() {
    const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
    onSnapshot(stateRef, (docSnap) => {
        const slideState = docSnap.exists() ? docSnap.data() : { currentSlide: 0 };
        const newIndex = slideState.currentSlide ?? 0;
        show(newIndex);
    }, (error) => {
        console.error("[Listener Error] Navigation listener failed:", error);
    });
  }

  function setupAttendanceListener() {
    const attendanceRef = collection(db, `${sessionDataPath}/participants`);
    const listEl = document.getElementById('attendance-list');
    if (!listEl) return;

    onSnapshot(query(attendanceRef, orderBy("joinedAt")), (snapshot) => {
        listEl.innerHTML = '';
        if (snapshot.empty) {
            listEl.innerHTML = '<li>No one has joined yet.</li>';
        } else {
            snapshot.forEach(doc => {
                const participant = doc.data();
                const li = document.createElement('li');
                li.textContent = participant.name;
                listEl.appendChild(li);
            });
        }
    });
  }

  // Polls
  function setupPollListeners() {
    document.querySelectorAll('.poll').forEach(pollEl => {
        const pollId = pollEl.dataset.pollId;
        if (pollId) {
            const votesRef = collection(db, `${sessionDataPath}/polls/${pollId}/votes`);
            onSnapshot(query(votesRef), (snapshot) => {
                const votes = {}; let totalVotes = 0; let userVote = -1;
                snapshot.forEach(doc => {
                    const vote = doc.data().choice;
                    votes[vote] = (votes[vote] || 0) + 1;
                    totalVotes++;
                    if (doc.id === userId) userVote = vote;
                });
                renderPollResults(pollId, votes, totalVotes, userVote);
            });
        }
    });
  }

  function renderPollResults(pollId, votes, totalVotes, userVote) {
    const pollEl = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollEl) return;
    pollEl.querySelectorAll('.poll-option').forEach((optionEl, index) => {
        const voteCount = votes[index] || 0;
        const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
        optionEl.querySelector('.poll-bar').style.width = `${percentage}%`;
        optionEl.querySelector('.poll-percent').textContent = `${Math.round(percentage)}%`;
        const button = optionEl.querySelector('button');
        button.disabled = false;
        optionEl.classList.remove('voted-for');
        if (userVote !== -1) {
            button.disabled = true;
            if (index === userVote) optionEl.classList.add('voted-for');
        }
    });
  }

  async function submitPollVote(pollId, choiceIndex) {
      if (!userId) return;
      const voteRef = doc(db, `${sessionDataPath}/polls/${pollId}/votes/${userId}`);
      await setDoc(voteRef, { choice: choiceIndex });
  };
  
  // Word Cloud
  function setupWordCloudListener() {
    const wordsRef = collection(db, `${sessionDataPath}/wordcloud`);
    onSnapshot(query(wordsRef), (snapshot) => {
        const words = {};
        snapshot.forEach(doc => {
            const word = doc.data().text.toLowerCase().trim();
            words[word] = (words[word] || 0) + 1;
        });
        renderWordCloud(words);
    });
  }

  function renderWordCloud(words) {
    const display = document.getElementById('word-cloud-display');
    if (!display) return;
    display.innerHTML = '';
    const maxFreq = Math.max(...Object.values(words), 1);
    const sortedWords = Object.keys(words).sort((a,b) => words[b] - words[a]);
    sortedWords.forEach(word => {
        const freq = words[word];
        const span = document.createElement('span');
        span.textContent = word;
        const size = 1 + (freq / maxFreq) * 2;
        span.style.fontSize = `${size}em`;
        span.style.opacity = 0.6 + (freq / maxFreq) * 0.4;
        display.appendChild(span);
    });
  }

  async function submitWord() {
    const input = document.getElementById('word-cloud-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/wordcloud`), { text, author: userId });
        input.value = '';
    }
  };

  // Q&A
  function setupQnaListener() {
    const qnaRef = collection(db, `${sessionDataPath}/qna`);
    onSnapshot(query(qnaRef, orderBy("upvotes", "desc")), (snapshot) => {
        const questions = [];
        snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
        renderQna(questions);
    });
  }

  function renderQna(questions) {
    const list = document.getElementById('qna-list');
    if (!list) return;
    list.innerHTML = questions.length ? '' : '<li>No questions yet. Be the first!</li>';
    questions.forEach(q => {
        const hasVoted = localUpvotes.has(q.id);
        const li = document.createElement('li');
        li.innerHTML = `
            <button class="upvote-btn ${hasVoted ? 'voted' : ''}" onclick="upvoteQuestion('${q.id}')" ${hasVoted ? 'disabled' : ''}>
                <span>▲</span>
                <span>${q.upvotes || 0}</span>
            </button>
            <div>
                <p>${q.text}</p>
                <small style="color:var(--muted)">asked by ${q.name || `...${q.author.slice(-4)}`}</small>
            </div>
        `;
        list.appendChild(li);
    });
  }
  
  async function submitQuestion() {
    const input = document.getElementById('qna-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/qna`), { text, author: userId, upvotes: 0, name: userName || 'Anonymous' });
        input.value = '';
    }
  };

  async function upvoteQuestion(questionId) {
    if (localUpvotes.has(questionId)) return;
    localUpvotes.add(questionId);
    const qRef = doc(db, `${sessionDataPath}/qna/${questionId}`);
    await updateDoc(qRef, { upvotes: increment(1) });
  };
  
  // Quiz Battle
  const BATTLE_QUIZ = QUIZ.filter(q => !q.media);
  let localAnswers = {}; 

  async function setupQuizBattleListener() {
    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    onSnapshot(battleStateRef, (docSnap) => {
      const state = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
      renderQuizState(state);
    });

    const scoresRef = collection(db, `${sessionDataPath}/scores`);
    onSnapshot(query(scoresRef), (snapshot) => {
      const scores = [];
      snapshot.forEach(doc => scores.push({ id: doc.id, ...doc.data() }));
      scores.sort((a, b) => (b.timePoints || 0) - (a.timePoints || 0) || (b.correctAnswers || 0) - (a.correctAnswers || 0));
      renderLeaderboard(scores);
    });
  }

  function renderLeaderboard(scores) {
      const list = document.getElementById('leaderboard-list');
      if (!list) return;
      list.innerHTML = scores.length ? '' : '<li>No scores yet!</li>';
      scores.forEach(player => {
          list.innerHTML += `<li><div><span class="player-name">${player.name || `Player ...${player.id.slice(-4)}`}</span><span class="correct-answers"> (${player.correctAnswers || 0}/${BATTLE_QUIZ.length})</span></div><span class="score">${player.timePoints || 0} pts</span></li>`;
      });
  }

  function renderQuizState(state) {
    const questionArea = document.getElementById('quiz-question-area'), controlsArea = document.getElementById('quiz-controls'), feedbackArea = document.getElementById('quiz-feedback'), timerArea = document.getElementById('quiz-timer');
    if (!questionArea || !controlsArea || !feedbackArea || !timerArea) return;
    clearInterval(timerInterval);
    clearTimeout(timerStartTimeout);

    if (state.status === 'waiting' || state.currentQuestion === -1) {
      questionArea.innerHTML = '<p>The quiz battle is about to begin!</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Start Quiz Battle</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to start the quiz...</i></p>`;
      }
    } else if (state.status === 'finished') {
      questionArea.innerHTML = '<h3>Quiz Battle Over!</h3><p>Check the final scores on the leaderboard.</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Play Again?</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>The quiz has ended.</i></p>`;
      }
    } else { 
      timerArea.style.display = 'block';
      const qIndex = state.currentQuestion, question = BATTLE_QUIZ[qIndex];
      const media = question.media ? `<p class="media"><a href="${question.media}" target="_blank" rel="noopener">Open media for question</a></p>` : '';
      const choices = question.choices.map((opt, ci) => `<button id="choice-${ci}" class="choice-btn" onclick="submitQuizAnswer(${qIndex}, ${ci}, ${state.questionStartTime})">${opt}</button>`).join('');
      questionArea.innerHTML = `<div class="q"><h4>Q${qIndex + 1}. ${question.q}</h4>${media}<div class="choices">${choices}</div></div>`;
      feedbackArea.innerHTML = '';

      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Next Question ▶</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to advance to the next question...</i></p>`;
      }
      
      const startTime = state.questionStartTime;
      timerArea.textContent = 'Get Ready...';
      
      if(localAnswers[qIndex] === undefined) { 
        timerStartTimeout = setTimeout(() => {
            timerInterval = setInterval(() => {
                const elapsedSeconds = (new Date().getTime() - startTime) / 1000;
                if (elapsedSeconds >= 20) { // Total time: 5s grace + 15s scoring
                    timerArea.textContent = '0 points';
                    clearInterval(timerInterval);
                    if (localAnswers[qIndex] === undefined) {
                        document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                        const correctBtn = document.getElementById(`choice-${question.answer}`);
                        if (correctBtn) correctBtn.classList.add('correct');
                        if (feedbackArea) feedbackArea.textContent = "Time's up!";
                    }
                } else if (elapsedSeconds >= 5) { // Scoring period
                    const scoringSeconds = elapsedSeconds - 5;
                    const points = Math.round(1000 * (1 - (scoringSeconds / 15)));
                    timerArea.textContent = `${points} points`;
                }
            }, 100);
        }, 5000);
      } else {
        showAnswerFeedback(qIndex, localAnswers[qIndex]);
      }
    }
  }

  async function startOrAdvanceQuiz() {
    if (!isPresenter || !userId || !userName) return;

    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    const docSnap = await getDoc(battleStateRef);
    const currentState = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
    let nextQuestion = currentState.currentQuestion + 1;

    if (currentState.status === 'finished' || currentState.status === 'waiting') {
        localAnswers = {};
        const scoresRef = doc(db, `${sessionDataPath}/scores/${userId}`);
        await setDoc(scoresRef, { correctAnswers: 0, timePoints: 0, name: userName || 'Anonymous' });
        nextQuestion = 0;
    }
    
    if (nextQuestion >= BATTLE_QUIZ.length) {
        await setDoc(battleStateRef, { status: 'finished', currentQuestion: -1 });
    } else {
        await setDoc(battleStateRef, { status: 'in_progress', currentQuestion: nextQuestion, questionStartTime: new Date().getTime() });
    }
  };

  async function submitQuizAnswer(qIndex, choiceIndex, questionStartTime) {
      if (localAnswers[qIndex] !== undefined) return;
      localAnswers[qIndex] = choiceIndex;
      clearInterval(timerInterval);
      clearTimeout(timerStartTimeout);

      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex;
      const scoreRef = doc(db, `${sessionDataPath}/scores/${userId}`);
      
      const elapsedSeconds = (new Date().getTime() - questionStartTime) / 1000;

      if (isCorrect) {
          let points = (elapsedSeconds >= 5 && elapsedSeconds < 20) ? Math.round(1000 * (1 - ((elapsedSeconds-5) / 15))) : 0;
          await setDoc(scoreRef, { correctAnswers: increment(1), timePoints: increment(points) }, { merge: true });
      } else {
          await setDoc(scoreRef, { timePoints: increment(-250) }, { merge: true });
      }
      showAnswerFeedback(qIndex, choiceIndex);
  };

  function showAnswerFeedback(qIndex, choiceIndex) {
      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex, feedbackArea = document.getElementById('quiz-feedback');
      document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
      const chosenBtn = document.getElementById(`choice-${choiceIndex}`), correctBtn = document.getElementById(`choice-${question.answer}`);
      if (isCorrect) {
          chosenBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Correct!'; feedbackArea.style.color = 'var(--brand)'; }
      } else {
          chosenBtn.classList.add('incorrect');
          correctBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Incorrect! -250 points'; feedbackArea.style.color = 'rgb(239, 71, 111)';}
      }
  }
  
  // --- RENDERING & DOM MANIPULATION ---
  function toggleProfile(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.hidden = !el.hidden;
  }
  
  function toggleFunFacts(id) {
    const el = document.getElementById(id);
    if (el) el.hidden = !el.hidden;
  }

  function deepListHTML(sectionIdx, deep){
    if(!deep || !deep.length) return '';
    const items = deep.map((d,di)=>{
      const contentId = `profile-content-${sectionIdx}-${di}`;
      const funFactsId = `fun-facts-${sectionIdx}-${di}`;
      
      const bulletsHTML = (d.bullets||[]).length > 0 ? `<h4>Key points</h4><ul>${(d.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>` : '';
      
      let mediaContent = (d.media||[]).map(m=> {
          if (m.href) {
              return `<li><a href="${m.href}" target="_blank" rel="noopener">${m.label}</a></li>`;
          }
          return '';
      }).join('');
      const mediaHTML = mediaContent ? `<h4>Media</h4><ul>${mediaContent}</ul>` : '';

      const fullTextHTML = d.fullText ? `<p>${d.fullText}</p>`: '';
      const funFactsHTML = (d.funFacts && d.funFacts.length > 0) ? `<button class="read-btn" style="margin-top:1rem;" onclick="toggleFunFacts('${funFactsId}')">Fun Facts</button><div id="${funFactsId}" class="full" hidden><ul>${d.funFacts.map(f => `<li>${f}</li>`).join('')}</ul></div>` : '';
      
      let fullContentHTML = '';
      if (d.image) {
          fullContentHTML = `
              <div style="text-align: left;">
                  <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; margin-bottom: 1rem;">
                      <div style="flex: 1 1 250px; min-width: 200px;">
                          <img alt="${d.altText || d.title}" src="${d.image}" style="width: 100%; height: auto; border-radius: .4rem;">
                      </div>
                      <div style="flex: 2 1 300px;">
                          ${bulletsHTML}
                          ${mediaHTML}
                      </div>
                  </div>
                  <div>
                      ${fullTextHTML}
                      ${funFactsHTML}
                  </div>
              </div>`;
      } else {
          fullContentHTML = `<div style="text-align: left;">${bulletsHTML}${mediaHTML}${fullTextHTML}${funFactsHTML}</div>`;
      }

      return `
        <li class="deep-item" style="flex-direction: column; gap: 0;">
          <button type="button" class="profile-btn" onclick="toggleProfile('${contentId}')">${d.title}</button>
          <div id="${contentId}" class="full" hidden style="max-width: 100%; box-sizing: border-box; padding: 1.2rem; background: #1a1d29; border-radius: 0 0 .55rem .55rem;">
            ${fullContentHTML}
          </div>
        </li>`;
    }).join('');
    return `<ul class="deep-list">${items}</ul>`;
  }
  
    function pollHTML(check, slideId) {
        if (!check) return '';
        const pollId = `poll-${slideId}`;
        const choices = check.choices.map((opt, ci) => `
            <div class="poll-option">
                <div class="poll-bar"></div>
                <span class="poll-percent">0%</span>
                <button onclick="submitPollVote('${pollId}', ${ci})">${opt}</button>
            </div>
        `).join('');

        const revealBtn = isPresenter ? `<button class="read-btn" style="margin-top:1rem;" onclick="revealPollAnswer('${pollId}', ${check.answer})">Reveal Answer</button>` : '';

        return `
            <div class="poll interactive-section" data-poll-id="${pollId}">
                <h3>Test Your Knowledge</h3>
                <p>${check.q}</p>
                <div class="choices">${choices}</div>
                ${revealBtn}
            </div>
        `;
    }

    function buildABandHTML(data, slideId) {
      if (!data) return '';
      const containerId = `dnd-container-${slideId}`;
  
      if (data.customDropzones && data.itemMap) {
          const items = [...data.correct, ...data.distractors].sort(() => Math.random() - 0.5);
          const itemHTML = items.map(id => `<div class="instrument" draggable="true" id="dnd-item-${id}" data-instrument-id="${id}">${data.itemMap[id]}</div>`).join('');
          
          const dropzoneHTML = data.customDropzones.map(zone => 
              `<div class="band-area" data-accepts='${JSON.stringify(zone.accepts)}'><h4>${zone.title}</h4></div>`
          ).join('');
  
          return `
              <div id="${containerId}" class="interactive-section build-a-band-container">
                  <h3>${data.bandAreaTitle || 'Build a Band'}</h3>
                   <p>Drag each line from the pool on the left into the correct slot to build a blues verse.</p>
                  <div class="build-a-band">
                      <div class="instrument-pool" style="flex: 2;"><h4>${data.poolTitle || 'Items'}</h4>${itemHTML}</div>
                      <div style="flex: 3; display: flex; flex-direction: column; gap: 1rem;">${dropzoneHTML}</div>
                  </div>
              </div>
          `;
      }
      return '';
    }

  function wordCloudHTML(data) {
    if (!data) return '';
    const title = data.title || 'Final Thoughts?';
    const prompt = data.prompt || 'What one word describes this topic to you? Add it to our word cloud!';
    return `
        <div class="interactive-section word-cloud-container">
            <div class="word-cloud-input">
                <h3>${title}</h3>
                <p>${prompt}</p>
                <div class="content-input-container">
                    <input type="text" id="word-cloud-input" class="content-input" placeholder="e.g., Soulful, Rhythmic...">
                    <button class="add-content-btn" onclick="submitWord()">Submit</button>
                </div>
            </div>
            <div id="word-cloud-display" class="word-cloud-display"></div>
        </div>
    `;
  }

  function render(){
    const host = document.getElementById('slides');
    if (!host) return;
    host.innerHTML = ''; 
    
    let slidesToRender = [...SLIDES];
    let totalSlides = slidesToRender.length + 1; // +1 for Quiz
    
    if (isPresenter) {
        const attendanceSlide = {
            id: "9.99_attendance",
            title: "Session Attendance",
            headerImage: "https://i.imgur.com/4uodWhO.png",
            bullets: ["The following users have joined this session:"],
            full: "<ul id='attendance-list' style='list-style-type: disc; padding-left: 2rem;'><li>Loading...</li></ul>",
        };
        slidesToRender.push(attendanceSlide); // Add to the end of content slides
        totalSlides = slidesToRender.length + 1; // Recalculate total with attendance slide
    }

    slidesToRender.forEach((s,idx)=>{
      const bullets = s.bullets.map(b=>`<li>${b}</li>`).join('');
      const deep = deepListHTML(idx, s.deep);
      const poll = pollHTML(s.poll, s.id);
      const buildaband = buildABandHTML(s.buildaband, s.id);
      const wordcloud = wordCloudHTML(s.wordcloud);
      const headerImage = s.headerImage ? `<img src="${s.headerImage}" alt="" style="width: 100%; border-radius: .4rem; margin-bottom: 1rem;" />` : '';
      const keywordsHTML = s.keywords ? `<ul class="keywords-list">${Object.entries(s.keywords).map(([term, def]) => `<li><b>${term}:</b> ${def}</li>`).join('')}</ul>` : '';
      const asideImageHTML = s.asideImage ? `<div class="slide-body-aside"><img src="${s.asideImage}" alt=""></div>` : '';
      const mainContentClass = s.asideImage ? 'slide-body-main' : '';

      let footerHTML = '';
      if (isPresenter) {
          const prevBtn = idx > 0 ? `<button class="nav-btn" onclick="go(${idx-1})">◀ Previous</button>` : '<span></span>';
          const nextBtn = (idx < slidesToRender.length) ? `<button class="nav-btn" onclick="go(${idx+1})">Next ▶</button>` : '<span></span>';
          footerHTML = `<footer class="slide-nav">${prevBtn}<button class="home-btn" onclick="go(0)">Home</button>${nextBtn}</footer>`;
      }
      
      const mainBody = s.id === '9.99_attendance' ? `<div class="${mainContentClass}">${s.full}</div>` : `
        <div class="${mainContentClass}">
            <ul class="bullets">${bullets}</ul>
            <div class="slide-actions">
                    ${s.full ? `<button class="read-btn" onclick="toggleFull(${idx})">Read Full Text</button>` : ''}
                    ${s.keywords ? `<button class="read-btn" onclick="toggleKeywords(${idx})">Keywords</button>` : ''}
            </div>
            <article id="full-${idx}" class="full" hidden>${s.full}</article>
            <article id="keywords-${idx}" class="full" hidden>${keywordsHTML}</article>
        </div>
        ${asideImageHTML}
      `;

      host.insertAdjacentHTML('beforeend', `
        <section class="slide" id="slide-${idx}" data-ix="${idx}" aria-labelledby="h-${s.id}">
          <header class="slide-head">
            <h2 id="h-${s.id}">${s.title}</h2>
            <div style="display: flex; align-items: center; gap: .5rem;">
              <div class="meter">Slide ${idx+1} of ${totalSlides}</div>
              <button class="read-aloud-btn" id="read-aloud-btn-${idx}" onclick="readSlideAloud(${idx})">🔊 Read Aloud</button>
            </div>
          </header>
          ${headerImage}
          <div class="${s.asideImage ? 'slide-body-with-aside' : ''}">${mainBody}</div>
          ${deep}
          ${poll}
          ${buildaband}
          ${wordcloud}
          ${footerHTML}
        </section>
      `);
    });

    const qIndex = slidesToRender.length;
    let quizFooterHTML = '';
    if (isPresenter) {
        quizFooterHTML = `<footer class="slide-nav"><button class="nav-btn" onclick="go(${qIndex-1})">◀ Previous</button><button class="home-btn" onclick="go(0)">Home</button><span></span></footer>`;
    }

    host.insertAdjacentHTML('beforeend', `
      <section class="slide" id="slide-${qIndex}" data-ix="${qIndex}" aria-labelledby="h-quiz">
        <header class="slide-head"><h2 id="h-quiz">Lesson Quiz Battle</h2><div class="meter">Slide ${qIndex + 1} of ${totalSlides}</div></header>
        <div class="quiz-battle-container">
          <div class="quiz-main">
            <div id="quiz-timer">1000 points</div>
            <div id="quiz-question-area"><p>Loading Quiz Battle...</p></div>
            <div id="quiz-feedback"></div>
            <div id="quiz-controls"></div>
          </div>
          <div class="leaderboard">
            <h3>Leaderboard</h3>
            <ul id="leaderboard-list">
              <li>Loading...</li>
            </ul>
          </div>
        </div>
        ${quizFooterHTML}
      </section>
    `);
    
    // Call the new drag-and-drop setup function
    initializeDragAndDrop();
  }

  let lastFocused = null;
  function openProfile(sectionIdx, cardIdx){
    const d = SLIDES[sectionIdx].deep[cardIdx];
    const modal = document.getElementById('modal');
    const mBody = document.getElementById('m-body');
    const scrim = document.getElementById('scrim');
    const title = d.modalTitle || d.title;
    const baseBullets = (d.bullets||[]).map(b=>`<li>${b}</li>`).join('');
    const media = (d.media||[]).map(m=>`<li><a href="${m.href}" target="_blank" rel="noopener">${m.label}</a></li>`).join('');
    const extended = d.modalHTML || '';
    const extra = EXTRA[d.title] || [];
    const extraHTML = extra.length ? `<h4>Additional notes</h4><ul>${extra.map(x=>`<li>${x}</li>`).join('')}</ul>` : '';
    const summaryHTML = d.summary?`<p>${d.summary}</p>`:'';
    const bulletsHTML = baseBullets?`<h4>Key points</h4><ul>${baseBullets}</ul>`:'';
    const mediaHTML = media?`<h4>Media</h4><ul class="media">${media}</ul>`:'';
    document.getElementById('m-title').textContent = title;
    if (d.image) {
        mBody.className = 'modal-body split-layout';
        mBody.innerHTML = `<div class="modal-image-container"><img alt="${d.altText || d.title}" src="${d.image}"></div><div class="modal-text-container">${summaryHTML}${bulletsHTML}${extraHTML}${mediaHTML}${extended}</div>`;
    } else {
        mBody.className = 'modal-body';
        mBody.innerHTML = `${summaryHTML}${bulletsHTML}${extraHTML}${mediaHTML}${extended}`;
    }
    lastFocused = document.activeElement;
    document.body.classList.add('modal-open');
    scrim.classList.add('active');
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    document.getElementById('modalClose').focus();
  }
  function hideModal(){
    const modal = document.getElementById('modal');
    const scrim = document.getElementById('scrim');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    scrim.classList.remove('active');
    document.body.classList.remove('modal-open');
    if(lastFocused) lastFocused.focus();
  }
  
  function show(i){ 
    if(!slidesEls) slidesEls = document.getElementsByClassName('slide'); 
    if(i<0||i>=slidesEls.length) return; 
    Array.from(slidesEls).forEach(s=>s.style.display='none'); 
    slidesEls[i].style.display='block'; 
    ix=i; 
    window.scrollTo(0,0); 
  }

  async function go(i){ 
    if (!isPresenter) return;
    
    const totalSlides = document.getElementsByClassName('slide').length;
    if (i < 0 || i >= totalSlides) return;
    
    try {
        const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
        await setDoc(stateRef, { currentSlide: i }, { merge: true });
    } catch (error) {
        console.error("[Firebase Write Error] Failed to update slide state:", error);
    }
  }

  function toggleFull(i){ 
    const el=document.getElementById('full-'+i); 
    if(el) {
        el.hidden=!el.hidden;
        const button = el.parentElement.querySelector('.slide-actions button:nth-child(1)');
        if(button) {
            button.textContent = el.hidden ? 'Read Full Text' : 'Hide Full Text';
        }
    }
  }

  function toggleKeywords(i){ 
    const el=document.getElementById('keywords-'+i); 
    if(el) {
        el.hidden=!el.hidden;
        const button = el.parentElement.querySelector('.slide-actions button:nth-child(2)');
        if(button) {
            button.textContent = el.hidden ? 'Keywords' : 'Hide Keywords';
        }
    }
  }
  
  function initializeDragAndDrop() {
      document.addEventListener('dragstart', e => {
          if (e.target.matches('.instrument')) {
              e.dataTransfer.setData('text/plain', e.target.id);
              e.target.classList.add('dragging');
          }
      });

      document.addEventListener('dragend', e => {
          if (e.target.matches('.instrument')) {
              e.target.classList.remove('dragging');
          }
      });

      document.addEventListener('dragover', e => {
          const dropzone = e.target.closest('.band-area, .instrument-pool');
          if (dropzone) {
              e.preventDefault();
              dropzone.classList.add('drag-over');
          }
      });
      
      document.addEventListener('dragleave', e => {
           const dropzone = e.target.closest('.band-area, .instrument-pool');
           if (dropzone) {
              dropzone.classList.remove('drag-over');
           }
      });

      document.addEventListener('drop', e => {
          const zone = e.target.closest('.band-area, .instrument-pool');
          if (!zone) return;
          
          e.preventDefault();
          zone.classList.remove('drag-over');
          
          const draggableId = e.dataTransfer.getData('text/plain');
          const draggable = document.getElementById(draggableId);
          if (!draggable) return;

          const instrumentId = draggable.dataset.instrumentId;

          if (zone.classList.contains('instrument-pool')) {
              zone.appendChild(draggable);
              draggable.classList.remove('correct', 'incorrect');
              draggable.draggable = true;
          } else if (zone.dataset.accepts) {
              const acceptedTypes = JSON.parse(zone.dataset.accepts);
              if (acceptedTypes.includes(instrumentId) && !zone.querySelector('.instrument')) {
                  zone.appendChild(draggable);
                  draggable.classList.add('correct');
                  draggable.draggable = false;
              }
          }
      });
  }

  
  function toggleQnaPanel() {
    const nameOverlay = document.getElementById('name-entry-overlay');
    if(document.getElementById('session-overlay').classList.contains('hidden') && nameOverlay.classList.contains('hidden')){
      document.getElementById('qna-panel').classList.toggle('active');
      document.getElementById('scrim').classList.toggle('active');
    }
  }
  
  // --- ACCESSIBILITY & OTHER FUNCTIONS ---
  function toggleHighContrast() {
    document.body.classList.toggle('high-contrast-mode');
    const isHighContrast = document.body.classList.contains('high-contrast-mode');
    localStorage.setItem('highContrast', isHighContrast);
  }

  function readSlideAloud(slideIndex) {
    const btn = document.getElementById(`read-aloud-btn-${slideIndex}`);
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      if(btn) btn.textContent = '🔊 Read Aloud';
      return;
    }

    const slideEl = document.getElementById(`slide-${slideIndex}`);
    if (!slideEl) return;

    let textToRead = [];
    const title = slideEl.querySelector('h2');
    if (title) textToRead.push(title.textContent);

    const bullets = slideEl.querySelectorAll('.bullets li');
    if (bullets.length > 0) {
      textToRead.push("Bullet points:");
      bullets.forEach(li => textToRead.push(li.textContent));
    }
    
    const fullText = slideEl.querySelector('article.full');
    if (fullText && !fullText.hidden) {
       textToRead.push("Full text:");
       textToRead.push(fullText.textContent);
    }
    
    const images = slideEl.querySelectorAll('img');
    if (images.length > 0) {
      images.forEach((img, index) => {
        if(img.alt) {
          textToRead.push(`Image ${index + 1} description: ${img.alt}`);
        }
      });
    }
    
    const fullSpeech = textToRead.join('. ');
    const utterance = new SpeechSynthesisUtterance(fullSpeech);
    
    utterance.onstart = () => {
        if(btn) btn.textContent = '■ Stop Reading';
    };
    
    utterance.onend = () => {
        if(btn) btn.textContent = '🔊 Read Aloud';
    };

    speechSynthesis.speak(utterance);
  }

  function revealPollAnswer(pollId, correctIndex) {
    const pollEl = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollEl) return;
    const correctOption = pollEl.querySelectorAll('.poll-option')[correctIndex];
    if(correctOption) {
        correctOption.classList.add('correct-answer');
    }
  }

  // --- GLOBAL EVENT LISTENERS ---
  document.getElementById('modalClose').addEventListener('click', hideModal);
  document.getElementById('contrast-toggle-btn').addEventListener('click', toggleHighContrast);
  document.getElementById('scrim').addEventListener('click', ()=>{
      hideModal();
      if(document.getElementById('qna-panel').classList.contains('active')){
          toggleQnaPanel();
      }
  });
  document.addEventListener('keydown', (e)=>{ 
    if(e.key==='Escape') {
        hideModal();
        if(document.getElementById('qna-panel').classList.contains('active')){
          toggleQnaPanel();
        }
    }
    else if(e.key==='ArrowRight') go(ix+1); 
    else if(e.key==='ArrowLeft') go(ix-1); 
    else if(e.key==='Home') go(0); 
    else if(e.key==='End') go(document.getElementsByClassName('slide').length-1); 
  });

  document.addEventListener('DOMContentLoaded', ()=>{ 
    if (localStorage.getItem('highContrast') === 'true') {
      document.body.classList.add('high-contrast-mode');
    }
    initializeUserSession();
  });
  
  // --- WINDOW-SCOPED FUNCTIONS FOR HTML ---
  window.go = go;
  window.toggleFull = toggleFull;
  window.toggleKeywords = toggleKeywords;
  window.toggleFunFacts = toggleFunFacts;
  window.openProfile = openProfile;
  window.toggleProfile = toggleProfile;
  window.submitPollVote = submitPollVote;
  window.submitWord = submitWord;
  window.startOrAdvanceQuiz = startOrAdvanceQuiz;
  window.submitQuizAnswer = submitQuizAnswer;
  window.toggleQnaPanel = toggleQnaPanel;
  window.submitQuestion = submitQuestion;
  window.upvoteQuestion = upvoteQuestion;
  window.readSlideAloud = readSlideAloud;
  window.revealPollAnswer = revealPollAnswer;
  
</script>
</body>
</html>

/* Hide main content until the app is ready */
header.top, #main-content, #qna-fab {display: none;}
.app{max-width:980px;margin:0 auto;padding:1rem}
.slide{display:none;background:var(--card);border:1px solid var(--line);border-radius:.6rem;padding:1rem;margin:1rem 0}
.slide:first-of-type{display:block}
.slide-head{display:flex;align-items:baseline;justify-content:space-between;gap:.75rem;border-bottom:1px solid var(--line);padding-bottom:.4rem;margin-bottom:.6rem}
.slide h2{margin:.2rem 0;font-size:1.4rem}
.meter{color:var(--muted);font-size:.9rem}
.slide-body-with-aside { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start;}
.slide-body-main { flex: 3 1 400px; }
.slide-body-aside { flex: 1 1 200px; }
.slide-body-aside img { width: 100%; border-radius: .4rem; }
.bullets{margin:.6rem 0 1rem 1.1rem}
.bullets li{margin:.35rem 0}
.slide-actions{display:flex; gap:.5rem; flex-wrap:wrap;}
.read-btn,.nav-btn,.home-btn,.grade-btn{background:linear-gradient(90deg,var(--brand),#86e3ff);color:#08121f;border:0;font-weight:700;padding:.5rem .85rem;border-radius:.45rem;cursor:pointer}
.read-btn{background:#233046;color:var(--ink);border:1px solid var(--line)}
.full{margin:.75rem 0 .5rem 0;line-height:1.75;color:#d9e1ee}
.keywords-list {list-style-type: none; padding-left: 0;}
.keywords-list li { margin-bottom: .5rem; }
.deep-list{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin:1rem 0;list-style:none;padding:0}
.deep-item{width:100%;display:flex;justify-content:center}
.profile-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:800;padding:.55rem 1rem;border-radius:.55rem;cursor:pointer;min-width:min(520px,90%);text-align:center}
.profile-btn:hover{filter:brightness(.97)}
.profile-btn:focus{outline:2px solid #ffd16666;outline-offset:2px}
.slide-nav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-top:1rem;gap:.5rem}
.home-btn{justify-self:center;background:#334055;color:var(--ink);border:1px solid var(--line)}
.quiz-battle-container{display:flex;flex-wrap: wrap;gap:1.5rem;align-items:flex-start}
.quiz-main{flex:1 1 60%; min-width: 300px;}
.leaderboard{flex:1 1 35%; min-width: 280px; background:#131622;border-radius:.45rem;padding:1rem;border:1px solid var(--line)}
.leaderboard-list li{display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--line);align-items:center}
.leaderboard-list li:last-child{border-bottom:0}
.leaderboard-list .player-name{font-size:.9em;color:var(--muted)}
.leaderboard-list .correct-answers{font-size:.9em}
.leaderboard-list .score{font-weight:700;color:var(--brand);font-size:1.1em}
.quiz-question-area .q{padding:.6rem;border-bottom:1px dashed var(--line)}
.quiz-question-area .q:last-child{border-bottom:0}
.choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.35rem;margin-top:.35rem}
.choice-btn{display:flex;gap:.5rem;align-items:center;padding:.35rem .5rem;border-radius:.35rem;background:#131622;border:1px solid var(--line);color:var(--ink);font-size:1rem;width:100%;text-align:left;cursor:pointer}
.choice-btn.correct{border-color:rgba(6,214,160,.6);background:rgba(6,214,160,.08)}
.choice-btn.incorrect{border-color:rgba(239,71,111,.6);background:rgba(239,71,111,.07)}
.choice-btn:disabled{cursor:not-allowed;opacity:.7}
.quiz-controls button{margin-top:1rem}
#quiz-feedback{margin-top:1rem;font-weight:700}
#quiz-timer{font-size:1.8rem;font-weight:700;color:var(--accent);text-align:center;margin-bottom:1rem;padding:.5rem;background-color:rgba(255,209,102,.1);border-radius:.45rem}
#scrim{position:fixed;inset:0;display:none;background:rgba(0,0,0,.78);z-index:9998}
#scrim.active{display:block}
#modal{position:fixed;inset:0;display:none;place-items:center;z-index:9999;padding:1rem}
#modal.active{display:grid}
.modal-card{max-width:1100px;width:90%;background:#0f1420;border:1px solid var(--line);border-radius:.75rem;box-shadow:0 18px 60px rgba(0,0,0,.5);transform:scale(.97);opacity:0;transition:transform .2s ease,opacity .2s ease;max-height:85vh;display:flex;flex-direction:column}
#modal.active .modal-card{transform:scale(1);opacity:1}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;border-bottom:1px solid var(--line)}
.modal-head h3{margin:0;font-size:1.5rem}
.modal-body{padding:1.2rem;line-height:1.85;font-size:18px;overflow-y:auto}
.modal-body img{max-width:100%;height:auto;border-radius:.4rem;border:1px solid var(--line);margin:.6rem 0}
.modal-body.split-layout{display:flex;gap:1.5rem;align-items:flex-start}
.modal-body.split-layout > .modal-image-container{flex:0 0 300px;min-width:200px}
.modal-body.split-layout img{margin:0;width:100%}
.modal-body.split-layout > .modal-text-container{flex:1 1 auto}
.modal-body h4{margin:1rem 0 .4rem;font-size:1rem;color:#ffe08a}
.close{background:#2a3649;color:#e3eaf5;border:1px solid var(--line);padding:.4rem .8rem;border-radius:.45rem;cursor:pointer}
.interactive-section{margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--line)}
.interactive-section h3{color:var(--accent);margin-bottom:1rem}
.poll-option{position:relative;margin-bottom:.5rem;background:#131622;border-radius:.35rem;border:1px solid var(--line);overflow:hidden}
.poll-option button{width:100%;text-align:left;padding:.5rem .8rem .5rem 1rem;background:0 0;border:0;color:var(--ink);cursor:pointer;position:relative;z-index:2;box-sizing:border-box;padding-right:4rem;}
.poll-option button:disabled{cursor:not-allowed}
.poll-option.voted-for button{font-weight:700}
.poll-option.correct-answer { background: rgba(6, 214, 160, .1) !important; border: 1px solid rgba(6, 214, 160, .7); }
.poll-option.incorrect-answer { background: rgba(239, 71, 111, .1) !important; border: 1px solid rgba(239, 71, 111, .7); }
.poll-bar{position:absolute;top:0;left:0;height:100%;background:var(--brand);opacity:.2;transition:width .3s ease;z-index:1}
.poll-percent{position:absolute;right:.8rem;top:50%;transform:translateY(-50%);font-size:.9em;font-weight:700;color:var(--ink);z-index:2}
.build-a-band{display:flex;gap:1rem;flex-wrap:wrap}
.instrument-pool,.band-area{flex:1;min-width:250px;padding:1rem;border:2px dashed var(--line);border-radius:.6rem}
.band-area{background:rgba(89,208,255,.05)}
.instrument{padding:.5rem .8rem;background:var(--card);border:1px solid var(--line);border-radius:.4rem;cursor:grab;margin-bottom:.5rem;user-select:none}
.instrument.dragging { opacity: 0.5; }
.band-area.drag-over{border-color:var(--brand)}
.band-area .instrument.correct{border-left:4px solid #06d6a0}
.band-area .instrument.incorrect{border-left:4px solid #ef476f}
.word-cloud-container{display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start}
.word-cloud-input{flex:1;min-width:250px}
.word-cloud-display{flex:2;min-width:300px;min-height:200px;border:1px solid var(--line);border-radius:.6rem;padding:1rem;display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center;justify-content:center}
.word-cloud-display span{padding:.1rem .3rem}
.content-input-container{display:flex;gap:.5rem;margin-bottom:1rem}
.content-input{flex-grow:1;background:#131622;border:1px solid var(--line);color:var(--ink);padding:.5rem .8rem;border-radius:.45rem;font-size:1rem}
.add-content-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:700;padding:.5rem 1rem;border-radius:.45rem;cursor:pointer}
#qna-fab{position:fixed;bottom:1rem;right:1rem;z-index:100}
#qna-panel{position:fixed;top:0;right:0;width:min(450px, 100%);height:100%;background:var(--card);border-left:1px solid var(--line);z-index:10001;transform:translateX(100%);transition:transform .3s ease}
#qna-panel.active{transform:translateX(0)}
.qna-head{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
.qna-body{padding:1rem;height:calc(100% - 120px);overflow-y:auto}
.qna-footer{padding:1rem;border-top:1px solid var(--line)}
.qna-list li{display:flex;gap:.8rem;align-items:flex-start;padding:.8rem 0;border-bottom:1px solid var(--line)}
.qna-list li:last-child{border-bottom:0}
.upvote-btn{display:flex;flex-direction:column;align-items:center;background:0 0;border:1px solid var(--line);color:var(--ink);border-radius:.4rem;padding:.3rem;cursor:pointer}
.upvote-btn.voted{background:var(--brand);color:#08121f}
.upvote-btn:disabled{cursor:not-allowed}
.overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.85);z-index:10002;color:var(--ink)}
.overlay.hidden{display:none}
.overlay-card{background:var(--card);padding:2rem;border-radius:.75rem;width:min(400px, 90%);text-align:center}
.overlay-card h3{margin-top:0;font-size:1.5rem;color:var(--accent)}
.overlay-card input{width:100%;box-sizing:border-box;margin-bottom:1rem;text-align:center}
.overlay-card button{width:100%;margin-bottom:.5rem}
.overlay-card hr{border-color:var(--line);margin:1rem 0}
/* --- New 'Sparkle' Feature Styles --- */
.fun-facts { margin-top: 1rem; padding: 1rem; background: rgba(255, 209, 102, .05); border-left: 4px solid var(--accent); border-radius: .25rem; }
.fun-facts p { margin: .25rem 0; }
.fun-facts ul {padding-left: 1.2rem; margin: .5rem 0;}
.then-vs-now { display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center; align-items: flex-start; }
.then-vs-now-card { flex: 1; min-width: 250px; background: #131622; border: 1px solid var(--line); padding: 1rem; border-radius: .45rem; }
.then-vs-now-card h4 { margin-top: 0; color: var(--ink); }
.then-vs-now-card audio { width: 100%; margin-top: .5rem; }
.lyrics-content { white-space: pre-wrap; background: #0e0f12; padding: 1rem; border-radius: .45rem; margin-top: .5rem; }
#build-a-verse-container { display: flex; flex-wrap: wrap; gap: 1rem; }
.bav-col { flex: 1; min-width: 280px; }
.bav-cloud { min-height: 150px; border: 1px solid var(--line); border-radius: .45rem; padding: .5rem; display:flex; flex-wrap:wrap; gap: .25rem .5rem; align-items:center; justify-content:center; }
.bav-cloud span { padding: .1rem .3rem; }
#bav-result { margin-top: 1rem; font-family: 'Courier New', Courier, monospace; background: #131622; padding: 1rem; border-radius: .45rem; white-space: pre-wrap; }
.audio-player-container button { margin-right: .5rem;}
/* --- Accessibility Additions --- */
#accessibility-controls {
position: fixed;
top: .5rem;
right: .5rem;
z-index: 10003;
}
#contrast-toggle-btn {
background: #233046;
color: #e8ebf0;
border: 1px solid #262a35;
font-size: 1.2rem;
padding: .4rem .7rem;
border-radius: .45rem;
cursor: pointer;
line-height: 1;
}
.read-aloud-btn {
background: #233046;
color: #e8ebf0;
border: 1px solid var(--line);
padding: .3rem .6rem;
border-radius: .45rem;
cursor: pointer;
font-size: .8em;
}
body.high-contrast-mode {
--bg: #000000;
--ink: #ffffff;
--muted: #dddddd;
--card: #000000;
--line: #ffffff;
--brand: #ffff00;
--accent: #ffff00;
}
body.high-contrast-mode .profile-btn,
body.high-contrast-mode .add-content-btn {
background: var(--accent);
color: #000;
text-shadow: none;
}
body.high-contrast-mode a {
color: var(--accent);
}
body.high-contrast-mode #contrast-toggle-btn {
background-color: var(--bg);
border-color: var(--line);
color: var(--ink);
}
</style>
</head>
<body>
<div id="accessibility-controls">
<button id="contrast-toggle-btn" title="Toggle High Contrast Mode">♿</button>
</div>
<header class="top" id="main-header">
<div class="app brand">
<h1>Lesson 10: The Birth of Rock and Roll</h1>
<small>Use Next/Previous or ← → keys. Session ID: <b id="session-id-display"></b></small>
</div>
</header>
<main class="app" id="main-content">
<div id="slides" class="slides" aria-live="polite"></div>
</main>
<div id="scrim" aria-hidden="true"></div>
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="m-title" aria-hidden="true">
<div class="modal-card" role="document">
<div class="modal-head">
<h3 id="m-title"></h3>
<button class="close" id="modalClose">Close ✕</button>
</div>
<div id="m-body" class="modal-body"></div>
</div>
</div>
<div id="session-overlay" class="overlay hidden">
<div class="overlay-card">
<h3>Join a Session</h3>
<input type="text" id="session-input" class="content-input" placeholder="ENTER SESSION ID">
<button id="join-session-btn" class="read-btn" style="background:var(--brand);color:#08121f">Join</button>
<hr>
<button id="start-session-btn" class="read-btn" style="background: #06d6a0; color:#08121f">Start a New Session</button>
</div>
</div>
<div id="name-entry-overlay" class="overlay hidden">
<div class="overlay-card">
<h3>Welcome!</h3>
<p>Please enter your name to join the session.</p>
<input type="text" id="name-input" class="content-input" placeholder="Your Name or Nickname" required>
<button id="join-btn" class="add-content-btn">Join</button>
<a href="#" id="join-anonymously" style="color: var(--muted); font-size: 0.9em; display:block; margin-top: .5rem">or join anonymously</a>
</div>
</div>
<button id="qna-fab" class="profile-btn" onclick="toggleQnaPanel()">? Questions?</button>
<div id="qna-panel">
<div class="qna-head">
<h3>Live Q&A</h3>
<button class="close" onclick="toggleQnaPanel()">✕</button>
</div>
<div class="qna-body">
<ul id="qna-list" class="qna-list" style="list-style: none; padding: 0;"><li>No questions yet.</li></ul>
</div>
<div class="qna-footer">
<div class="content-input-container">
<input type="text" id="qna-input" class="content-input" placeholder="Ask a question...">
<button class="add-content-btn" onclick="submitQuestion()">Ask</button>
</div>
</div>
</div>
<script type="module">
// --- IMPORTS AND CONFIG ---
const firebaseConfig = {
apiKey: "AIzaSyDxpDj0axohHIFfRQ53NLWBQbf_yI2lJo0",
authDomain: "interactive-lecture-app.firebaseapp.com",
projectId: "interactive-lecture-app",
storageBucket: "interactive-lecture-app.firebasestorage.app",
messagingSenderId: "47230608512",
appId: "1:47230608512:web:ba649a4a9ba16cef1df265",
measurementId: "G-NDLP7MWFH9"
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc, updateDoc, increment, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

setLogLevel('debug');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- LOCAL STATE (Do not modify) ---
let userId = null;
let localUpvotes = new Set();
let userName = null;
let sessionId = null;
let sessionDataPath = null;
let isPresenter = false;
let ix = 0;
let slidesEls;
let timerInterval = null;
let timerStartTimeout = null;
let audioContext, mainGainNode, oscillator, isPlayingBlues = false;

// ==================================================================
// --- LESSON CONTENT ---
// ==================================================================

const SLIDES = [
{
"id": "10.00",
"title": "Lesson 10: The Birth of Rock and Roll",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"bullets": ["Watch this short video for an overview of this chapter's content."],
"full": `<div style='position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-top: 1rem;'><iframe src='https://player.vimeo.com/video/762001582?h=37c83ffa80' style='position: absolute; top: 0; left: 0; width: 100%; height: 100%;' frameborder='0' allow='fullscreen' allowfullscreen title='Chapter Synopsis Video'></iframe></div>`,
"deep": []
},
{
"id": "10.01",
"title": "10.01 Introduction",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"bullets": [
"In the early 1950s, multiple musical threads converged to create the earliest rock and roll.",
"Artists like Ray Charles, Chuck Berry, and Fats Domino wrote and recorded some of the first crossover hits.",
"White artists like Bill Haley and Pat Boone began covering black artists' songs, often achieving greater commercial success.",
"Technological changes, new musical forms, and shifts in consumption patterns reshaped American popular music."
],
"full": "In the early 1950s, many different musical threads came together to create the earliest rock and roll. Artists such as Ray Charles, Chuck Berry, and Fats Domino wrote and recorded some of the earliest crossover hits. Soon, white artists such as Bill Haley and the Comets and Pat Boone began recording cover versions of black artists' songs, most of which were more commercially successful than their black counterparts. Changes in technology, new and hybrid musical forms, and shifts in music consumption patterns all contributed to a reworking of the American popular music landscape that would forever alter the history of popular music consumption in the United States.",
"deep": []
},
{
"id": "10.02",
"title": "10.02 New Technologies and Means of Consumption",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"asideImage": "https://omp.s3.amazonaws.com/img/img_omp10_02_WurlitzerJukebox.jpg",
"bullets": [
"The <b>magnetic tape recorder</b> revolutionized music recording, allowing for editing, duplication, and cheaper production.",
"<b>45 RPM records</b> became the standard for pop singles, with each side playing for about 3-4 minutes.",
"The <b>transistor radio</b> (developed by Bell Labs in 1947) and car radios made music more portable and accessible.",
"<b>Top 40 radio format</b> emerged, playing the same forty songs every 24 hours with the top ten receiving the most airplay."
],
"full": "The magnetic recording process changed how music was recorded and distributed. Developed by the Germans to guide radio-controlled V-2 bombs, magnetic tape allowed for sound to be recorded, erased, and re-recorded on the same tape many times, allowed for recordings to be duplicated from tape to tape, allowed for recordings to be edited, and made recording much cheaper. Recording was no longer confined to gigantic and elaborate studios owned by the major companies in a few big cities. Tolerably decent recordings could now be made anywhere by untrained personnel who knew very little about engineering or acoustics. Around the same time, high fidelity 45 RPM technology exploded onto the scene. 45 RPMs were inexpensive to produce and to purchase. It was in the world of 45 RPM singles that rhythm and blues had its first great moment in pop music history. Music listening and consumption was also affected by the radio. The transistor radio, developed by Bell Laboratory in 1947, appeared on the market in the early 1950s. About the same time, the car radio became an affordable option in the automobile industry, and people began listening to the radio in their cars as well as in their homes. By the late 1940s and early 1950s, many popular talk, drama, and comedy radio programs had moved from radio to television, and radio programmers needed to find new material to fill the airtime. Several innovations in radio programming arose, the most important of which was the development of the Top 40 radio format. Top 40 became the new radio format. The same forty songs would be repeated every 24-hour radio cycle, and the top ten songs would receive more frequent play than the bottom thirty. Why forty tunes? Because the Wurlitzer jukeboxes, which flooded the industry at the time, contained forty recordings.",
"keywords": {
"Magnetic tape recorder": "Recording on magnetic tape allowed for sound to be recorded, erased, and re-recorded on the same tape many times, allowed for recordings to be duplicated from tape to tape, allowed for recordings to be edited, and made recording much cheaper.",
"45 RPM": "A record that plays at 45 revolutions per minute; had a limit of around three to four minutes per side.",
"Top 40": "A radio format where the same forty tunes were repeated every 24-hour radio cycle, and the top ten singles received the most airplay."
},
"deep": [],
"poll": {
"q": "Which technology allowed for music to be recorded, erased, and re-recorded on the same medium?",
"choices": ["Vinyl records", "Magnetic tape recorder", "Radio broadcasting", "CD technology"],
"answer": 1
}
},
{
"id": "10.03",
"title": "10.03 Alan Freed",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"asideImage": "https://omp.s3.amazonaws.com/blackboard/images/img_orm05_03_AlanFreed.jpg",
"bullets": [
"<b>Alan Freed</b> was the most influential disc jockey of early rock and roll, starting his career in Cleveland.",
"He transformed his classical program into <i>The Moondog Show</i>, featuring rhythm and blues by black artists.",
"Freed coined the term <b>rock and roll</b> (previously a euphemism for sex in African American music) to describe this music.",
"He organized massive rock and roll concerts, produced movies, and hosted TV shows before his career ended due to payola scandals."
],
"full": "With the rise of radio and top 40 radio, the disc jockey emerged as one of popular music's most important promoters. The most important disc jockey of the era, and indeed, one of the most important figures in the promotion of early rock and roll, was Alan Freed. Freed was the most influential disc jockey of early rock and roll. He began his radio career in 1946 in Akron, Ohio before moving to Cleveland in 1951. He soon transformed his evening classical-music program into The Moondog Show, which featured rhythm and blues records by black artists. He dubbed the music 'rock and roll'—a term used in African American music since the 1930s as a euphemism for sex—and the name stuck. The new music was a hit for teenagers, and Freed soon gained an immense radio following. In addition to champion rock and roll on the radio, Freed also organized rock and roll concerts that drew large crowd of both black and white teenagers. His success in Cleveland prompted a move to a larger market, and he began his new show, The Rock and Roll Party, on WINS in New York in 1954. Freed eventually organized a traveling concert show featuring Jerry Lee Lewis and Buddy Holly called The Big Beat, produced several rock-and-roll themed movies (including Rock Around the Clock (1956) and Don't Knock the Rock (1957)), and hosted a television show called Dance Party. His career ended on a sour note when he was the target of a Congressional investigation over receiving bribes in return for playing particular records. He was found guilty of bribery, or 'payola,' in 1962 and he died of kidney failure in 1965.",
"keywords": {
"Rock and roll": "Term used by Alan Freed to describe the rhythm and blues music of African American artists that he played on the radio."
},
"deep": [
{
"title": "Alan Freed (1921-1965)",
"image": "https://omp.s3.amazonaws.com/blackboard/images/img_orm05_03_AlanFreed.jpg",
"altText": "A photo of Alan Freed, the influential disc jockey who popularized rock and roll.",
"bullets": [
"Began his radio career in 1946 in Akron, Ohio before moving to Cleveland in 1951.",
"Transformed his classical program into The Moondog Show, featuring rhythm and blues records by black artists.",
"Coined the term 'rock and roll' to describe African American popular music.",
"Organized massive rock and roll concerts that drew crowds of both black and white teenagers.",
"Produced rock-and-roll themed movies including Rock Around the Clock and Don't Knock the Rock.",
"His career ended due to payola scandals, being found guilty of bribery in 1962."
],
"funFacts": [
"Freed's March 1953 concert sold 18,000 tickets for an auditorium with only 9,000 seats, leading to a riot.",
"By 1954, Freed was making nearly a million dollars a year from his radio show and sponsors.",
"He appeared in three movies: Don't Knock the Rock, Rock, Rock, Rock, and Rock Around the Clock.",
"Freed was listed as co-author on Chuck Berry's 'Maybellene' in exchange for promoting the record."
],
"media": [
{"label": "Watch: Alan Freed Introduction", "href": "https://www.youtube.com/watch?v=6HblkQJ7D-c"},
{"label": "Listen: Alan Freed Radio Show", "href": "https://www.youtube.com/watch?v=Q9b4aZ-1X_0"},
{"label": "Read More: Alan Freed Biography", "href": "https://rockhall.com/inductees/alan-freed/"}
]
}
],
"poll": {
"q": "What term did Alan Freed use to describe rhythm and blues music to make it more appealing to white audiences?",
"choices": ["Pop music", "Race records", "Rock and roll", "Soul music"],
"answer": 2
}
},
{
"id": "10.04",
"title": "10.04 Cover Versions",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"bullets": [
"White artists began releasing <b>cover versions</b> of black artists' songs to make them more appropriate for white audiences.",
"Sexual references in original black versions were muted, modified, or deleted entirely in cover versions.",
"<b>Pat Boone</b> exemplified the sanitized cover approach with his versions of 'Ain't That a Shame,' 'Long Tall Sally,' and 'Tutti Frutti.'",
"<b>Bill Haley</b> was one of the first white artists to achieve commercial success with crossover versions of rhythm and blues songs."
],
"full": "Teenagers may have loved rhythm and blues lyrics such as 'I got a girl named Sue, she knows just what to do' (from Little Richard's 'Tutti Frutti') and 'You're wearin those dresses, the sun comes shinin' through / I can't believe my eyes, all of this belongs to you' (from Big Joe Turner's 'Shake, Rattle, and Roll'), but parents, record companies, and radio stations were less than impressed. In response, white artists and record companies began releasing cover versions of black artists' songs. In general, a cover version refers to a song that is re-recorded by another artist. During the age of early rock and roll, however, these cover versions had a very specific purpose: to modify black artists' rhythm and blues songs in order to make them more appropriate for white audiences. The sexual references in the original black version were muted, modified, or deleted entirely. Recordings by the squeaky-clean white singer Pat Boone exemplify the goals of early cover versions. Boone's covers of 'Ain't That a Shame' (Fats Domino), 'Long Tall Sally' (Little Richard), and 'Tutti Frutti' (Little Richard) were all more commercially successful than the original black versions. Bill Haley was one of the first white artists to achieve commercial success with crossover versions of rhythm and blues songs. His version of 'Shake, Rattle, and Roll' (1954) was a sanitized version of Big Joe Turner's original, and his recording of 'Rock Around the Clock' (1955) was the first rock-and-roll recording to become a number one hit on the pop charts.",
"keywords": {
"Cover version": "A song that is re-recorded by another artist. In the 1950s, these were often sanitized versions of black artists' rhythm and blues songs made for white audiences."
},
"deep": [
{
"title": "Pat Boone (b. 1934)",
"image": "https://omp.s3.amazonaws.com/blackboard/images/img_orm05_04_PatBoone.jpg",
"altText": "A photo of Pat Boone, the clean-cut singer known for his cover versions of rhythm and blues songs.",
"bullets": [
"Born in Jacksonville, Florida, Boone was a clean-cut, white singer who became a teen idol in the 1950s.",
"His cover versions of rhythm and blues songs were often more commercially successful than the original black versions.",
"Notable covers include 'Ain't That a Shame' (Fats Domino), 'Long Tall Sally' (Little Richard), and 'Tutti Frutti' (Little Richard).",
"Boone's versions typically removed or toned down sexual references and made the music more palatable for white audiences.",
"He had 38 Top 40 hits between 1955 and 1962, making him one of the most successful artists of the era."
],
"funFacts": [
"Pat Boone sold over 45 million records, had 38 Top 40 hits, and appeared in more than 12 Hollywood movies.",
"He was a descendant of American pioneer Daniel Boone.",
"In 1957, he was the second biggest charting artist, behind only Elvis Presley.",
"Boone's version of 'Tutti Frutti' sold over a million copies, while Little Richard's original sold around 500,000."
]
},
{
"title": "Bill Haley (1925-1981)",
"image": "https://omp.s3.amazonaws.com/blackboard/images/img_orm05_04_BillHaley.jpg",
"altText": "A photo of Bill Haley, one of the first white artists to achieve commercial success with rock and roll.",
"bullets": [
"Born in Highland Park, Michigan, Haley was a country and western singer before transitioning to rock and roll.",
"His band, Bill Haley and His Comets, was one of the first rock and roll groups to achieve mainstream success.",
"Haley's version of 'Shake, Rattle, and Roll' (1954) was a sanitized version of Big Joe Turner's original.",
"His recording of 'Rock Around the Clock' (1955) was the first rock-and-roll recording to become a number one hit on the pop charts.",
"The song gained even more popularity when featured in the 1955 film 'Blackboard Jungle'."
],
"funFacts": [
"'Rock Around the Clock' is often cited as the song that brought rock and roll into mainstream culture worldwide.",
"Bill Haley was nearly 30 years old when he recorded 'Rock Around the Clock,' making him older than most rock and roll pioneers.",
"He was one of the first musicians to be inducted into the Rock and Roll Hall of Fame in 1987.",
"Haley's trademark was his distinctive spit-curl hairstyle, which became his visual signature."
]
}
],
"thenVsNow": {
"title": "Cover Versions: Then vs. Now",
"then": {
"title": "1950s Covers",
"description": "In the 1950s, cover versions were primarily used to sanitize black music for white audiences, removing sexual references and making the music more palatable to mainstream tastes.",
"examples": ["Pat Boone's 'Tutti Frutti'", "Bill Haley's 'Shake, Rattle, and Roll'", "The Crew-Cuts' 'Sh-Boom'"]
},
"now": {
"title": "Modern Covers",
"description": "Today, cover versions are often artistic reinterpretations or tributes to original works, sometimes completely transforming the song's genre or style.",
"examples": ["Johnny Cash's 'Hurt' (Nine Inch Nails cover)", "Jeff Buckley's 'Hallelujah' (Leonard Cohen cover)", "Whitney Houston's 'I Will Always Love You' (Dolly Parton cover)"]
}
},
"poll": {
"q": "What was the primary purpose of cover versions in the 1950s?",
"choices": ["To pay tribute to original artists", "To make songs more appropriate for white audiences", "To create new musical genres", "To make songs longer for radio play"],
"answer": 1
}
},
{
"id": "10.05",
"title": "10.05 The Rock and Roll Business",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"bullets": [
"The rise of rock and roll created new business opportunities and challenges for the music industry.",
"Independent record labels like <b>Chess</b>, <b>Sun</b>, and <b>Specialty</b> played a crucial role in discovering and promoting early rock and roll artists.",
"The <b>payola scandal</b> of the late 1950s involved disc jockeys accepting bribes to play certain records.",
"Congressional hearings on payola led to tighter regulations and the decline of many influential disc jockeys like Alan Freed."
],
"full": "The rise of rock and roll created new business opportunities and challenges for the music industry. Independent record labels such as Chess, Sun, and Specialty played a crucial role in discovering and promoting early rock and roll artists. These labels were often more willing to take risks on new and unconventional artists than the major labels. The payola scandal of the late 1950s involved disc jockeys accepting bribes to play certain records. Congressional hearings on payola led to tighter regulations and the decline of many influential disc jockeys, including Alan Freed. Despite these challenges, rock and roll continued to grow in popularity, and by the end of the 1950s, it had become the dominant form of popular music in the United States.",
"keywords": {
"Payola": "The practice of paying radio stations to play particular songs without disclosing the payment to listeners."
},
"deep": [
{
"title": "Independent Record Labels",
"image": "https://omp.s3.amazonaws.com/blackboard/images/img_orm05_09_ChessRecords.jpg",
"altText": "The Chess Records building in Chicago, an important independent label for early rock and roll.",
"bullets": [
"Chess Records (Chicago): Founded by Leonard and Phil Chess, specialized in blues and R&B. Artists: Chuck Berry, Bo Diddley, Muddy Waters.",
"Sun Records (Memphis): Founded by Sam Phillips, known for rockabilly and early rock and roll. Artists: Elvis Presley, Jerry Lee Lewis, Carl Perkins, Johnny Cash.",
"Specialty Records (Los Angeles): Founded by Art Rupe, focused on gospel, R&B, and rock and roll. Artists: Little Richard, Lloyd Price, Larry Williams.",
"Atlantic Records (New York): Founded by Ahmet Ertegun and Herb Abramson, became a major force in R&B and soul. Artists: Ray Charles, The Coasters, The Drifters."
],
"funFacts": [
"Sam Phillips of Sun Records famously said: 'If I could find a white man who had the Negro sound and the Negro feel, I could make a billion dollars.' He found Elvis Presley.",
"Chess Records was originally called Aristocrat Records before being renamed in 1950.",
"Specialty Records owner Art Rupe was known for his keen ear for hit songs and carefully crafted the sound of his recordings.",
"Atlantic Records began as a small independent label operating out of a hotel room before becoming one of the most successful labels in music history."
]
}
],
"poll": {
"q": "What was the name of the scandal involving disc jockeys accepting bribes to play certain records?",
"choices": ["Watergate scandal", "Payola scandal", "Teapot Dome scandal", "Credit Mobilier scandal"],
"answer": 1
}
},
{
"id": "10.06",
"title": "10.06 Quiz Battle: The Birth of Rock and Roll",
"headerImage": "https://i.imgur.com/UYkSNXp.png",
"bullets": [
"Test your knowledge of the birth of rock and roll with this 10-question quiz battle!",
"Compete against your classmates to see who can answer the most questions correctly in the shortest time.",
"Questions cover key artists, technologies, and historical developments from this chapter.",
"Good luck, and may the best rock historian win!"
],
"full": "This quiz battle will test your knowledge of the birth of rock and roll. You'll answer 10 questions covering the key artists, technologies, and historical developments discussed in this chapter. The quiz is timed, so try to answer as quickly as possible while maintaining accuracy. Your score will be based on both correctness and speed. Compete against your classmates to see who can achieve the highest score!",
"quiz": [
{
"q": "Which technology allowed for sound to be recorded, erased, and re-recorded on the same medium?",
"choices": ["Vinyl records", "Magnetic tape recorder", "Radio broadcasting", "CD technology"],
"answer": 1
},
{
"q": "What term did Alan Freed use to describe rhythm and blues music to make it more appealing to white audiences?",
"choices": ["Pop music", "Race records", "Rock and roll", "Soul music"],
"answer": 2
},
{
"q": "What was the primary purpose of cover versions in the 1950s?",
"choices": ["To pay tribute to original artists", "To make songs more appropriate for white audiences", "To create new musical genres", "To make songs longer for radio play"],
"answer": 1
},
{
"q": "What was the name of the scandal involving disc jockeys accepting bribes to play certain records?",
"choices": ["Watergate scandal", "Payola scandal", "Teapot Dome scandal", "Credit Mobilier scandal"],
"answer": 1
},
{
"q": "Which radio format played the same forty songs every 24 hours with the top ten receiving the most airplay?",
"choices": ["Freeform radio", "Top 40", "Album-oriented rock", "Talk radio"],
"answer": 1
}
],
"deep": []
}
];

// --- FIREBASE AUTHENTICATION ---
async function initAuth() {
try {
if (initialAuthToken) {
await signInWithCustomToken(auth, initialAuthToken);
} else {
await signInAnonymously(auth);
}
} catch (error) {
console.error("Auth error:", error);
}
}

onAuthStateChanged(auth, (user) => {
if (user) {
userId = user.uid;
document.getElementById("session-overlay").classList.add("hidden");
document.getElementById("name-entry-overlay").classList.remove("hidden");
} else {
console.log("User signed out");
}
});

// --- SESSION MANAGEMENT ---
function showErrorMessage(message) {
const errorModal = document.createElement("div");
errorModal.className = "overlay";
errorModal.innerHTML = `
<div class="overlay-card">
<h3>Error</h3>
<p>${message}</p>
<button onclick="this.parentElement.parentElement.remove()" class="read-btn">OK</button>
</div>
`;
document.body.appendChild(errorModal);
}

function generateSessionId() {
return Math.random().toString(36).substring(2, 8).toUpperCase();
}

async function createNewSession() {
sessionId = generateSessionId();
sessionDataPath = `sessions/${sessionId}`;

await setDoc(doc(db, sessionDataPath, "meta"), {
createdAt: new Date(),
createdBy: userId,
appId: appId
});

document.getElementById("session-id-display").textContent = sessionId;
document.getElementById("session-overlay").classList.add("hidden");
document.getElementById("name-entry-overlay").classList.remove("hidden");
}

async function joinSession() {
const inputSessionId = document.getElementById("session-input").value.trim().toUpperCase();
if (!inputSessionId) return showErrorMessage("Please enter a session ID");

const sessionDoc = await getDoc(doc(db, `sessions/${inputSessionId}`, "meta"));
if (!sessionDoc.exists()) {
return showErrorMessage("Session not found. Please check the ID and try again.");
}

sessionId = inputSessionId;
sessionDataPath = `sessions/${sessionId}`;
document.getElementById("session-id-display").textContent = sessionId;
document.getElementById("session-overlay").classList.add("hidden");
document.getElementById("name-entry-overlay").classList.remove("hidden");
}

async function joinWithName() {
const nameInput = document.getElementById("name-input").value.trim();
if (!nameInput) return showErrorMessage("Please enter your name");

userName = nameInput;
await setDoc(doc(db, sessionDataPath, "users", userId), {
name: userName,
joinedAt: new Date()
});

document.getElementById("name-entry-overlay").classList.add("hidden");
document.querySelector("header.top").style.display = "block";
document.getElementById("main-content").style.display = "block";
document.getElementById("qna-fab").style.display = "block";

initSlides();
initQnaListener();
initLeaderboardListener();
}

async function joinAnonymously() {
userName = "Anonymous";
await setDoc(doc(db, sessionDataPath, "users", userId), {
name: userName,
joinedAt: new Date(),
anonymous: true
});

document.getElementById("name-entry-overlay").classList.add("hidden");
document.querySelector("header.top").style.display = "block";
document.getElementById("main-content").style.display = "block";
document.getElementById("qna-fab").style.display = "block";

initSlides();
initQnaListener();
initLeaderboardListener();
}

// --- SLIDE MANAGEMENT ---
function initSlides() {
const slidesContainer = document.getElementById("slides");
slidesContainer.innerHTML = "";

SLIDES.forEach((slideData, index) => {
const slideEl = createSlideElement(slideData, index);
slidesContainer.appendChild(slideEl);
});

slidesEls = document.querySelectorAll(".slide");
updateSlideMeter();

// Set up keyboard navigation
document.addEventListener("keydown", (e) => {
if (e.key === "ArrowRight") nextSlide();
if (e.key === "ArrowLeft") prevSlide();
});
}

function createSlideElement(slideData, index) {
const slideEl = document.createElement("div");
slideEl.className = "slide";
slideEl.id = `slide-${slideData.id}`;

const slideHead = document.createElement("div");
slideHead.className = "slide-head";

const titleEl = document.createElement("h2");
titleEl.textContent = slideData.title;

const meterEl = document.createElement("div");
meterEl.className = "meter";
meterEl.textContent = `${index + 1} of ${SLIDES.length}`;

slideHead.appendChild(titleEl);
slideHead.appendChild(meterEl);

const slideBody = document.createElement("div");

if (slideData.headerImage) {
const headerImg = document.createElement("img");
headerImg.src = slideData.headerImage;
headerImg.alt = "";
headerImg.style = "width: 100%; border-radius: .4rem; margin-bottom: 1rem;";
slideBody.appendChild(headerImg);
}

if (slideData.bullets && slideData.bullets.length) {
const bulletsEl = document.createElement("ul");
bulletsEl.className = "bullets";

slideData.bullets.forEach(bullet => {
const li = document.createElement("li");
li.innerHTML = bullet;
bulletsEl.appendChild(li);
});

slideBody.appendChild(bulletsEl);
}

// Create body with optional aside layout
if (slideData.asideImage) {
const bodyWithAside = document.createElement("div");
bodyWithAside.className = "slide-body-with-aside";

const mainContent = document.createElement("div");
mainContent.className = "slide-body-main";

if (slideData.full) {
const fullEl = document.createElement("div");
fullEl.className = "full";
fullEl.innerHTML = slideData.full;
mainContent.appendChild(fullEl);
}

const asideContent = document.createElement("div");
asideContent.className = "slide-body-aside";

const asideImg = document.createElement("img");
asideImg.src = slideData.asideImage;
asideImg.alt = "";
asideContent.appendChild(asideImg);

bodyWithAside.appendChild(mainContent);
bodyWithAside.appendChild(asideContent);

slideBody.appendChild(bodyWithAside);
} else if (slideData.full) {
const fullEl = document.createElement("div");
fullEl.className = "full";
fullEl.innerHTML = slideData.full;
slideBody.appendChild(fullEl);
}

// Add keywords if present
if (slideData.keywords) {
const keywordsSection = document.createElement("div");
keywordsSection.style.marginTop = "1.5rem";
keywordsSection.innerHTML = "<h3>Key Terms</h3>";

const keywordsList = document.createElement("ul");
keywordsList.className = "keywords-list";

for (const [term, description] of Object.entries(slideData.keywords)) {
const li = document.createElement("li");
li.innerHTML = `<b>${term}:</b> ${description}`;
keywordsList.appendChild(li);
}

keywordsSection.appendChild(keywordsList);
slideBody.appendChild(keywordsSection);
}

// Add interactive sections
const interactiveSection = document.createElement("div");
interactiveSection.className = "interactive-section";

// Polls
if (slideData.poll) {
const pollSection = document.createElement("div");
pollSection.className = "poll-section";
pollSection.id = `poll-${slideData.id}`;
pollSection.innerHTML = `<h3>Poll: ${slideData.poll.q}</h3>`;
const choicesContainer = document.createElement("div");
choicesContainer.className = "poll-choices";

slideData.poll.choices.forEach((choice, choiceIndex) => {
const pollOption = document.createElement("div");
pollOption.className = "poll-option";
const choiceBtn = document.createElement("button");
choiceBtn.textContent = choice;
choiceBtn.onclick = () => submitPoll(slideData.id, choiceIndex);
pollOption.appendChild(choiceBtn);
pollOption.appendChild(document.createElement("div")).className = "poll-bar";
pollOption.appendChild(document.createElement("span")).className = "poll-percent";
choicesContainer.appendChild(pollOption);
});

pollSection.appendChild(choicesContainer);
interactiveSection.appendChild(pollSection);
}

// Then vs Now
if (slideData.thenVsNow) {
const thenVsNowEl = document.createElement("div");
thenVsNowEl.className = "then-vs-now";
thenVsNowEl.innerHTML = `<h3>${slideData.thenVsNow.title}</h3>`;

const thenCard = document.createElement("div");
thenCard.className = "then-vs-now-card";
thenCard.innerHTML = `<h4>${slideData.thenVsNow.then.title}</h4><p>${slideData.thenVsNow.then.description}</p>`;
const thenList = document.createElement("ul");
slideData.thenVsNow.then.examples.forEach(ex => {
const li = document.createElement("li");
li.textContent = ex;
thenList.appendChild(li);
});
thenCard.appendChild(thenList);

const nowCard = document.createElement("div");
nowCard.className = "then-vs-now-card";
nowCard.innerHTML = `<h4>${slideData.thenVsNow.now.title}</h4><p>${slideData.thenVsNow.now.description}</p>`;
const nowList = document.createElement("ul");
nowList.className = "keywords-list"; // re-using class to remove bullets
slideData.thenVsNow.now.examples.forEach(ex => {
const li = document.createElement("li");
li.textContent = ex;
nowList.appendChild(li);
});
nowCard.appendChild(nowList);

thenVsNowEl.appendChild(thenCard);
thenVsNowEl.appendChild(nowCard);

interactiveSection.appendChild(thenVsNowEl);
}

// Quiz Battle
if (slideData.quiz) {
const quizSection = document.createElement("div");
quizSection.className = "quiz-battle-container";
quizSection.innerHTML = `
<div class="quiz-main">
<h3>Quiz Battle</h3>
<p>Get ready for a timed quiz! Your score is based on correctness and speed.</p>
<button class="nav-btn" id="start-quiz-btn">Start Quiz</button>
<div id="quiz-area" style="display:none;">
<div id="quiz-timer"></div>
<div id="quiz-question-area"></div>
<div class="quiz-controls">
<button class="nav-btn" id="next-q-btn" style="display:none;">Next Question</button>
</div>
</div>
<div id="quiz-feedback"></div>
</div>
<div class="leaderboard">
<h4>Leaderboard</h4>
<ul id="leaderboard-list" class="leaderboard-list"></ul>
</div>
`;
interactiveSection.appendChild(quizSection);
}

slideBody.appendChild(interactiveSection);

// Deep dive button
if (slideData.deep && slideData.deep.length > 0) {
const deepDiveButton = document.createElement("button");
deepDiveButton.className = "read-btn";
deepDiveButton.textContent = "Read More...";
deepDiveButton.onclick = () => openDeepDive(slideData.id);
slideBody.appendChild(deepDiveButton);
}

slideEl.appendChild(slideHead);
slideEl.appendChild(slideBody);

const slideNav = document.createElement("div");
slideNav.className = "slide-nav";

const prevBtn = document.createElement("button");
prevBtn.className = "nav-btn";
prevBtn.textContent = "Previous";
prevBtn.onclick = prevSlide;

const nextBtn = document.createElement("button");
nextBtn.className = "nav-btn";
nextBtn.textContent = "Next";
nextBtn.onclick = nextSlide;

const homeBtn = document.createElement("button");
homeBtn.className = "home-btn";
homeBtn.textContent = "Home";
homeBtn.onclick = () => showSlide(0);

slideNav.appendChild(prevBtn);
slideNav.appendChild(homeBtn);
slideNav.appendChild(nextBtn);

slideEl.appendChild(slideNav);

return slideEl;
}

function updateSlideMeter() {
slidesEls.forEach((slide, index) => {
const meterEl = slide.querySelector(".meter");
if (meterEl) {
meterEl.textContent = `${index + 1} of ${SLIDES.length}`;
}
});
}

function showSlide(index) {
if (index < 0 || index >= SLIDES.length) return;

// Hide all slides
slidesEls.forEach(slide => slide.style.display = "none");

// Show the target slide
slidesEls[index].style.display = "block";
ix = index;

// Handle specific slide logic
if (SLIDES[ix].quiz) {
initQuiz();
}
}

function nextSlide() {
showSlide(ix + 1);
}

function prevSlide() {
showSlide(ix - 1);
}

// --- MODAL AND DEEP DIVE ---
const modal = document.getElementById("modal");
const modalClose = document.getElementById("modalClose");
const modalTitle = document.getElementById("m-title");
const modalBody = document.getElementById("m-body");
const scrim = document.getElementById("scrim");

function openModal() {
modal.classList.add("active");
scrim.classList.add("active");
document.body.classList.add("modal-open");
}

function closeModal() {
modal.classList.remove("active");
scrim.classList.remove("active");
document.body.classList.remove("modal-open");
modalBody.innerHTML = "";
modalTitle.textContent = "";
}

modalClose.onclick = closeModal;
scrim.onclick = closeModal;

async function openDeepDive(slideId) {
const slideData = SLIDES.find(s => s.id === slideId);
if (!slideData || !slideData.deep || slideData.deep.length === 0) return;

const deepData = slideData.deep[0]; // Assuming only one deep dive per slide for now

modalTitle.textContent = deepData.title;
modalBody.innerHTML = "";
modalBody.className = "modal-body split-layout";

const imageContainer = document.createElement("div");
imageContainer.className = "modal-image-container";
const imgEl = document.createElement("img");
imgEl.src = deepData.image;
imgEl.alt = deepData.altText || "Image related to the topic";
imageContainer.appendChild(imgEl);
modalBody.appendChild(imageContainer);

const textContainer = document.createElement("div");
textContainer.className = "modal-text-container";

const bulletsList = document.createElement("ul");
bulletsList.style.listStyle = "disc";
deepData.bullets.forEach(bullet => {
const li = document.createElement("li");
li.textContent = bullet;
bulletsList.appendChild(li);
});
textContainer.appendChild(bulletsList);

if (deepData.funFacts && deepData.funFacts.length > 0) {
const funFactsEl = document.createElement("div");
funFactsEl.className = "fun-facts";
funFactsEl.innerHTML = "<h4>Fun Facts</h4>";
const factsList = document.createElement("ul");
deepData.funFacts.forEach(fact => {
const li = document.createElement("li");
li.textContent = fact;
factsList.appendChild(li);
});
funFactsEl.appendChild(factsList);
textContainer.appendChild(funFactsEl);
}

if (deepData.media && deepData.media.length > 0) {
const mediaSection = document.createElement("div");
mediaSection.innerHTML = "<h4>Media & Further Reading</h4>";
const mediaList = document.createElement("ul");
mediaList.style.listStyle = "none";
mediaList.style.padding = "0";
deepData.media.forEach(mediaItem => {
const li = document.createElement("li");
const a = document.createElement("a");
a.href = mediaItem.href;
a.textContent = mediaItem.label;
a.target = "_blank";
a.rel = "noopener noreferrer";
li.appendChild(a);
mediaList.appendChild(li);
});
mediaSection.appendChild(mediaList);
textContainer.appendChild(mediaSection);
}

modalBody.appendChild(textContainer);

openModal();
}

// --- Q&A Panel ---
const qnaPanel = document.getElementById("qna-panel");
const qnaList = document.getElementById("qna-list");

function toggleQnaPanel() {
qnaPanel.classList.toggle("active");
}

async function submitQuestion() {
const qnaInput = document.getElementById("qna-input");
const question = qnaInput.value.trim();
if (!question) return;

try {
await addDoc(collection(db, sessionDataPath, "qna"), {
question: question,
userId: userId,
userName: userName,
upvotes: 0,
createdAt: new Date()
});
qnaInput.value = "";
} catch (e) {
console.error("Error adding question: ", e);
}
}

function initQnaListener() {
const q = query(collection(db, sessionDataPath, "qna"), orderBy("upvotes", "desc"), orderBy("createdAt", "desc"));
onSnapshot(q, (querySnapshot) => {
qnaList.innerHTML = "";
if (querySnapshot.empty) {
const li = document.createElement("li");
li.textContent = "No questions yet.";
qnaList.appendChild(li);
return;
}
querySnapshot.forEach((doc) => {
const data = doc.data();
const li = document.createElement("li");
li.innerHTML = `
<div style="flex:1;">
<strong>${data.userName}:</strong> ${data.question}
</div>
<button class="upvote-btn ${localUpvotes.has(doc.id) ? 'voted' : ''}" data-id="${doc.id}">
▲
<span>${data.upvotes}</span>
</button>
`;
qnaList.appendChild(li);
});

qnaList.querySelectorAll(".upvote-btn").forEach(btn => {
btn.onclick = (e) => upvoteQuestion(e.currentTarget.dataset.id);
});
});
}

async function upvoteQuestion(docId) {
if (localUpvotes.has(docId)) {
console.log("Already upvoted this question.");
return;
}

localUpvotes.add(docId);

try {
await updateDoc(doc(db, sessionDataPath, "qna", docId), {
upvotes: increment(1)
});
} catch (e) {
console.error("Error upvoting question: ", e);
localUpvotes.delete(docId);
}
}

// --- QUIZ BATTLE ---
let quizData = [];
let currentQuestionIndex = 0;
let quizStartTime = 0;
let quizActive = false;
let correctAnswers = 0;
let currentQuizDocId = null;

async function initQuiz() {
const slideData = SLIDES[ix];
if (!slideData.quiz) return;

quizData = slideData.quiz;
currentQuestionIndex = 0;
correctAnswers = 0;

const startBtn = document.getElementById("start-quiz-btn");
const nextBtn = document.getElementById("next-q-btn");
const quizArea = document.getElementById("quiz-area");
const feedbackEl = document.getElementById("quiz-feedback");

if (startBtn) {
startBtn.onclick = startQuiz;
startBtn.style.display = "block";
}
quizArea.style.display = "none";
nextBtn.style.display = "none";
feedbackEl.textContent = "";
}

async function startQuiz() {
if (!sessionDataPath) {
return showErrorMessage("Please join a session before starting the quiz.");
}
const quizDocRef = doc(collection(db, sessionDataPath, "quizzes"));
currentQuizDocId = quizDocRef.id;

await setDoc(quizDocRef, {
userId: userId,
userName: userName,
startedAt: new Date(),
score: 0,
answers: {}
});

document.getElementById("start-quiz-btn").style.display = "none";
document.getElementById("quiz-area").style.display = "block";

quizActive = true;
quizStartTime = Date.now();
startQuizTimer();
showQuestion();
}

function startQuizTimer() {
const timerEl = document.getElementById("quiz-timer");
timerEl.textContent = "00:00";

timerInterval = setInterval(() => {
const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
const seconds = String(elapsed % 60).padStart(2, '0');
timerEl.textContent = `${minutes}:${seconds}`;
}, 1000);
}

function showQuestion() {
const qArea = document.getElementById("quiz-question-area");
const nextBtn = document.getElementById("next-q-btn");
const feedbackEl = document.getElementById("quiz-feedback");

qArea.innerHTML = "";
feedbackEl.textContent = "";
nextBtn.style.display = "none";

if (currentQuestionIndex >= quizData.length) {
endQuiz();
return;
}

const qData = quizData[currentQuestionIndex];

const qEl = document.createElement("div");
qEl.className = "q";
qEl.innerHTML = `<h4>${currentQuestionIndex + 1}. ${qData.q}</h4>`;

const choicesEl = document.createElement("div");
choicesEl.className = "choices";

qData.choices.forEach((choice, index) => {
const choiceBtn = document.createElement("button");
choiceBtn.className = "choice-btn";
choiceBtn.textContent = choice;
choiceBtn.onclick = () => submitAnswer(index);
choicesEl.appendChild(choiceBtn);
});

qEl.appendChild(choicesEl);
qArea.appendChild(qEl);
}

async function submitAnswer(userChoice) {
if (!quizActive) return;

const qData = quizData[currentQuestionIndex];
const isCorrect = userChoice === qData.answer;

if (isCorrect) {
correctAnswers++;
}

const choiceButtons = document.querySelectorAll("#quiz-question-area .choice-btn");
choiceButtons.forEach((btn, index) => {
btn.disabled = true;
if (index === qData.answer) {
btn.classList.add("correct");
} else if (index === userChoice) {
btn.classList.add("incorrect");
}
});

const feedbackEl = document.getElementById("quiz-feedback");
feedbackEl.textContent = isCorrect ? "Correct!" : "Incorrect!";
feedbackEl.style.color = isCorrect ? "#06d6a0" : "#ef476f";

// Update Firestore with the answer
const answerPath = `answers.q${currentQuestionIndex}`;
await updateDoc(doc(db, sessionDataPath, "quizzes", currentQuizDocId), {
score: increment(isCorrect ? 1 : 0),
[answerPath]: {
question: qData.q,
userChoice: qData.choices[userChoice],
correctAnswer: qData.choices[qData.answer],
isCorrect: isCorrect
}
});

// Move to next question after a delay
setTimeout(() => {
currentQuestionIndex++;
showQuestion();
}, 1500);
}

async function endQuiz() {
quizActive = false;
clearInterval(timerInterval);

const qArea = document.getElementById("quiz-question-area");
const feedbackEl = document.getElementById("quiz-feedback");
const timerEl = document.getElementById("quiz-timer");

qArea.innerHTML = "";
feedbackEl.textContent = `Quiz Finished! You got ${correctAnswers} out of ${quizData.length} correct.`;

await updateDoc(doc(db, sessionDataPath, "quizzes", currentQuizDocId), {
totalScore: correctAnswers,
finishedAt: new Date()
});
}

function initLeaderboardListener() {
if (!sessionDataPath) return; // Prevent listener from running if no session is active
const q = query(collection(db, sessionDataPath, "quizzes"), orderBy("score", "desc"), orderBy("finishedAt"));
onSnapshot(q, (querySnapshot) => {
const leaderboardList = document.getElementById("leaderboard-list");
leaderboardList.innerHTML = "";
querySnapshot.forEach((doc) => {
const data = doc.data();
const li = document.createElement("li");
li.innerHTML = `
<span class="player-name">${data.userName}</span>
<span class="score">${data.score || 0}</span>
`;
leaderboardList.appendChild(li);
});
});
}

// --- POLLS ---
async function submitPoll(slideId, choiceIndex) {
const pollId = `poll-${slideId}`;
const pollRef = doc(db, sessionDataPath, "polls", pollId);

const choicePath = `choices.c${choiceIndex}`;

try {
const pollDoc = await getDoc(pollRef);
if (pollDoc.exists()) {
const data = pollDoc.data();
if (data.voters && data.voters[userId]) {
console.log("User already voted on this poll.");
return;
}
}

const updateData = {
[choicePath]: increment(1),
[`voters.${userId}`]: true
};

await setDoc(pollRef, updateData, { merge: true });

} catch (e) {
console.error("Error submitting poll vote: ", e);
}
}

function initPollListener() {
if (!sessionDataPath) return; // Prevent listener from running if no session is active
SLIDES.forEach(slide => {
if (slide.poll) {
const pollId = `poll-${slide.id}`;
const pollRef = doc(db, sessionDataPath, "polls", pollId);
onSnapshot(pollRef, (docSnap) => {
if (!docSnap.exists()) return;

const data = docSnap.data();
const totalVotes = Object.values(data.choices || {}).reduce((a, b) => a + b, 0);
const pollContainer = document.getElementById(pollId);
if (!pollContainer) return;

const pollOptions = pollContainer.querySelectorAll(".poll-option");

pollOptions.forEach((option, index) => {
const votes = data.choices && data.choices[`c${index}`] ? data.choices[`c${index}`] : 0;
const percent = totalVotes > 0 ? (votes / totalVotes) * 100 : 0;

const bar = option.querySelector(".poll-bar");
bar.style.width = `${percent}%`;

const percentageText = option.querySelector(".poll-percent");
percentageText.textContent = `${Math.round(percent)}%`;

const button = option.querySelector("button");

if (data.voters && data.voters[userId]) {
button.disabled = true;
if (index === slide.poll.answer) {
option.classList.add("correct-answer");
} else if (data.votedFor && data.votedFor[userId] === index) {
option.classList.add("incorrect-answer");
}
}
});
});
}
});
}

// --- ACCESSIBILITY ---
const contrastBtn = document.getElementById("contrast-toggle-btn");
contrastBtn.onclick = () => {
document.body.classList.toggle("high-contrast-mode");
};

// --- STARTUP ---
document.addEventListener("DOMContentLoaded", () => {
document.getElementById("join-session-btn").onclick = joinSession;
document.getElementById("start-session-btn").onclick = createNewSession;
document.getElementById("join-btn").onclick = joinWithName;
document.getElementById("join-anonymously").onclick = joinAnonymously;

initAuth();
});
</script>
</body>
</html>

