<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lesson 9 — Doo-Wop and Rhythm and Blues</title>
<style>
  :root{--bg:#0e0f12;--ink:#e8ebf0;--muted:#b6bdc9;--card:#161821;--line:#262a35;--brand:#59d0ff;--accent:#ffd166}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 'Segoe UI',system-ui,Roboto,sans-serif}
  a {color: var(--accent);}
  body.modal-open{overflow:hidden}
  /* Hide main content until the app is ready */
  header.top, #main-content, #qna-fab {display: none;}
  .app{max-width:980px;margin:0 auto;padding:1rem}

  .slide{display:none;background:var(--card);border:1px solid var(--line);border-radius:.6rem;padding:1rem;margin:1rem 0}
  .slide:first-of-type{display:block}
  .slide-head{display:flex;align-items:baseline;justify-content:space-between;gap:.75rem;border-bottom:1px solid var(--line);padding-bottom:.4rem;margin-bottom:.6rem}
  .slide h2{margin:.2rem 0;font-size:1.4rem}
  .meter{color:var(--muted);font-size:.9rem}
  .bullets{margin:.6rem 0 1rem 1.1rem}
  .bullets li{margin:.35rem 0}
  .slide-actions{display:flex; gap:.5rem; flex-wrap:wrap;}
  .read-btn,.nav-btn,.home-btn,.grade-btn{background:linear-gradient(90deg,var(--brand),#86e3ff);color:#08121f;border:0;font-weight:700;padding:.5rem .85rem;border-radius:.45rem;cursor:pointer}
  .read-btn{background:#233046;color:var(--ink);border:1px solid var(--line)}
  .full{margin:.75rem 0 .5rem 0;line-height:1.75;color:#d9e1ee}
  .keywords-list {list-style-type: none; padding-left: 0;}
  .keywords-list li { margin-bottom: .5rem; }

  .deep-list{display:flex;flex-direction:column;align-items:center;gap:.6rem;margin:1rem 0;list-style:none;padding:0}
  .deep-item{width:100%;display:flex;justify-content:center}
  .profile-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:800;padding:.55rem 1rem;border-radius:.55rem;cursor:pointer;min-width:min(520px,90%);text-align:center}
  .profile-btn:hover{filter:brightness(.97)}
  .profile-btn:focus{outline:2px solid #ffd16666;outline-offset:2px}

  .slide-nav{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-top:1rem;gap:.5rem}
  .home-btn{justify-self:center;background:#334055;color:var(--ink);border:1px solid var(--line)}

  .quiz-battle-container{display:flex;gap:1.5rem;align-items:flex-start}
  .quiz-main{flex:1 1 60%}
  .leaderboard{flex:1 1 35%;background:#131622;border-radius:.45rem;padding:1rem;border:1px solid var(--line)}
  .leaderboard-list li{display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--line);align-items:center}
  .leaderboard-list li:last-child{border-bottom:0}
  .leaderboard-list .player-name{font-size:.9em;color:var(--muted)}
  .leaderboard-list .correct-answers{font-size:.9em}
  .leaderboard-list .score{font-weight:700;color:var(--brand);font-size:1.1em}
  .quiz-question-area .q{padding:.6rem;border-bottom:1px dashed var(--line)}
  .quiz-question-area .q:last-child{border-bottom:0}
  .choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.35rem;margin-top:.35rem}
  .choice-btn{display:flex;gap:.5rem;align-items:center;padding:.35rem .5rem;border-radius:.35rem;background:#131622;border:1px solid var(--line);color:var(--ink);font-size:1rem;width:100%;text-align:left;cursor:pointer}
  .choice-btn.correct{border-color:rgba(6,214,160,.6);background:rgba(6,214,160,.08)}
  .choice-btn.incorrect{border-color:rgba(239,71,111,.6);background:rgba(239,71,111,.07)}
  .choice-btn:disabled{cursor:not-allowed;opacity:.7}
  .quiz-controls button{margin-top:1rem}
  #quiz-feedback{margin-top:1rem;font-weight:700}
  #quiz-timer{font-size:1.8rem;font-weight:700;color:var(--accent);text-align:center;margin-bottom:1rem;padding:.5rem;background-color:rgba(255,209,102,.1);border-radius:.45rem}

  #scrim{position:fixed;inset:0;display:none;background:rgba(0,0,0,.78);z-index:9998}
  #scrim.active{display:block}
  #modal{position:fixed;inset:0;display:none;place-items:center;z-index:9999;padding:1rem}
  #modal.active{display:grid}
  .modal-card{max-width:1100px;width:90%;background:#0f1420;border:1px solid var(--line);border-radius:.75rem;box-shadow:0 18px 60px rgba(0,0,0,.5);transform:scale(.97);opacity:0;transition:transform .2s ease,opacity .2s ease;max-height:85vh;display:flex;flex-direction:column}
  #modal.active .modal-card{transform:scale(1);opacity:1}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;border-bottom:1px solid var(--line)}
  .modal-head h3{margin:0;font-size:1.5rem}
  .modal-body{padding:1.2rem;line-height:1.85;font-size:18px;overflow-y:auto}
  .modal-body img{max-width:100%;height:auto;border-radius:.4rem;border:1px solid var(--line);margin:.6rem 0}
  .modal-body.split-layout{display:flex;gap:1.5rem;align-items:flex-start}
  .modal-body.split-layout > .modal-image-container{flex:0 0 300px;min-width:200px}
  .modal-body.split-layout img{margin:0;width:100%}
  .modal-body.split-layout > .modal-text-container{flex:1 1 auto}
  .modal-body h4{margin:1rem 0 .4rem;font-size:1rem;color:#ffe08a}
  .close{background:#2a3649;color:#e3eaf5;border:1px solid var(--line);padding:.4rem .8rem;border-radius:.45rem;cursor:pointer}

  .interactive-section{margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--line)}
  .interactive-section h3{color:var(--accent);margin-bottom:1rem}

  .poll-option{position:relative;margin-bottom:.5rem;background:#131622;border-radius:.35rem;border:1px solid var(--line);overflow:hidden}
  .poll-option button{width:100%;text-align:left;padding:.5rem .8rem;background:0 0;border:0;color:var(--ink);cursor:pointer;position:relative;z-index:2}
  .poll-option button:disabled{cursor:not-allowed}
  .poll-option.voted-for button{font-weight:700}
  .poll-option.correct-answer { background: rgba(6, 214, 160, .1) !important; border: 1px solid rgba(6, 214, 160, .7); }
  .poll-bar{position:absolute;top:0;left:0;height:100%;background:var(--brand);opacity:.2;transition:width .3s ease;z-index:1}
  .poll-percent{position:absolute;right:.8rem;top:50%;transform:translateY(-50%);font-size:.9em;font-weight:700;color:var(--ink);z-index:2}

  .build-a-band{display:flex;gap:1rem;flex-wrap:wrap}
  .instrument-pool,.band-area{flex:1;min-width:250px;padding:1rem;border:2px dashed var(--line);border-radius:.6rem}
  .band-area{background:rgba(89,208,255,.05)}
  .instrument{padding:.5rem .8rem;background:var(--card);border:1px solid var(--line);border-radius:.4rem;cursor:grab;margin-bottom:.5rem;user-select:none}
  .instrument:active{cursor:grabbing;background:#262a35}
  .band-area.drag-over{border-color:var(--brand)}
  .band-area .instrument.correct{border-left:4px solid #06d6a0}
  .band-area .instrument.incorrect{border-left:4px solid #ef476f}

  .word-cloud-container{display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start}
  .word-cloud-input{flex:1;min-width:250px}
  .word-cloud-display{flex:2;min-width:300px;min-height:200px;border:1px solid var(--line);border-radius:.6rem;padding:1rem;display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center;justify-content:center}
  .word-cloud-display span{padding:.1rem .3rem}
  .content-input-container{display:flex;gap:.5rem;margin-bottom:1rem}
  .content-input{flex-grow:1;background:#131622;border:1px solid var(--line);color:var(--ink);padding:.5rem .8rem;border-radius:.45rem;font-size:1rem}
  .add-content-btn{background:linear-gradient(90deg,var(--accent),#ffe08a);color:#08121f;border:0;font-weight:700;padding:.5rem 1rem;border-radius:.45rem;cursor:pointer}
  
  #qna-fab{position:fixed;bottom:1rem;right:1rem;z-index:100}
  #qna-panel{position:fixed;top:0;right:0;width:min(450px, 100%);height:100%;background:var(--card);border-left:1px solid var(--line);z-index:10001;transform:translateX(100%);transition:transform .3s ease}
  #qna-panel.active{transform:translateX(0)}
  .qna-head{display:flex;justify-content:space-between;align-items:center;padding:.8rem 1rem;border-bottom:1px solid var(--line)}
  .qna-body{padding:1rem;height:calc(100% - 120px);overflow-y:auto}
  .qna-footer{padding:1rem;border-top:1px solid var(--line)}
  .qna-list li{display:flex;gap:.8rem;align-items:flex-start;padding:.8rem 0;border-bottom:1px solid var(--line)}
  .qna-list li:last-child{border-bottom:0}
  .upvote-btn{display:flex;flex-direction:column;align-items:center;background:0 0;border:1px solid var(--line);color:var(--ink);border-radius:.4rem;padding:.3rem;cursor:pointer}
  .upvote-btn.voted{background:var(--brand);color:#08121f}
  .upvote-btn:disabled{cursor:not-allowed}

  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.85);z-index:10002;color:var(--ink)}
  .overlay.hidden{display:none}
  .overlay-card{background:var(--card);padding:2rem;border-radius:.75rem;width:min(400px, 90%);text-align:center}
  .overlay-card h3{margin-top:0;font-size:1.5rem;color:var(--accent)}
  .overlay-card input{width:100%;box-sizing:border-box;margin-bottom:1rem;text-align:center}
  .overlay-card button{width:100%;margin-bottom:.5rem}
  .overlay-card hr{border-color:var(--line);margin:1rem 0}

  /* --- Accessibility Additions --- */
  #accessibility-controls {
    position: fixed;
    top: .5rem;
    right: .5rem;
    z-index: 10003;
  }
  #contrast-toggle-btn {
    background: #233046;
    color: #e8ebf0;
    border: 1px solid #262a35;
    font-size: 1.2rem;
    padding: .4rem .7rem;
    border-radius: .45rem;
    cursor: pointer;
    line-height: 1;
  }
  .read-aloud-btn {
    background: #233046;
    color: #e8ebf0;
    border: 1px solid #262a35;
    padding: .3rem .6rem;
    border-radius: .45rem;
    cursor: pointer;
    font-size: .8em;
  }
  
  body.high-contrast-mode {
    --bg: #000000;
    --ink: #ffffff;
    --muted: #dddddd;
    --card: #000000;
    --line: #ffffff;
    --brand: #ffff00;
    --accent: #ffff00;
  }
  body.high-contrast-mode .profile-btn,
  body.high-contrast-mode .add-content-btn {
    background: var(--accent);
    color: #000;
    text-shadow: none;
  }
   body.high-contrast-mode a {
    color: var(--accent);
   }
   body.high-contrast-mode #contrast-toggle-btn {
    background-color: var(--bg);
    border-color: var(--line);
    color: var(--ink);
   }
</style>
</head>
<body>
  <div id="accessibility-controls">
    <button id="contrast-toggle-btn" title="Toggle High Contrast Mode">♿</button>
  </div>

  <header class="top" id="main-header">
    <div class="app brand">
      <h1>Lesson 9: Doo-Wop and Rhythm and Blues</h1>
      <small>Use Next/Previous or ← → keys. Session ID: <b id="session-id-display"></b></small>
    </div>
  </header>
  <main class="app" id="main-content">
    <div id="slides" class="slides" aria-live="polite"></div>
  </main>

  <div id="scrim" aria-hidden="true"></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="m-title" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="m-title"></h3>
        <button class="close" id="modalClose">Close ✕</button>
      </div>
      <div id="m-body" class="modal-body"></div>
    </div>
  </div>
  
  <div id="session-overlay" class="overlay hidden">
    <div class="overlay-card">
      <h3>Join a Session</h3>
      <input type="text" id="session-input" class="content-input" placeholder="ENTER SESSION ID">
      <button id="join-session-btn" class="read-btn" style="background:var(--brand);color:#08121f">Join</button>
      <hr>
      <button id="start-session-btn" class="read-btn" style="background: #06d6a0; color:#08121f">Start a New Session</button>
    </div>
  </div>

  <div id="name-entry-overlay" class="overlay hidden">
    <div class="overlay-card">
        <h3>Welcome!</h3>
        <p>Please enter your name to join the session.</p>
        <input type="text" id="name-input" class="content-input" placeholder="Your Name or Nickname" required>
        <button id="join-btn" class="add-content-btn">Join</button>
        <a href="#" id="join-anonymously" style="color: var(--muted); font-size: 0.9em; display:block; margin-top: .5rem">or join anonymously</a>
    </div>
  </div>

  <button id="qna-fab" class="profile-btn" onclick="toggleQnaPanel()">? Questions?</button>
  <div id="qna-panel">
    <div class="qna-head">
      <h3>Live Q&A</h3>
      <button class="close" onclick="toggleQnaPanel()">✕</button>
    </div>
    <div class="qna-body">
      <ul id="qna-list" class="qna-list" style="list-style: none; padding: 0;"><li>No questions yet.</li></ul>
    </div>
    <div class="qna-footer">
      <div class="content-input-container">
        <input type="text" id="qna-input" class="content-input" placeholder="Ask a question...">
        <button class="add-content-btn" onclick="submitQuestion()">Ask</button>
      </div>
    </div>
  </div>

<script type="module">
  // --- IMPORTS AND CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyDxpDj0axohHIFfRQ53NLWBQbf_yI2lJo0",
    authDomain: "interactive-lecture-app.firebaseapp.com",
    projectId: "interactive-lecture-app",
    storageBucket: "interactive-lecture-app.firebasestorage.app",
    messagingSenderId: "47230608512",
    appId: "1:47230608512:web:ba649a4a9ba16cef1df265",
    measurementId: "G-NDLP7MWFH9"
  };
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, getDoc, updateDoc, increment, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // --- LOCAL STATE (Do not modify) ---
  let userId = null;
  let localUpvotes = new Set();
  let userName = null;
  let sessionId = null;
  let sessionDataPath = null;
  let isPresenter = false; 
  let ix = 0; 
  let slidesEls;
  let timerInterval = null;
  let timerStartTimeout = null;
  
  // ==================================================================
  // --- LESSON CONTENT ---
  // ==================================================================
  
  const SLIDES = [
    {
        "id": "9.00",
        "title": "Lesson 9: Doo-Wop and Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": ["Watch this short video for an overview of this chapter's content."],
        "full": "<div style='position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; margin-top: 1rem;'><iframe src='https://vimeo.com/762001491' style='position: absolute; top: 0; left: 0; width: 100%; height: 100%;' frameborder='0' allow='fullscreen' allowfullscreen title='Chapter Synopsis Video'></iframe></div>",
        "deep": []
    },
    {
        "id": "9.01",
        "title": "9.01 Introduction",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "In the 1940s and 1950s, while white audiences listened to traditional pop, black audiences enjoyed gospel, doo-wop, and rhythm and blues.",
            "These genres were categorized by record companies as 'race records' and later as 'rhythm and blues'.",
            "This music began reaching white audiences due to technological advances in radio, which had no 'color lines'."
        ],
        "full": "While white audiences were listening to the sounds of Frank Sinatra, Patti Page, and Perry Como in the 1940s and 1950s, black listeners were consuming gospel music, doo-wop, and rhythm and blues. Although all of these genres are related to earlier styles of African American music, such as the blues, ragtime, and jazz, they all have specific features that make them unique. These sacred and secular genres were lumped together by record companies, first on race records and then on rhythm and blues, which was the new industry label for music that was created by and marketed to blacks. Technological advances in recording and broadcasting made it easier and easier to access music. As we will see, there were no color lines on the radio, which meant that white listeners began listening to rhythm and blues.",
        "deep": []
    },
    {
        "id": "9.02",
        "title": "9.02 Gospel Music",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
         "bullets": [
            "During the <b>Great Migration</b>, churches became essential community centers for African Americans moving to the urban North.",
            "<b>Gospel Music</b>, the soundtrack for these churches, featured instrumental accompaniment and improvisation.",
            "It was influenced by the <b>Holiness-Pentecostal Movement</b>, which encouraged enthusiastic congregational participation.",
            "Gospel singing often features <b>melisma</b>, a technique where a singer performs many different pitches on a single syllable of text."
        ],
        "full": "During the Great Migration, many African Americans moved from the rural South to the urban North. As people sought new community, churches became essential centers, and their soundtrack was gospel music. Gospel was almost always performed with instrumental accompaniment like piano or organ, and later guitars and drums. It borrowed from popular music forms and was influenced by religious movements like the Holiness-Pentecostal movement, which encouraged enthusiastic congregational participation and expression. A common vocal feature is the melisma, where a single syllable of text is sung over many different pitches. The father of traditional gospel is Thomas A. Dorsey, who blended blues and jazz idioms with sacred lyrics. His music was initially rejected by some churches for its secular sound but became so popular that new gospel songs were often called 'Dorseys.' He and singer Mahalia Jackson promoted his music on street corners, and his song 'Precious Lord, Take My Hand' became an anthem of the Civil Rights Movement.",
        "keywords": {
            "Great Migration": "The movement of many African Americans from the rural South to the urban North in search of better work and quality of life between the First and Second World Wars.",
            "Gospel Music": "A style of religious music that was almost always performed with instrumental accompaniment and featured improvisation, call and response, and melismatic singing.",
            "Holiness-Pentecostal Movement": "A religious movement that encouraged congregational participation and expression, heavily influencing the performance style of gospel music.",
            "Melisma": "A single syllable of text that includes many different pitches, a common and expressive gesture in gospel singing."
        },
        "deep": [
              {
                "title": "Thomas A. Dorsey (1899-1993)",
                "image": "https://i.imgur.com/smPGy0i.jpeg",
                "altText": "A black and white photo of Thomas A. Dorsey, the father of black gospel music, sitting at a piano.",
                "bullets": [
                    "Began as a blues pianist known as “Georgia Tom.”",
                    "Combined blues/jazz idioms with sacred lyrics.",
                    "His style was initially rejected by churches for its secular sound.",
                    "Promoted his music with singer Mahalia Jackson, selling sheet music on street corners.",
                    "Composed the classic 'Precious Lord, Take My Hand,' which became an anthem of the Civil Rights Movement."
                ],
                "media": [
                    {"label": "Read More: About Thomas Dorsey", "href": "https://www.pbs.org/thisfarbyfaith/people/thomas_dorsey.html"},
                    {"label": "Listen: 'Precious Lord, Take My Hand'", "href": "https://open.spotify.com/track/2BPMz5V0g0uw9phgqjY7se?si=c7249f9f9d5a4c83"},
                    {"label": "Watch: Aretha Franklin sings at Mahalia Jackson's funeral", "href": "https://youtu.be/aiFlfAs4Ifg?si=CPxFNV4WZfkMZCr-"}
                ]
              }
        ]
    },
    {
        "id": "9.03",
        "title": "9.03 Vocal Harmony Groups (Doo-Wop)",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "<b>Doo-wop</b> groups, often called 'street corner groups,' were popular after WWII, typically featuring four male singers.",
            "The name comes from their use of <b>vocables</b>—non-semantic syllables like 'doo-doo-wop'—that provided a rhythmic background.",
            "A common technique was <b>blow harmony</b>, where a singer would blow into the mic while singing 'ooh-wee' to create a percussive sound.",
            "Early groups like The Ink Spots had crossover appeal, recording for major labels and performing in major venues."
        ],
        "full": "Vocal harmony groups were popular both before and after World War II, singing a mixture of popular music, folk songs, and religious music. After WWII, these groups were often called 'street corner groups' as their style was common in urban African American neighborhoods. They came to be known as <b>Doo-wop</b> groups because they frequently used <b>vocables</b>, or non-semantic syllables like 'doo-doo-wop', to create rhythmic drive. Another technique was <b>blow harmony</b>, which was the result of a singer simultaneously blowing into the microphone and singing 'ooh-wee, ooh-wee.' These two features are the most recognizable characteristics of doo-wop music. The song 'Sh'boom' by The Chords is a classic example of the up-tempo doo-wop style.",
        "keywords": {
            "Doo-wop": "A style of vocal harmony music that emerged from 'street corner groups' in urban African American neighborhoods after WWII, incorporating harmonies from jazz and blues.",
            "Vocables": "Non-semantic syllables (e.g., 'doo-doo-wop') added to songs that provided rhythmic drive and a standard phrase for background singers.",
            "Blow harmony": "A common doo-wop gesture where a singer would simultaneously blow into the microphone and sing 'ooh-wee, ooh-wee.'"
        },
        "deep": [
            {
                "title": "The Ink Spots",
                "image": "https://i.imgur.com/FBDjnuG.jpeg",
                "altText": "A photo of the four members of The Ink Spots vocal group in matching suits."
            },
            {
                "title": "The Chords",
                "image": "https://i.imgur.com/S0Chlya.jpeg",
                "altText": "A photo of the five members of The Chords doo-wop group.",
                "media": [{"label": "Listen: 'Sh'boom (Life Could Be A Dream)'", "href": "https://open.spotify.com/track/0mWb7GqTPkzCkNsZ1XLOgw?si=b5526cb41ffb4cf4"}]
            }
        ],
        "poll": {
            "q": "The name 'doo-wop' comes from what musical feature?",
            "choices": ["The sound of the drums", "A popular dance move", "Syllables of text the groups sang", "The name of the most popular group"],
            "answer": 2
        }
    },
    {
        "id": "9.04",
        "title": "9.04 Early Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "In 1949, Billboard renamed its 'race records' chart to 'rhythm and blues,' a catchall term for various Black music genres.",
            "As large swing orchestras declined after WWII, smaller combos playing <b>jump blues</b> became popular.",
            "<b>Jump blues</b> featured a 12-bar blues form, boogie-woogie bass lines, strong backbeats, and <b>shuffle rhythms</b>.",
            "Louis Jordan and his Tympany Five were pioneers of this style, scoring crossover hits that appealed to both black and white audiences."
        ],
        "full": "The term 'race records' was officially replaced by 'rhythm and blues' on the Billboard charts in 1949. This was a catchall term for African American music. After WWII, large swing orchestras declined in popularity, and smaller combos rose. One of the first to capitalize on this was Louis Jordan, whose band The Tympany Five played in a style called <b>jump blues</b>. This style featured a 12-bar blues form, boogie woogie bass, strong backbeats, and <b>shuffle rhythms</b>. Jordan’s upbeat, humorous, and high-energy songs had crossover appeal to both black and white audiences and served as an important precursor to rock and roll.",
        "keywords": {
            "Jump blues": "A style of African American music that featured a 12-bar blues form, boogie woogie bass, strong back beats, shuffle rhythms, and group singing during the choruses.",
            "Shuffle rhythms": "A rhythm common in early rhythm and blues that consisted of a triplet quarter note followed by a triplet eighth note."
        },
        "deep": [
            {
                "title": "Louis Jordan (1908-1975)",
                "image": "https://i.imgur.com/N1ugU9q.jpeg",
                "altText": "A charismatic photo of Louis Jordan playing the saxophone.",
                "fullText": "One of the most influential rhythm and blues performers of the 1940s, Louis Jordan founded the Tympani Five in 1938. His band adapted the lively tempos of swing music to a smaller group, a style called jump blues. With their heavy boogie rhythms, strong backbeat, and preference for humor, songs such as “Saturday Night Fish Fry” and “Ain’t Nobody Here But Us Chickens” rocketed up the charts, appealing to black and white audiences alike. His high-energy performances and charismatic stage presence would be adapted by rock and roll artists of the 1950s.",
                "bullets": [
                    "Founded the Tympani Five, a popular 'jump blues' band.",
                    "His records consistently occupied the race records charts throughout the 1940s.",
                    "His music had crossover appeal, reaching both pop and R&B charts.",
                    "His style heavily influenced the first generation of rock and roll artists."
                ],
                "media": [
                    {"label": "Listen: 'Is You Is, Or Is You Ain't Ma Baby?'", "href": "https://open.spotify.com/track/09rSNL11dDpPjZEAIQVPka?si=dca8e15a705d4a4e"},
                    {"label": "Listen: 'Let the Good Times Roll'", "href": "https://open.spotify.com/track/50y6y3iwBlKKev2U4a6GK5?si=264b998eaf8e432c"},
                    {"label": "Watch: 'Saturday Night Fish Fry'", "href": "https://youtu.be/FCkFrff__QE?si=7iRTMvpIu1EsHK6U"}
                ]
            },
            {
              "title": "Then and Now: The Influence of Jump Blues",
              "fullText": "The high-energy, horn-driven sound of Louis Jordan's jump blues directly influenced not only early rock and roll but also the swing revival movement of the 1990s. Listen to the similarities in instrumentation, rhythmic drive, and showmanship.",
              "media": [
                  {"label": "Then: Louis Jordan - 'Choo Choo Ch'Boogie'", "href": "https://open.spotify.com/track/4vPJK1gKyygRS2mep7iyDq?si=813209c5ebb343ca"},
                  {"label": "Now: Brian Setzer Orchestra - 'Jump, Jive, an' Wail'", "href": "https://open.spotify.com/track/2atCRcyJp3f93a3A9a2iN5?si=89bb74b34b154e1a"}
              ]
            }
        ]
    },
    {
        "id": "9.05",
        "title": "9.05 From Gospel to Rhythm and Blues",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "Ray Charles was a pivotal artist who masterfully blended gospel music with secular R&B lyrics.",
            "Losing his sight at age seven, he learned to read and write music in Braille.",
            "He controversially adapted gospel songs into R&B hits: 'I Got a Savior' became 'I Got a Woman.'",
            "Charles was an innovator, being among the first to use the Fender Rhodes electric piano and forming the Raelets, a model for later girl groups."
        ],
        "full": "One of the first artists to move freely between gospel music and rhythm and blues and achieve commercial success was Ray Charles. Wrapping the sounds and rhythms of black gospel music around traditional secular lyrics made him one of the most influential musicians of the twentieth century. In 1952, Charles signed with Atlantic and began recording songs that freely blended gospel with rhythm and blues. Although some listeners were shocked at Charles’s combination of sacred and secular genres into this new style of 'gospel blues,' he saw no reason to separate them. His combinations often took the form of adapting the melodies and lyrics of gospel songs into electrifying rhythm and blues numbers.",
        "deep": [
            {
                "title": "Ray Charles (1930-2004)",
                "image": "https://i.imgur.com/Wvbi6AU.jpeg",
                "altText": "A classic photo of Ray Charles at the piano, wearing his signature sunglasses.",
                "fullText": "Ray Charles Robinson lost his sight due to glaucoma at age 6. He learned to play a number of instruments at the St. Augustine School for the Deaf and Blind and began his career as a traveling musician at 15. In 1952 he signed with Atlantic Records and scored his first hit with “I Got A Woman” in late 1954. Combining the soulful vocal style and call-and-response of gospel music with the sexual overtones and energy of R&B, the song ushered in the new style of soul music. His musical diversity has influenced countless performers and earned him inductions into multiple halls of fame.",
                "bullets": [
                    "Blinded by glaucoma at age 6.",
                    "Signed with Atlantic Records in 1952.",
                    "His 1954 hit 'I Got A Woman' helped pioneer the genre of soul music.",
                    "His call-and-response with his backup singers, the Raelets, became a signature part of his sound."
                ],
                "media": [
                    {"label": "Listen: 'I Got a Woman'", "href": "https://open.spotify.com/track/2xar08Fq5xra2KKZs5Bw9j?si=6284a2faf7c04c66"},
                    {"label": "Listen: 'What'd I Say'", "href": "https://open.spotify.com/track/5yQ9iMZXGcr5rlO4hoLsP4?si=81aa1f6106a24add"}
                ]
            },
            {
              "title": "Then and Now: The Influence of Gospel on R&B",
              "fullText": "Ray Charles's controversial but brilliant fusion of gospel's passion with secular themes paved the way for soul music and continues to influence modern R&B and pop artists who draw on gospel vocal techniques and chord progressions.",
              "media": [
                  {"label": "Then: Ray Charles - 'I Got a Woman'", "href": "https://open.spotify.com/track/2xar08Fq5xra2KKZs5Bw9j?si=6284a2faf7c04c66"},
                  {"label": "Now: John Legend - 'All of Me'", "href": "https://open.spotify.com/track/3U4isOIWM3VvDubwSI3y7a?si=b307409244fd4a31"}
              ]
            }
        ]
    },
    {
        "id": "9.06",
        "title": "9.06 Rhythm and Blues Crosses Over",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "A <b>crossover</b> hit is a song that charts on at least two of the three main charts: pop, R&B, and country.",
            "Chuck Berry, a father of rock and roll, created a crossover style by blending R&B with a country and western vocal delivery.",
            "Berry's lyrics focused on teen culture (cars, school, romance), making them relatable to both black and white audiences.",
            "His guitar style and 'duck walk' stage move became iconic and influenced generations of musicians."
        ],
        "full": "While artists like Ray Charles were stitching gospel and R&B together, others like Chuck Berry were taking gestures from jump blues, adding electrified instruments, and borrowing from country and western. This led to a new style of R&B that would soon be called rock and roll. A <b>crossover</b> hit is a song that holds a prominent place on at least two of the three types of charts: pop, rhythm and blues, and country. Berry's music frequently crossed over, as his lyrics about teen life and vocal style influenced by country singers appealed to a wide audience. Other major crossover artists included Fats Domino and Little Richard.",
        "keywords": {
            "Crossover": "A song that holds a prominent place on at least two of the three types of charts: pop, rhythm and blues, and country."
        },
        "deep": [
            {
                "title": "Chuck Berry (1926-2017)",
                "image": "https://i.imgur.com/cMgydDS.jpeg",
                "altText": "A classic photo of Chuck Berry mid-performance, playing his electric guitar and doing his famous 'duck walk'.",
                "bullets": [
                    "The most important guitarist in early rock and roll.",
                    "His first hit, 'Maybellene' (1955), was a reworking of the country song 'Ida Red.'",
                    "Wrote lyrics about teen culture: cars, school, and relationships.",
                    "His song 'Johnny B. Goode' was included on the golden record aboard the Voyager spacecraft."
                ],
                "media": [
                    {"label": "Listen: 'Maybellene'", "href": "https://open.spotify.com/track/3SQhmctWreNM0X6Zkm2K5R?si=cad1544a67bf4f10"},
                    {"label": "Listen: 'Johnny B. Goode'", "href": "https://open.spotify.com/track/2QfiRTz5Yc8DdShCxG1tB2?si=6d4ad5d0c03d45e6"},
                    {"label": "Listen: 'Roll Over Beethoven'", "href": "https://open.spotify.com/track/6C7aTTCUWRK7dD379yUT3W?si=d2761b0cdcbd490d"}
                ]
            }
        ]
    },
    {
      "id": "9.06b",
      "title": "Interactive Activity: Build a Blues Verse",
      "headerImage": "https://i.imgur.com/4uodWhO.png",
      "bullets": [],
      "full": "",
      "deep": [],
      "buildaband": {
          "correct": [
              "Woke up this mornin', feelin' sad and blue.",
              "I said, I woke up this mornin', feelin' sad and blue.",
              "My baby left me, now I don't know what to do."
          ],
          "distractors": [
              "The sun is shining bright today.",
              "I think I'll go out for a walk.",
              "She said she'd call me yesterday."
          ],
          "bandAreaTitle": "Your Blues Verse",
          "poolTitle": "Lyrical Lines",
          "customDropzones": [
              {"title": "Line 1 (A)", "accepts": ["Woke up this mornin', feelin' sad and blue."]},
              {"title": "Line 2 (A - Repeat)", "accepts": ["I said, I woke up this mornin', feelin' sad and blue."]},
              {"title": "Line 3 (B - Rhyme/Response)", "accepts": ["My baby left me, now I don't know what to do."]}
          ]
      }
    },
    {
        "id": "9.07",
        "title": "9.07 Conclusion",
        "headerImage": "https://i.imgur.com/4uodWhO.png",
        "bullets": [
            "Gospel, doo-wop, and rhythm and blues were distinct but related genres of African American music popular in the 1940s and 50s.",
            "Initially marketed as 'race records,' this music began to cross over to white audiences via radio.",
            "This cultural crossover set the stage for the transformation of rhythm and blues into the new genre of rock and roll."
        ],
        "full": "Many different types of African American music were popular in the 1940s and 1950s, including gospel, doo-wop, and rhythm and blues. Although record labels kept this music confined first to the 'race' label and then to the 'rhythm and blues' label, white audiences eventually began hearing and consuming rhythm and blues. As we will see in the next lesson, rhythm and blues underwent a number of musical and racial changes as it was transformed into rock and roll.",
        "deep": [],
        "wordcloud": {
            "title": "Final Thoughts?",
            "prompt": "What one word describes the music from this chapter? Add it to our word cloud!"
        }
    }
  ];
  
  const QUIZ = [
    {
        "q": "Which of the following songs was NOT by Louis Jordan?",
        "choices": ["\"We Will Understand It Better By and By\"", "\"Let the Good Times Roll\"", "\"Is You Is, Or Is You Ain't Ma Baby?\"", "\"Saturday Night Fish Fry\""],
        "answer": 0
    },
    {
        "q": "How did Thomas Dorsey first promote his gospel music?",
        "choices": ["He and Mahalia Jackson would perform on a street corner.", "He asked Louis Jordan’s band to perform it.", "He recorded it with Atlantic Records.", "He asked a university choir to sing it."],
        "answer": 0
    },
    {
        "q": "Which of the following was typical for a doo-wop group?",
        "choices": ["The use of orchestral instruments", "Religious subject matter", "Racially integrated membership", "Four male singers"],
        "answer": 3
    },
    {
        "q": "Chuck Berry performed his famous _________ during his guitar solos.",
        "choices": ["\"boogie woogie\"", "\"duck walk\"", "\"turkey trot\"", "\"jump blues\""],
        "answer": 1
    },
    {
        "q": "All of the following were vocal harmony groups EXCEPT:",
        "choices": ["The Chords", "The Mills Brothers", "The Orioles", "The Fisk Jubilee Singers"],
        "answer": 3
    },
    {
        "q": "In 1949, what term did the Billboard charts use to replace 'race records'?",
        "choices": ["sepia records", "rhythm and blues", "rock and roll", "blues"],
        "answer": 1
    },
    {
        "q": "Which of the following songs includes vocables?",
        "choices": ["\"Sh'boom\"", "\"I Got a Woman\"", "“Is You Is, Or Is You Ain’t My Baby?”", "\"Precious Lord, Take My Hand\""],
        "answer": 0
    },
    {
        "q": "'Maybellene' is based on a country and western song.",
        "choices": ["True", "False"],
        "answer": 0
    },
    {
        "q": "Gospel music was influenced by the Holiness-Pentecostal movement.",
        "choices": ["True", "False"],
        "answer": 0
    },
    {
        "q": "New gospel songs during the 1940s and 1950s were often called 'Dorseys.'",
        "choices": ["True", "False"],
        "answer": 0
    }
  ];
  
  const EXTRA = {};

  // ==================================================================
  // --- APPLICATION LOGIC (It is best not to modify below this line) ---
  // ==================================================================

  // --- AUTHENTICATION & INITIALIZATION ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
        userId = user.uid;
        checkSessionState();
    } else {
        try {
            if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); }
            else { await signInAnonymously(auth); }
        } catch (error) { console.error("Firebase authentication failed:", error); }
    }
  });
  
  function initializeInteractiveFeatures(){
    if(!sessionId) return;
    sessionDataPath = `/artifacts/${appId}/public/data/sessions/${sessionId}`;
    setupNavigationListener();
    setupQuizBattleListener();
    setupPollListeners();
    setupWordCloudListener();
    setupQnaListener();
  }
  
  function showApp(){
      document.getElementById('session-overlay').classList.add('hidden');
      document.getElementById('name-entry-overlay').classList.add('hidden');
      document.getElementById('main-header').style.display = 'block';
      document.getElementById('main-content').style.display = 'block';
      document.getElementById('qna-fab').style.display = 'block';
  }

  // --- USER SESSION ---
   function initializeUserSession() {
    const startBtn = document.getElementById('start-session-btn');
    const joinBtn = document.getElementById('join-session-btn');
    
    startBtn.addEventListener('click', () => {
        const newSessionId = Math.floor(100000 + Math.random() * 900000).toString();
        const currentUrl = new URL(window.location.origin + window.location.pathname);
        currentUrl.searchParams.set('session', newSessionId);
        currentUrl.searchParams.set('presenter', 'true');
        window.location.href = currentUrl.href;
    });

    joinBtn.addEventListener('click', () => {
        const sessionInput = document.getElementById('session-input');
        const inputId = sessionInput.value.trim();
        if (inputId) {
            const currentUrl = new URL(window.location.origin + window.location.pathname);
            currentUrl.searchParams.set('session', inputId);
            window.location.href = currentUrl.href;
        }
    });

    const nameInput = document.getElementById('name-input');
    const joinNameBtn = document.getElementById('join-btn');
    const anonBtn = document.getElementById('join-anonymously');

    function joinWithName(name) {
        if (!name || !sessionId) return;
        userName = name;
        localStorage.setItem(`lesson_userName_${sessionId}`, name); // Generic key
        startApp();
    };

    joinNameBtn.addEventListener('click', () => { if (nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && nameInput.value.trim()) { joinWithName(nameInput.value.trim()); } });
    anonBtn.addEventListener('click', (e) => { e.preventDefault(); joinWithName(`Student${Math.floor(1000 + Math.random() * 9000)}`); });
  }
  
   function checkSessionState() {
    const sessionOverlay = document.getElementById('session-overlay');
    const nameOverlay = document.getElementById('name-entry-overlay');

    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('session');
    isPresenter = urlParams.get('presenter') === 'true';

    if (sessionId) {
        sessionOverlay.classList.add('hidden');
        document.getElementById('session-id-display').textContent = sessionId;
        
        const storedName = localStorage.getItem(`lesson_userName_${sessionId}`); // Generic key
        if (storedName) {
            userName = storedName;
            startApp();
        } else {
            nameOverlay.classList.remove('hidden');
        }
    } else {
        sessionOverlay.classList.remove('hidden');
    }
}

function startApp() {
    if (!userId || !sessionId || !userName) {
        console.error("Cannot start app, missing user, session, or name info", {userId, sessionId, userName});
        return;
    }
    
    render();

    document.getElementById('session-overlay').classList.add('hidden');
    document.getElementById('name-entry-overlay').classList.add('hidden');
    
    showApp();
    initializeInteractiveFeatures();
}

  // --- INTERACTIVE FEATURES ---
  function setupNavigationListener() {
    const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
    onSnapshot(stateRef, (docSnap) => {
        const slideState = docSnap.exists() ? docSnap.data() : { currentSlide: 0 };
        const newIndex = slideState.currentSlide ?? 0;
        show(newIndex);
    }, (error) => {
        console.error("[Listener Error] Navigation listener failed:", error);
    });
  }

  // Polls
  function setupPollListeners() {
    document.querySelectorAll('.poll').forEach(pollEl => {
        const pollId = pollEl.dataset.pollId;
        if (pollId) {
            const votesRef = collection(db, `${sessionDataPath}/polls/${pollId}/votes`);
            onSnapshot(query(votesRef), (snapshot) => {
                const votes = {}; let totalVotes = 0; let userVote = -1;
                snapshot.forEach(doc => {
                    const vote = doc.data().choice;
                    votes[vote] = (votes[vote] || 0) + 1;
                    totalVotes++;
                    if (doc.id === userId) userVote = vote;
                });
                renderPollResults(pollId, votes, totalVotes, userVote);
            });
        }
    });
  }

  function renderPollResults(pollId, votes, totalVotes, userVote) {
    const pollEl = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollEl) return;
    pollEl.querySelectorAll('.poll-option').forEach((optionEl, index) => {
        const voteCount = votes[index] || 0;
        const percentage = totalVotes > 0 ? (voteCount / totalVotes) * 100 : 0;
        optionEl.querySelector('.poll-bar').style.width = `${percentage}%`;
        optionEl.querySelector('.poll-percent').textContent = `${Math.round(percentage)}%`;
        const button = optionEl.querySelector('button');
        button.disabled = false;
        optionEl.classList.remove('voted-for');
        if (userVote !== -1) {
            button.disabled = true;
            if (index === userVote) optionEl.classList.add('voted-for');
        }
    });
  }

  async function submitPollVote(pollId, choiceIndex) {
      if (!userId) return;
      const voteRef = doc(db, `${sessionDataPath}/polls/${pollId}/votes/${userId}`);
      await setDoc(voteRef, { choice: choiceIndex });
  };
  
  // Word Cloud
  function setupWordCloudListener() {
    const wordsRef = collection(db, `${sessionDataPath}/wordcloud`);
    onSnapshot(query(wordsRef), (snapshot) => {
        const words = {};
        snapshot.forEach(doc => {
            const word = doc.data().text.toLowerCase().trim();
            words[word] = (words[word] || 0) + 1;
        });
        renderWordCloud(words);
    });
  }

  function renderWordCloud(words) {
    const display = document.getElementById('word-cloud-display');
    if (!display) return;
    display.innerHTML = '';
    const maxFreq = Math.max(...Object.values(words), 1);
    const sortedWords = Object.keys(words).sort((a,b) => words[b] - words[a]);
    sortedWords.forEach(word => {
        const freq = words[word];
        const span = document.createElement('span');
        span.textContent = word;
        const size = 1 + (freq / maxFreq) * 2;
        span.style.fontSize = `${size}em`;
        span.style.opacity = 0.6 + (freq / maxFreq) * 0.4;
        display.appendChild(span);
    });
  }

  async function submitWord() {
    const input = document.getElementById('word-cloud-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/wordcloud`), { text, author: userId });
        input.value = '';
    }
  };

  // Q&A
  function setupQnaListener() {
    const qnaRef = collection(db, `${sessionDataPath}/qna`);
    onSnapshot(query(qnaRef, orderBy("upvotes", "desc")), (snapshot) => {
        const questions = [];
        snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));
        renderQna(questions);
    });
  }

  function renderQna(questions) {
    const list = document.getElementById('qna-list');
    if (!list) return;
    list.innerHTML = questions.length ? '' : '<li>No questions yet. Be the first!</li>';
    questions.forEach(q => {
        const hasVoted = localUpvotes.has(q.id);
        const li = document.createElement('li');
        li.innerHTML = `
            <button class="upvote-btn ${hasVoted ? 'voted' : ''}" onclick="upvoteQuestion('${q.id}')" ${hasVoted ? 'disabled' : ''}>
                <span>▲</span>
                <span>${q.upvotes || 0}</span>
            </button>
            <div>
                <p>${q.text}</p>
                <small style="color:var(--muted)">asked by ${q.name || `...${q.author.slice(-4)}`}</small>
            </div>
        `;
        list.appendChild(li);
    });
  }
  
  async function submitQuestion() {
    const input = document.getElementById('qna-input');
    const text = input.value.trim();
    if (text && userId) {
        await addDoc(collection(db, `${sessionDataPath}/qna`), { text, author: userId, upvotes: 0, name: userName || 'Anonymous' });
        input.value = '';
    }
  };

  async function upvoteQuestion(questionId) {
    if (localUpvotes.has(questionId)) return;
    localUpvotes.add(questionId);
    const qRef = doc(db, `${sessionDataPath}/qna/${questionId}`);
    await updateDoc(qRef, { upvotes: increment(1) });
  };
  
  // Quiz Battle
  const BATTLE_QUIZ = QUIZ;
  let localAnswers = {}; 

  async function setupQuizBattleListener() {
    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    onSnapshot(battleStateRef, (docSnap) => {
      const state = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
      renderQuizState(state);
    });

    const scoresRef = collection(db, `${sessionDataPath}/scores`);
    onSnapshot(query(scoresRef), (snapshot) => {
      const scores = [];
      snapshot.forEach(doc => scores.push({ id: doc.id, ...doc.data() }));
      scores.sort((a, b) => (b.timePoints || 0) - (a.timePoints || 0) || (b.correctAnswers || 0) - (a.correctAnswers || 0));
      renderLeaderboard(scores);
    });
  }

  function renderLeaderboard(scores) {
      const list = document.getElementById('leaderboard-list');
      if (!list) return;
      list.innerHTML = scores.length ? '' : '<li>No scores yet!</li>';
      scores.forEach(player => {
          list.innerHTML += `<li><div><span class="player-name">${player.name || `Player ...${player.id.slice(-4)}`}</span><span class="correct-answers"> (${player.correctAnswers || 0}/${BATTLE_QUIZ.length})</span></div><span class="score">${player.timePoints || 0} pts</span></li>`;
      });
  }

  function renderQuizState(state) {
    const questionArea = document.getElementById('quiz-question-area'), controlsArea = document.getElementById('quiz-controls'), feedbackArea = document.getElementById('quiz-feedback'), timerArea = document.getElementById('quiz-timer');
    if (!questionArea || !controlsArea || !feedbackArea || !timerArea) return;
    clearInterval(timerInterval);
    clearTimeout(timerStartTimeout);

    if (state.status === 'waiting' || state.currentQuestion === -1) {
      questionArea.innerHTML = '<p>The quiz battle is about to begin!</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Start Quiz Battle</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to start the quiz...</i></p>`;
      }
    } else if (state.status === 'finished') {
      questionArea.innerHTML = '<h3>Quiz Battle Over!</h3><p>Check the final scores on the leaderboard.</p>';
      feedbackArea.innerHTML = ''; 
      timerArea.style.display = 'none';
      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Play Again?</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>The quiz has ended.</i></p>`;
      }
    } else { 
      timerArea.style.display = 'block';
      const qIndex = state.currentQuestion, question = BATTLE_QUIZ[qIndex];
      const media = question.media ? `<p class="media"><a href="${question.media}" target="_blank" rel="noopener">Open media</a></p>` : '';
      const choices = question.choices.map((opt, ci) => `<button id="choice-${ci}" class="choice-btn" onclick="submitQuizAnswer(${qIndex}, ${ci}, ${state.questionStartTime})">${opt}</button>`).join('');
      questionArea.innerHTML = `<div class="q"><h4>Q${qIndex + 1}. ${question.q}</h4>${media}<div class="choices">${choices}</div></div>`;
      feedbackArea.innerHTML = '';

      if (isPresenter) {
          controlsArea.innerHTML = `<button class="grade-btn" onclick="startOrAdvanceQuiz()">Next Question ▶</button>`;
      } else {
          controlsArea.innerHTML = `<p><i>Waiting for the presenter to advance to the next question...</i></p>`;
      }
      
      const startTime = state.questionStartTime;
      timerArea.textContent = 'Get Ready...';
      
      if(localAnswers[qIndex] === undefined) { 
        timerStartTimeout = setTimeout(() => {
            timerInterval = setInterval(() => {
                const elapsedSeconds = (new Date().getTime() - startTime) / 1000;
                if (elapsedSeconds >= 20) { // Total time: 5s grace + 15s scoring
                    timerArea.textContent = '0 points';
                    clearInterval(timerInterval);
                    if (localAnswers[qIndex] === undefined) {
                        document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                        const correctBtn = document.getElementById(`choice-${question.answer}`);
                        if (correctBtn) correctBtn.classList.add('correct');
                        if (feedbackArea) feedbackArea.textContent = "Time's up!";
                    }
                } else if (elapsedSeconds >= 5) { // Scoring period
                    const scoringSeconds = elapsedSeconds - 5;
                    const points = Math.round(1000 * (1 - (scoringSeconds / 15)));
                    timerArea.textContent = `${points} points`;
                }
            }, 100);
        }, 5000);
      } else {
        showAnswerFeedback(qIndex, localAnswers[qIndex]);
      }
    }
  }

  async function startOrAdvanceQuiz() {
    if (!isPresenter || !userId || !userName) return;

    const battleStateRef = doc(db, `${sessionDataPath}/quizState/battle`);
    const docSnap = await getDoc(battleStateRef);
    const currentState = docSnap.exists() ? docSnap.data() : { status: 'waiting', currentQuestion: -1 };
    let nextQuestion = currentState.currentQuestion + 1;

    if (currentState.status === 'finished' || currentState.status === 'waiting') {
        localAnswers = {};
        const scoresRef = doc(db, `${sessionDataPath}/scores/${userId}`);
        await setDoc(scoresRef, { correctAnswers: 0, timePoints: 0, name: userName || 'Anonymous' });
        nextQuestion = 0;
    }
    
    if (nextQuestion >= BATTLE_QUIZ.length) {
        await setDoc(battleStateRef, { status: 'finished', currentQuestion: -1 });
    } else {
        await setDoc(battleStateRef, { status: 'in_progress', currentQuestion: nextQuestion, questionStartTime: new Date().getTime() });
    }
  };

  async function submitQuizAnswer(qIndex, choiceIndex, questionStartTime) {
      if (localAnswers[qIndex] !== undefined) return;
      localAnswers[qIndex] = choiceIndex;
      clearInterval(timerInterval);
      clearTimeout(timerStartTimeout);

      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex;
      const scoreRef = doc(db, `${sessionDataPath}/scores/${userId}`);
      
      const elapsedSeconds = (new Date().getTime() - questionStartTime) / 1000;

      if (isCorrect) {
          let points = (elapsedSeconds >= 5 && elapsedSeconds < 20) ? Math.round(1000 * (1 - ((elapsedSeconds-5) / 15))) : 0;
          await setDoc(scoreRef, { correctAnswers: increment(1), timePoints: increment(points) }, { merge: true });
      } else {
          await setDoc(scoreRef, { timePoints: increment(-250) }, { merge: true });
      }
      showAnswerFeedback(qIndex, choiceIndex);
  };

  function showAnswerFeedback(qIndex, choiceIndex) {
      const question = BATTLE_QUIZ[qIndex], isCorrect = question.answer === choiceIndex, feedbackArea = document.getElementById('quiz-feedback');
      document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
      const chosenBtn = document.getElementById(`choice-${choiceIndex}`), correctBtn = document.getElementById(`choice-${question.answer}`);
      if (isCorrect) {
          chosenBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Correct!'; feedbackArea.style.color = 'var(--brand)'; }
      } else {
          chosenBtn.classList.add('incorrect');
          correctBtn.classList.add('correct');
          if (feedbackArea) { feedbackArea.textContent = 'Incorrect! -250 points'; feedbackArea.style.color = 'rgb(239, 71, 111)';}
      }
  }
  
  // --- RENDERING & DOM MANIPULATION ---
  function toggleProfile(elementId) {
    const el = document.getElementById(elementId);
    if (el) el.hidden = !el.hidden;
  }

  function deepListHTML(sectionIdx, deep){
    if(!deep || !deep.length) return '';
    const items = deep.map((d,di)=>{
      const contentId = `profile-content-${sectionIdx}-${di}`;
      
      const bulletsHTML = (d.bullets||[]).length > 0 ? `<h4>Key points</h4><ul>${(d.bullets||[]).map(b=>`<li>${b}</li>`).join('')}</ul>` : '';
      
      let mediaContent = (d.media||[]).map(m=> {
          if (m.href) {
              return `<li><a href="${m.href}" target="_blank" rel="noopener">${m.label}</a></li>`;
          }
          return '';
      }).join('');
      const mediaHTML = mediaContent ? `<h4>Media</h4><ul>${mediaContent}</ul>` : '';

      const fullTextHTML = d.fullText ? `<p>${d.fullText}</p>`: '';
      
      let fullContentHTML = '';
      if (d.image) {
          fullContentHTML = `
              <div style="text-align: left;">
                  <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-start; margin-bottom: 1rem;">
                      <div style="flex: 1 1 250px; min-width: 200px;">
                          <img alt="${d.altText || d.title}" src="${d.image}" style="width: 100%; height: auto; border-radius: .4rem;">
                      </div>
                      <div style="flex: 2 1 300px;">
                          ${bulletsHTML}
                          ${mediaHTML}
                      </div>
                  </div>
                  <div>
                      ${fullTextHTML}
                  </div>
              </div>`;
      } else {
          fullContentHTML = `<div style="text-align: left;">${bulletsHTML}${mediaHTML}${fullTextHTML}</div>`;
      }

      return `
        <li class="deep-item" style="flex-direction: column; gap: 0;">
          <button type="button" class="profile-btn" onclick="toggleProfile('${contentId}')">${d.title}</button>
          <div id="${contentId}" class="full" hidden style="max-width: 100%; box-sizing: border-box; padding: 1.2rem; background: #1a1d29; border-radius: 0 0 .55rem .55rem;">
            ${fullContentHTML}
          </div>
        </li>`;
    }).join('');
    return `<ul class="deep-list">${items}</ul>`;
  }
  
    function pollHTML(check, slideId) {
        if (!check) return '';
        const pollId = `poll-${slideId}`;
        const choices = check.choices.map((opt, ci) => `
            <div class="poll-option">
                <div class="poll-bar"></div>
                <span class="poll-percent">0%</span>
                <button onclick="submitPollVote('${pollId}', ${ci})">${opt}</button>
            </div>
        `).join('');

        const revealBtn = isPresenter ? `<button class="read-btn" style="margin-top:1rem;" onclick="revealPollAnswer('${pollId}', ${check.answer})">Reveal Answer</button>` : '';

        return `
            <div class="poll interactive-section" data-poll-id="${pollId}">
                <h3>Test Your Knowledge</h3>
                <p>${check.q}</p>
                <div class="choices">${choices}</div>
                ${revealBtn}
            </div>
        `;
    }

    function buildABandHTML(data, slideId) {
      if (!data) return '';
      const containerId = `dnd-container-${slideId}`;
  
      if (data.customDropzones && data.customDropzones.length > 0) {
          const instruments = [...data.correct, ...data.distractors].sort(() => Math.random() - 0.5);
          const instrumentHTML = instruments.map(inst => `<div class="instrument" draggable="true" data-instrument="${inst}">${inst}</div>`).join('');
          
          const dropzoneHTML = data.customDropzones.map(zone => 
              `<div class="band-area" data-accepts='${JSON.stringify(zone.accepts)}'><h4>${zone.title}</h4></div>`
          ).join('');
  
          return `
              <div id="${containerId}" class="interactive-section build-a-band-container">
                  <h3>${data.bandAreaTitle || 'Build a Band'}</h3>
                   <p>Drag each line from the pool on the left into the correct slot to build a blues verse.</p>
                  <div class="build-a-band">
                      <div class="instrument-pool" style="flex: 2;"><h4>${data.poolTitle || 'Items'}</h4>${instrumentHTML}</div>
                      <div style="flex: 3; display: flex; flex-direction: column; gap: 1rem;">${dropzoneHTML}</div>
                  </div>
              </div>
          `;
      }
      
      // Fallback for simple drag and drop
      const instruments = [...data.correct, ...data.distractors].sort(() => Math.random() - 0.5);
      const instrumentHTML = instruments.map(inst => `<div class="instrument" draggable="true" data-instrument="${inst}">${inst}</div>`).join('');
      return `
          <div id="${containerId}" class="interactive-section build-a-band-container">
              <h3>Interactive Activity</h3>
              <p>Drag the correct items into the group area.</p>
              <div class="build-a-band">
                  <div class="instrument-pool"><h4>Items</h4>${instrumentHTML}</div>
                  <div class="band-area" data-correct='${JSON.stringify(data.correct)}'><h4>Group Area</h4></div>
              </div>
          </div>
      `;
    }

  function wordCloudHTML(data) {
    if (!data) return '';
    const title = data.title || 'Final Thoughts?';
    const prompt = data.prompt || 'What one word describes this topic to you? Add it to our word cloud!';
    return `
        <div class="interactive-section word-cloud-container">
            <div class="word-cloud-input">
                <h3>${title}</h3>
                <p>${prompt}</p>
                <div class="content-input-container">
                    <input type="text" id="word-cloud-input" class="content-input" placeholder="e.g., Soulful, Rhythmic...">
                    <button class="add-content-btn" onclick="submitWord()">Submit</button>
                </div>
            </div>
            <div id="word-cloud-display" class="word-cloud-display"></div>
        </div>
    `;
  }

  function render(){
    const host = document.getElementById('slides');
    if (!host) return;
    host.innerHTML = ''; 
    const total = SLIDES.length + 1;

    SLIDES.forEach((s,idx)=>{
      const bullets = s.bullets.map(b=>`<li>${b}</li>`).join('');
      const deep = deepListHTML(idx, s.deep);
      const poll = pollHTML(s.poll, s.id);
      const buildaband = buildABandHTML(s.buildaband, s.id);
      const wordcloud = wordCloudHTML(s.wordcloud);
      const headerImage = s.headerImage ? `<img src="${s.headerImage}" alt="" style="width: 100%; border-radius: .4rem; margin-bottom: 1rem;" />` : '';
      const keywordsHTML = s.keywords ? `<ul class="keywords-list">${Object.entries(s.keywords).map(([term, def]) => `<li><b>${term}:</b> ${def}</li>`).join('')}</ul>` : '';
      
      let footerHTML = '';
      if (isPresenter) {
          const prevBtn = idx > 0 ? `<button class="nav-btn" onclick="go(${idx-1})">◀ Previous</button>` : '<span></span>';
          const nextBtn = (idx < SLIDES.length) ? `<button class="nav-btn" onclick="go(${idx+1})">Next ▶</button>` : '<span></span>';
          footerHTML = `<footer class="slide-nav">${prevBtn}<button class="home-btn" onclick="go(0)">Home</button>${nextBtn}</footer>`;
      }
      
      host.insertAdjacentHTML('beforeend', `
        <section class="slide" id="slide-${idx}" data-ix="${idx}" aria-labelledby="h-${s.id}">
          <header class="slide-head">
            <h2 id="h-${s.id}">${s.title}</h2>
            <div style="display: flex; align-items: center; gap: .5rem;">
              <div class="meter">Slide ${idx+1} of ${total}</div>
              <button class="read-aloud-btn" id="read-aloud-btn-${idx}" onclick="readSlideAloud(${idx})">🔊 Read Aloud</button>
            </div>
          </header>
          ${headerImage}
          <ul class="bullets">${bullets}</ul>
           <div class="slide-actions">
                ${s.full ? `<button class="read-btn" onclick="toggleFull(${idx})">Read Full Text</button>` : ''}
                ${s.keywords ? `<button class="read-btn" onclick="toggleKeywords(${idx})">Keywords</button>` : ''}
           </div>
          <article id="full-${idx}" class="full" hidden>${s.full}</article>
          <article id="keywords-${idx}" class="full" hidden>${keywordsHTML}</article>
          ${deep}
          ${poll}
          ${buildaband}
          ${wordcloud}
          ${footerHTML}
        </section>
      `);
    });

    const qIndex = SLIDES.length;
    let quizFooterHTML = '';
    if (isPresenter) {
        quizFooterHTML = `<footer class="slide-nav"><button class="nav-btn" onclick="go(${qIndex-1})">◀ Previous</button><button class="home-btn" onclick="go(0)">Home</button><span></span></footer>`;
    }

    host.insertAdjacentHTML('beforeend', `
      <section class="slide" id="slide-${qIndex}" data-ix="${qIndex}" aria-labelledby="h-quiz">
        <header class="slide-head"><h2 id="h-quiz">Lesson Quiz Battle</h2><div class="meter">Slide ${qIndex + 1} of ${qIndex + 1}</div></header>
        <div class="quiz-battle-container">
          <div class="quiz-main">
            <div id="quiz-timer">1000 points</div>
            <div id="quiz-question-area"><p>Loading Quiz Battle...</p></div>
            <div id="quiz-feedback"></div>
            <div id="quiz-controls"></div>
          </div>
          <div class="leaderboard">
            <h3>Leaderboard</h3>
            <ul id="leaderboard-list">
              <li>Loading...</li>
            </ul>
          </div>
        </div>
        ${quizFooterHTML}
      </section>
    `);
    setupDragAndDrop();
  }

  let lastFocused = null;
  function openProfile(sectionIdx, cardIdx){
    const d = SLIDES[sectionIdx].deep[cardIdx];
    const modal = document.getElementById('modal');
    const mBody = document.getElementById('m-body');
    const scrim = document.getElementById('scrim');
    const title = d.modalTitle || d.title;
    const baseBullets = (d.bullets||[]).map(b=>`<li>${b}</li>`).join('');
    const media = (d.media||[]).map(m=>`<li><a href="${m.href}" target="_blank" rel="noopener">${m.label}</a></li>`).join('');
    const extended = d.modalHTML || '';
    const extra = EXTRA[d.title] || [];
    const extraHTML = extra.length ? `<h4>Additional notes</h4><ul>${extra.map(x=>`<li>${x}</li>`).join('')}</ul>` : '';
    const summaryHTML = d.summary?`<p>${d.summary}</p>`:'';
    const bulletsHTML = baseBullets?`<h4>Key points</h4><ul>${baseBullets}</ul>`:'';
    const mediaHTML = media?`<h4>Media</h4><ul class="media">${media}</ul>`:'';
    document.getElementById('m-title').textContent = title;
    if (d.image) {
        mBody.className = 'modal-body split-layout';
        mBody.innerHTML = `<div class="modal-image-container"><img alt="${d.altText || d.title}" src="${d.image}"></div><div class="modal-text-container">${summaryHTML}${bulletsHTML}${extraHTML}${mediaHTML}${extended}</div>`;
    } else {
        mBody.className = 'modal-body';
        mBody.innerHTML = `${summaryHTML}${bulletsHTML}${extraHTML}${mediaHTML}${extended}`;
    }
    lastFocused = document.activeElement;
    document.body.classList.add('modal-open');
    scrim.classList.add('active');
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    document.getElementById('modalClose').focus();
  }
  function hideModal(){
    const modal = document.getElementById('modal');
    const scrim = document.getElementById('scrim');
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden','true');
    scrim.classList.remove('active');
    document.body.classList.remove('modal-open');
    if(lastFocused) lastFocused.focus();
  }
  
  function show(i){ 
    if(!slidesEls) slidesEls = document.getElementsByClassName('slide'); 
    if(i<0||i>=slidesEls.length) return; 
    Array.from(slidesEls).forEach(s=>s.style.display='none'); 
    slidesEls[i].style.display='block'; 
    ix=i; 
    window.scrollTo(0,0); 
  }

  async function go(i){ 
    if (!isPresenter) return;
    
    const totalSlides = SLIDES.length + 1;
    if (i < 0 || i >= totalSlides) return;
    
    try {
        const stateRef = doc(db, `${sessionDataPath}/sessionState/state`);
        await setDoc(stateRef, { currentSlide: i }, { merge: true });
    } catch (error) {
        console.error("[Firebase Write Error] Failed to update slide state:", error);
    }
  }

  function toggleFull(i){ 
    const el=document.getElementById('full-'+i); 
    if(el) {
        el.hidden=!el.hidden;
        const button = el.parentElement.querySelector('.slide-actions button:nth-child(1)');
        if(button) {
            button.textContent = el.hidden ? 'Read Full Text' : 'Hide Full Text';
        }
    }
  }

  function toggleKeywords(i){ 
    const el=document.getElementById('keywords-'+i); 
    if(el) {
        el.hidden=!el.hidden;
        const button = el.parentElement.querySelector('.slide-actions button:nth-child(2)');
        if(button) {
            button.textContent = el.hidden ? 'Keywords' : 'Hide Keywords';
        }
    }
  }
  
    function setupDragAndDrop() {
        document.querySelectorAll('.build-a-band-container').forEach(container => {
            const instruments = container.querySelectorAll('.instrument');
            const simpleDropzone = container.querySelector('.band-area[data-correct]');
            const customDropzones = container.querySelectorAll('.band-area[data-accepts]');
            const pool = container.querySelector('.instrument-pool');
            let draggedItem = null;

            instruments.forEach(inst => {
                inst.addEventListener('dragstart', e => {
                    draggedItem = e.target;
                    setTimeout(() => e.target.style.opacity = '0.5', 0);
                });
                inst.addEventListener('dragend', () => {
                   setTimeout(() => {
                        if (draggedItem) {
                           draggedItem.style.opacity = '1';
                           draggedItem = null;
                        }
                   }, 0);
                });
            });
            
            const allDropzones = simpleDropzone ? [simpleDropzone, pool] : [...customDropzones, pool];
            allDropzones.forEach(zone => {
                if (!zone) return;
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    if (!draggedItem) return;

                    const instrumentName = draggedItem.dataset.instrument;

                    if (zone.classList.contains('instrument-pool')) {
                        zone.appendChild(draggedItem);
                        draggedItem.classList.remove('correct', 'incorrect');
                        draggedItem.draggable = true;
                        return;
                    }

                    if (zone.dataset.correct) {
                        const correctInstruments = JSON.parse(zone.dataset.correct);
                        zone.appendChild(draggedItem);
                        draggedItem.classList.remove('incorrect');
                        draggedItem.classList.add(correctInstruments.includes(instrumentName) ? 'correct' : 'incorrect');
                    }
                    else if (zone.dataset.accepts) {
                        const acceptedTypes = JSON.parse(zone.dataset.accepts);
                        if (acceptedTypes.includes(instrumentName)) {
                            zone.appendChild(draggedItem);
                            draggedItem.classList.remove('incorrect');
                            draggedItem.classList.add('correct');
                            draggedItem.draggable = false;
                        }
                    }
                });
            });
        });
    }

  
  function toggleQnaPanel() {
    const nameOverlay = document.getElementById('name-entry-overlay');
    if(document.getElementById('session-overlay').classList.contains('hidden') && nameOverlay.classList.contains('hidden')){
      document.getElementById('qna-panel').classList.toggle('active');
      document.getElementById('scrim').classList.toggle('active');
    }
  }
  
  // --- ACCESSIBILITY & OTHER FUNCTIONS ---
  function toggleHighContrast() {
    document.body.classList.toggle('high-contrast-mode');
    const isHighContrast = document.body.classList.contains('high-contrast-mode');
    localStorage.setItem('highContrast', isHighContrast);
  }

  function readSlideAloud(slideIndex) {
    const btn = document.getElementById(`read-aloud-btn-${slideIndex}`);
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
      if(btn) btn.textContent = '🔊 Read Aloud';
      return;
    }

    const slideEl = document.getElementById(`slide-${slideIndex}`);
    if (!slideEl) return;

    let textToRead = [];
    const title = slideEl.querySelector('h2');
    if (title) textToRead.push(title.textContent);

    const bullets = slideEl.querySelectorAll('.bullets li');
    if (bullets.length > 0) {
      textToRead.push("Bullet points:");
      bullets.forEach(li => textToRead.push(li.textContent));
    }
    
    const fullText = slideEl.querySelector('article.full');
    if (fullText && !fullText.hidden) {
       textToRead.push("Full text:");
       textToRead.push(fullText.textContent);
    }
    
    const images = slideEl.querySelectorAll('img');
    if (images.length > 0) {
      images.forEach((img, index) => {
        if(img.alt) {
          textToRead.push(`Image ${index + 1} description: ${img.alt}`);
        }
      });
    }
    
    const fullSpeech = textToRead.join('. ');
    const utterance = new SpeechSynthesisUtterance(fullSpeech);
    
    utterance.onstart = () => {
        if(btn) btn.textContent = '■ Stop Reading';
    };
    
    utterance.onend = () => {
        if(btn) btn.textContent = '🔊 Read Aloud';
    };

    speechSynthesis.speak(utterance);
  }

  function revealPollAnswer(pollId, correctIndex) {
    const pollEl = document.querySelector(`[data-poll-id="${pollId}"]`);
    if (!pollEl) return;
    const correctOption = pollEl.querySelectorAll('.poll-option')[correctIndex];
    if(correctOption) {
        correctOption.classList.add('correct-answer');
    }
  }

  // --- GLOBAL EVENT LISTENERS ---
  document.getElementById('modalClose').addEventListener('click', hideModal);
  document.getElementById('contrast-toggle-btn').addEventListener('click', toggleHighContrast);
  document.getElementById('scrim').addEventListener('click', ()=>{
      hideModal();
      if(document.getElementById('qna-panel').classList.contains('active')){
          toggleQnaPanel();
      }
  });
  document.addEventListener('keydown', (e)=>{ 
    if(e.key==='Escape') {
        hideModal();
        if(document.getElementById('qna-panel').classList.contains('active')){
          toggleQnaPanel();
        }
    }
    else if(e.key==='ArrowRight') go(ix+1); 
    else if(e.key==='ArrowLeft') go(ix-1); 
    else if(e.key==='Home') go(0); 
    else if(e.key==='End') go(document.getElementsByClassName('slide').length-1); 
  });

  document.addEventListener('DOMContentLoaded', ()=>{ 
    if (localStorage.getItem('highContrast') === 'true') {
      document.body.classList.add('high-contrast-mode');
    }
    initializeUserSession();
  });
  
  // --- WINDOW-SCOPED FUNCTIONS FOR HTML ---
  window.go = go;
  window.toggleFull = toggleFull;
  window.toggleKeywords = toggleKeywords;
  window.openProfile = openProfile;
  window.toggleProfile = toggleProfile;
  window.submitPollVote = submitPollVote;
  window.submitWord = submitWord;
  window.startOrAdvanceQuiz = startOrAdvanceQuiz;
  window.submitQuizAnswer = submitQuizAnswer;
  window.toggleQnaPanel = toggleQnaPanel;
  window.submitQuestion = submitQuestion;
  window.upvoteQuestion = upvoteQuestion;
  window.readSlideAloud = readSlideAloud;
  window.revealPollAnswer = revealPollAnswer;
  
</script>
</body>
</html>
